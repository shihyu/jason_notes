<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Perf - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/custom/custom.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html">Jason Notes</a></li><li class="chapter-item expanded "><a href="ubuntu/ubuntu_setup.html">Ubuntu</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ubuntu/command.html">Command</a></li><li class="chapter-item "><a href="ubuntu/gcp.html">GCP ssh</a></li><li class="chapter-item "><a href="ubuntu/wine.html">Wine</a></li></ol></li><li class="chapter-item expanded "><a href="android/android.html">Android</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="android/install_sdk.html">SDK install</a></li><li class="chapter-item "><a href="android/flutter.html">Flutter</a></li></ol></li><li class="chapter-item expanded "><a href="tools/tools.html">Tools</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="tools/asciinema.html">asciinema æŠŠçµ‚ç«¯æ“ä½œéŒ„è£½æˆ gif å‹•ç•«</a></li><li class="chapter-item "><a href="tools/finmind.html">Finmind</a></li><li class="chapter-item "><a href="tools/add-enter-and-exit-trace-for-your-function.html">addr2line</a></li><li class="chapter-item "><a href="tools/cmake.html">cmake</a></li><li class="chapter-item "><a href="tools/network.html">Network</a></li><li class="chapter-item "><a href="tools/python-pycryptodome-aes-symmetric-encryption-tutorial-examples.html">å¯¦ä½œ AES å°ç¨±å¼åŠ å¯†</a></li></ol></li><li class="chapter-item expanded "><a href="html/html.html">HTML</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="html/vue.html">Vue</a></li></ol></li><li class="chapter-item expanded "><a href="vim/vim.html">Vim</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="vim/copilot.html">copilot</a></li><li class="chapter-item "><a href="vim/tabnine.html">tabnine</a></li></ol></li><li class="chapter-item expanded "><a href="gdb/gdb.html">Gdb</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="gdb/å¸¸ç”¨æŒ‡ä»¤.html">å¸¸ç”¨æŒ‡ä»¤</a></li><li class="chapter-item "><a href="gdb/jemalloc.html">jemalloc</a></li><li class="chapter-item "><a href="gdb/graphs.html">graphs</a></li><li class="chapter-item "><a href="gdb/rust-gdb.html">rust gdb</a></li><li class="chapter-item "><a href="gdb/qemu-gdb-risc-v64.html">qemu-gdb-risc-v64-kernel</a></li><li class="chapter-item "><a href="gdb/go-rust-gdb-debug.html">ä½¿ç”¨gdb è¿½è¹¤go/rustç¨‹å¼ç¢¼</a></li><li class="chapter-item "><a href="gdb/gdb-function-trace-to-flowchart-guide.html">GDBå‡½æ•¸èª¿ç”¨è»Œè·¡åˆ†æèˆ‡æµç¨‹åœ–ç”Ÿæˆå®Œæ•´æŒ‡å—</a></li></ol></li><li class="chapter-item expanded "><a href="c++/cpp.html">C++</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="c++/benchmark.html">benchmark</a></li><li class="chapter-item "><a href="c++/ä¹˜ä»¥0.01å’Œé™¤ä»¥100å“ªå€‹å¿«.html">ä¹˜ä»¥ 0.01 å’Œé™¤ä»¥ 100 å“ªå€‹å¿«</a></li><li class="chapter-item "><a href="c++/smart_pointer.html">Smart pointer</a></li><li class="chapter-item "><a href="c++/l&rvalue.html">L&amp;R value</a></li><li class="chapter-item "><a href="c++/move.html">Move</a></li><li class="chapter-item "><a href="c++/CAS.html">CAS</a></li><li class="chapter-item "><a href="c++/HFT.html">HFT</a></li><li class="chapter-item "><a href="c++/cpp_note.html">Note</a></li><li class="chapter-item "><a href="c++/é«˜æ€§èƒ½ç¨‹å¼è¨­è¨ˆå¯¦æˆ°.html">é«˜æ€§èƒ½ç¨‹å¼è¨­è¨ˆå¯¦æˆ°</a></li><li class="chapter-item "><a href="c++/å¦‚ä½•é«˜æ•ˆåœ°å„²å­˜ä¸¦æ“ä½œè¶…å¤§è¦æ¨¡.html">å¦‚ä½•é«˜æ•ˆåœ°å„²å­˜ä¸¦æ“ä½œè¶…å¤§è¦æ¨¡</a></li><li class="chapter-item "><a href="c++/UC_CAPITAL.html">UC_CAPITAL</a></li><li class="chapter-item "><a href="c++/cpp-smart-pointers-guide.html">unique_ptr vs shared_ptr</a></li><li class="chapter-item "><a href="c++/cpp-move-semantics-guide.html">C++ Move èªæ„å®Œæ•´æŒ‡å—</a></li><li class="chapter-item "><a href="c++/interview.html">interview</a></li></ol></li><li class="chapter-item expanded "><a href="mojo/mojo.html">Mojo</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="mojo/mojo_crawler_guide.html">Mojo çˆ¬èŸ²å®Œæ•´æŒ‡å—</a></li></ol></li><li class="chapter-item expanded "><a href="riscv/riscv.html">RISC-V</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="riscv/qemu_riscv_linux.html">QEMUä¸Šé‹è¡ŒRISV-V Linux</a></li><li class="chapter-item "><a href="riscv/qemi_gdb.html">QEMU GDB</a></li><li class="chapter-item "><a href="riscv/qemu_gdb_lab.html">Qemu Gdb Lab</a></li></ol></li><li class="chapter-item expanded "><a href="centos/centos.html">CentOS</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="centos/tqdb_setup.html">TQDB å®‰è£ç´€éŒ„</a></li></ol></li><li class="chapter-item expanded "><a href="ssh/ssh.html">SSH</a></li><li class="chapter-item expanded "><a href="network/socket.html">Network</a></li><li class="chapter-item expanded "><a href="docker/docker_helloworld.html">Docker</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="docker/docker.html">Docker åŸºæœ¬æ•™å­¸</a></li><li class="chapter-item "><a href="docker/example.html">ç°¡å–®ç¯„ä¾‹</a></li><li class="chapter-item "><a href="docker/creating-the-perfect-python-dockerfile.html">Perfect python dockerfile</a></li><li class="chapter-item "><a href="docker/dockerfile-from-docker-image.html">ç”± Docker image åæ¨å…¶ Dockerfile</a></li><li class="chapter-item "><a href="docker/python_connect_redis.html">Pythoné€£æ¥Redis</a></li><li class="chapter-item "><a href="docker/command.html">Command</a></li><li class="chapter-item "><a href="docker/docker_compose.html">Docker compose</a></li><li class="chapter-item "><a href="docker/docker_compse_example.html">Docker compose example</a></li><li class="chapter-item "><a href="docker/python_redis.html">Python-Redis</a></li><li class="chapter-item "><a href="docker/redash.html">Redash</a></li><li class="chapter-item "><a href="docker/clickhouse.html">ClickHouse</a></li><li class="chapter-item "><a href="docker/clickhouse-setup.html">clickhouse-setup</a></li><li class="chapter-item "><a href="docker/python_run_from_local.html">Docker run local</a></li><li class="chapter-item "><a href="docker/redpanda.html">Redpanda</a></li><li class="chapter-item "><a href="docker/gcc.html">é‹è¡Œæœ€æ–°ç‰ˆGCC</a></li></ol></li><li class="chapter-item expanded "><a href="rust/rust.html">Rust</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust/note.html">Rustç­†è¨˜</a></li><li class="chapter-item "><a href="rust/basic.html">Rust åŸºæœ¬æ•™å­¸</a></li><li class="chapter-item "><a href="rust/ownership.html">Rust æ‰€æœ‰æ¬Šç³»çµ±</a></li><li class="chapter-item "><a href="rust/lifetime.html">Rust ç”Ÿå‘½é€±æœŸ (Lifetime)</a></li><li class="chapter-item "><a href="rust/type.html">Rust å‹åˆ¥ç³»çµ±</a></li><li class="chapter-item "><a href="rust/rust_setup.html">Rust Tools</a></li><li class="chapter-item "><a href="rust/polars.html">Polars</a></li><li class="chapter-item "><a href="rust/rust_call_c.html">Rust call C</a></li><li class="chapter-item "><a href="rust/pyo3.html">PyO3</a></li><li class="chapter-item "><a href="rust/10-rust-an-introduction.html">çµ¦ C++ ä½¿ç”¨è€…çš„ Rust ç°¡ä»‹</a></li><li class="chapter-item "><a href="rust/å¯è¦–åŒ–Rustå„è³‡æ–™çµæ§‹çš„è¨˜æ†¶é«”ä½ˆå±€.html">å¯è¦–åŒ–Rustå„è³‡æ–™çµæ§‹çš„è¨˜æ†¶é«”ä½ˆå±€</a></li><li class="chapter-item "><a href="rust/rust_note.html">å­¸ç¿’é †åº</a></li><li class="chapter-item "><a href="rust/overview.html">å¤§å±€è§€</a></li><li class="chapter-item "><a href="rust/String.html">ç†è§£å­—ä¸²</a></li><li class="chapter-item "><a href="rust/easy_rust.html">Easy Rust</a></li><li class="chapter-item "><a href="rust/rust_easy.html">Rust æ–°æ‰‹</a></li><li class="chapter-item "><a href="rust/module.html">Rust æ¨¡çµ„çµæ§‹</a></li><li class="chapter-item "><a href="rust/rust_memory.html">Rustèˆ‡è¨˜æ†¶é«”</a></li><li class="chapter-item "><a href="rust/rust_vs_cpp.html">Rust vs C++èªæ³•</a></li><li class="chapter-item "><a href="rust/rust_file_format.html">Rust æª”æ¡ˆæ ¼å¼</a></li><li class="chapter-item "><a href="rust/rust-an-introduction-in-oop.html">Rust OO</a></li><li class="chapter-item "><a href="rust/rust-an-introduction-smart-pointer.html">Rust Pointer</a></li><li class="chapter-item "><a href="rust/pointer.html">Pointer</a></li><li class="chapter-item "><a href="rust/copy_trait.html">Copy Trait</a></li><li class="chapter-item "><a href="rust/binary_lib.html">Rust å‡½æ•¸åº«/åŸ·è¡Œæª”</a></li><li class="chapter-item "><a href="rust/reqwest.html">Reqwest</a></li><li class="chapter-item "><a href="rust/print-function-name-dump-stack.html">å°å‡ºå‡½æ•¸åç¨±</a></li><li class="chapter-item "><a href="rust/criterion.html">criterion</a></li><li class="chapter-item "><a href="rust/Rustçš„ç²¾é«“.html">Rustçš„ç²¾é«“</a></li><li class="chapter-item "><a href="rust/30å¤©æ·±å…¥æ·ºå‡ºRustç³»åˆ—.html">30å¤©æ·±å…¥æ·ºå‡ºRustç³»åˆ—</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust/30å¤©æ·±å…¥æ·ºå‡ºRustç³»åˆ—/rust_30_day.html">Rust 30 Day</a></li><li class="chapter-item "><a href="rust/30å¤©æ·±å…¥æ·ºå‡ºRustç³»åˆ—/Move_Borrow_Ownership.html">è®Šæ•¸çš„æ‰€æœ‰æ¬Šèˆ‡å€Ÿå‡ºè®Šæ•¸</a></li><li class="chapter-item "><a href="rust/30å¤©æ·±å…¥æ·ºå‡ºRustç³»åˆ—/Lifetime.html">Lifetimeï¼š Borrow çš„å­˜æ´»æ™‚é–“</a></li></ol></li><li class="chapter-item "><a href="rust/cpp_vs_rust_comparison.html">C++ vs. Rust: å…¨é¢ç‰¹æ€§æ¯”è¼ƒ</a></li><li class="chapter-item "><a href="rust/cpp-move-vs-rust-ownership.html">C++ Move èªç¾© vs Rust æ‰€æœ‰æ¬Šç³»çµ±çš„æ ¸å¿ƒå·®ç•°</a></li><li class="chapter-item "><a href="rust/Rust-RESTful-API-å®Œæ•´é–‹ç™¼æŒ‡å—.html">Rust-RESTful-API-å®Œæ•´é–‹ç™¼æŒ‡å—</a></li><li class="chapter-item "><a href="rust/Rust-self-Self-èˆ‡-C++-this-å°æ¯”æŒ‡å—.html">Rust-self-Self-èˆ‡-C++-this-å°æ¯”æŒ‡å—</a></li><li class="chapter-item "><a href="rust/rust-derive-traits-comparison.html">Rust Derive Traits æ¯”è¼ƒï¼šè‡ªå‹•ç”Ÿæˆ vs æ‰‹å‹•å¯¦ä½œ</a></li><li class="chapter-item "><a href="rust/rust_traits_explained.html">Rust Traits ç™½è©±è§£é‡‹ï¼šèˆ‡ C++ çš„æ¯”è¼ƒ</a></li><li class="chapter-item "><a href="rust/rust_trait_impl_markdown.html">Rust ä¸­ trait å’Œ impl çš„å·®ç•°</a></li><li class="chapter-item "><a href="rust/rust_cpp_comparison_md.html">Rust vs C++ è©³ç´°å°æ¯”æŒ‡å—</a></li><li class="chapter-item "><a href="rust/rust_module_system_markdown.html">Rust æ¨¡çµ„ç³»çµ±å®Œæ•´æŒ‡å—</a></li><li class="chapter-item "><a href="rust/ownership_vs_borrowing_guide.html">Rust æ“æœ‰æ¬Š vs å€Ÿç”¨ï¼šç”Ÿå‘½é€±æœŸå•é¡ŒæŒ‡å—ğŸ¦€</a></li><li class="chapter-item "><a href="rust/rust_ownership_guide.html">Rust æ‰€æœ‰æ¬Šç³»çµ± - ç”Ÿæ´»åŒ–è©³è§£</a></li><li class="chapter-item "><a href="rust/rust_ownership_complete_guide.html">Rust æ‰€æœ‰æ¬Šå®Œæ•´æŒ‡å— - å¾åŸºç¤åˆ°ç²¾é€š</a></li><li class="chapter-item "><a href="rust/rust_memory_guide.html">Rust è¨˜æ†¶é«”é…ç½®æŒ‡å—ï¼šStack vs Heap</a></li><li class="chapter-item "><a href="rust/rust_wrappers_guide.html">Rust åŒ…è£é¡å‹ç™½è©±æŒ‡å—ğŸ“¦</a></li></ol></li><li class="chapter-item expanded "><a href="go/go.html">Go</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="go/note.html">Golang  Note</a></li><li class="chapter-item "><a href="go/pytago.html">pytago</a></li><li class="chapter-item "><a href="go/Goç·¨ç¨‹å¯¦æˆ°æ´¾åŸºç¤å…¥é–€.html">Goç·¨ç¨‹å¯¦æˆ°æ´¾åŸºç¤å…¥é–€</a></li><li class="chapter-item "><a href="go/Goç·¨ç¨‹å¯¦æˆ°æ´¾Webé–‹ç™¼åŸºç¤.html">Goç·¨ç¨‹å¯¦æˆ°æ´¾Webé–‹ç™¼åŸºç¤</a></li><li class="chapter-item "><a href="go/golang_debugger.html">Golang Deubgger</a></li><li class="chapter-item "><a href="go/golang-go-module-tutorial.html">å¾ä¸€çŸ¥åŠè§£åˆ°ç•¥æ‡‚ Go modules</a></li><li class="chapter-item "><a href="go/go_mod.html">Go modules</a></li><li class="chapter-item "><a href="go/trace.html">Golangå¤§æ®ºå™¨ä¹‹è·Ÿè¹¤å‰–ætrace</a></li><li class="chapter-item "><a href="go/Coroutine.html">è¡Œç¨‹ã€åŸ·è¡Œç·’ã€å”ç¨‹ï¼Œå‚»å‚»åˆ†å¾—æ¸…æ¥šï¼</a></li><li class="chapter-item "><a href="go/goroutine-and-channel.html">Goä½µç™¼</a></li><li class="chapter-item "><a href="go/websocket.html">Websocket</a></li><li class="chapter-item "><a href="go/returning-pointer-from-a-function-in-go.html">Returning Pointer from a Function in Go</a></li><li class="chapter-item "><a href="go/golang-memory-management.html">GC å…¨é¢è§£æ</a></li><li class="chapter-item "><a href="go/golang-goroutine.html">Goroutine èˆ‡ GMP åŸç†å…¨é¢åˆ†æ</a></li><li class="chapter-item "><a href="go/oo.html">OO</a></li><li class="chapter-item "><a href="go/mutex-rwmutex.html">sync.Mutex å’Œ sync.RWMutex</a></li><li class="chapter-item "><a href="go/interface.html">interface</a></li><li class="chapter-item "><a href="go/example.html">Example</a></li><li class="chapter-item "><a href="go/LiveKit.html">LiveKit</a></li></ol></li><li class="chapter-item expanded "><a href="ml/ml.html">ML</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ml/pytorch.html">Pytorch</a></li><li class="chapter-item "><a href="ml/pytorch_setup.html">Pytorch å®‰è£</a></li><li class="chapter-item "><a href="ml/deap.html">Deap</a></li><li class="chapter-item "><a href="ml/cudf.html">CUDF</a></li><li class="chapter-item "><a href="ml/åˆæ¢åŸºå› æ¼”ç®—æ³•.html">åˆæ¢åŸºå› æ¼”ç®—æ³•-ç”¨ OneMax å•é¡Œç¤ºç¯„</a></li><li class="chapter-item "><a href="ml/ç°¡å–®è§£é‡‹æ¢¯åº¦ä¸‹é™æ³•.html">ç°¡å–®è§£é‡‹æ¢¯åº¦ä¸‹é™æ³•</a></li><li class="chapter-item "><a href="ml/æ¢¯åº¦ä¸‹é™æ³•_gradient_descent.html">æ¢¯åº¦ä¸‹é™æ³• gradient descent</a></li><li class="chapter-item "><a href="ml/æ¢¯åº¦æœ€ä½³è§£ç›¸é—œç®—æ³•.html">æ¢¯åº¦æœ€ä½³è§£ç›¸é—œç®—æ³•</a></li><li class="chapter-item "><a href="ml/åŸºæ–¼DEAPåº«çš„Pythoné€²åŒ–æ¼”ç®—æ³•å¾å…¥é–€åˆ°å…¥åœŸ.html">åŸºæ–¼DEAPåº«çš„Pythoné€²åŒ–æ¼”ç®—æ³•å¾å…¥é–€åˆ°å…¥åœŸ</a></li><li class="chapter-item "><a href="ml/GA.html">GA</a></li><li class="chapter-item "><a href="ml/XGBoost.html">XGBoost</a></li><li class="chapter-item "><a href="ml/YOLO.html">YOLO</a></li><li class="chapter-item "><a href="ml/yolov8æ‰‹å‹¢è­˜åˆ¥.html">YOLOv8æ‰‹å‹¢è­˜åˆ¥</a></li><li class="chapter-item "><a href="ml/Roboflow.html">Roboflow</a></li></ol></li><li class="chapter-item expanded "><a href="python/python.html">Python</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="python/Poetryå®Œå…¨å…¥é–€æŒ‡å—.html">Poetryå®Œå…¨å…¥é–€æŒ‡å—</a></li><li class="chapter-item "><a href="python/æ­å»ºgRPCæœå‹™.html">æ­å»ºgRPCæœå‹™</a></li><li class="chapter-item "><a href="python/python_debugger.html">Python Debugger</a></li><li class="chapter-item "><a href="python/decorator.html">Python decorator</a></li><li class="chapter-item "><a href="python/python-decorator.html">è£é£¾å™¨çœ‹é€™ä¸€ç¯‡å°±å¤ äº†</a></li><li class="chapter-item "><a href="python/import-concept.html">import-concept</a></li><li class="chapter-item "><a href="python/process_thread.html">Process/Threadå„ªç¼ºé»</a></li><li class="chapter-item "><a href="python/processing_communcation.html">Processing é€šè¨Š</a></li><li class="chapter-item "><a href="python/condition.html">Pythonä¸­çš„waitå’Œnotify</a></li><li class="chapter-item "><a href="python/ç”Ÿç”¢è€…æ¶ˆè²»è€…æ¨¡å¼.html">ç”Ÿç”¢è€…æ¶ˆè²»è€…æ¨¡å¼</a></li><li class="chapter-item "><a href="python/Loguru.html">Loguru</a></li><li class="chapter-item "><a href="python/cython.html">Cython</a></li><li class="chapter-item "><a href="python/WebSocket_reconnect.html">Python WebSocketé•·é€£æ¥å¿ƒè·³èˆ‡çŸ­é€£æ¥</a></li><li class="chapter-item "><a href="python/bloomrpc.html">bloomrpc</a></li><li class="chapter-item "><a href="python/concurrent.futures.html">Concurrent futures</a></li><li class="chapter-item "><a href="python/schedule.html">ä»»å‹™èª¿åº¦</a></li><li class="chapter-item "><a href="python/plot/plot.html">Plot</a></li><li class="chapter-item "><a href="python/plot/dash.html">Dash</a></li><li class="chapter-item "><a href="python/Rust_bindings_for_Python.html">Rust bindings for Python</a></li><li class="chapter-item "><a href="python/pandas.html">Pandas</a></li><li class="chapter-item "><a href="python/coroutine.html">Coroutine</a></li><li class="chapter-item "><a href="python/finmind.html">FinMind</a></li><li class="chapter-item "><a href="python/telegram_bot.html">Telegram Bot</a></li><li class="chapter-item "><a href="python/python-different-ways-to-kill-a-thread.html">Different ways kill thread</a></li><li class="chapter-item "><a href="python/websocket_client_server.html">Websocket client/server</a></li><li class="chapter-item "><a href="python/poetry.html">å¾é›¶é–‹å§‹ä½¿ç”¨ Poetry</a></li><li class="chapter-item "><a href="python/fil-memory-usage-profiler.html">Fil-memory-usage-profiler</a></li><li class="chapter-item "><a href="python/plot.html">ç¹ªåœ–</a></li><li class="chapter-item "><a href="python/shioaji.html">æ°¸è±shioaji</a></li><li class="chapter-item "><a href="python/other.html">Other</a></li></ol></li><li class="chapter-item expanded "><a href="mermaid/mermaid.html">Mermaid</a></li><li class="chapter-item expanded "><a href="linux_system/linux_system.html">Linux System</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="linux_system/1_day_socket.html">Socket</a></li><li class="chapter-item "><a href="linux_system/cgroup.html">Cgroup</a></li><li class="chapter-item "><a href="linux_system/perf.html">Perf</a></li><li class="chapter-item "><a href="linux_system/è‡ªè£½Lib.html">build Lib</a></li><li class="chapter-item "><a href="linux_system/performance.html">performance</a></li></ol></li><li class="chapter-item expanded "><a href="strategy/bollmaker.html">Strategy</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/é€ å¸‚/market_market.html">é€ å¸‚</a></li><li class="chapter-item "><a href="strategy/tw_futures.html">è‡ºæŒ‡</a></li><li class="chapter-item "><a href="strategy/arbitrage.html">å¥—åˆ©</a></li><li class="chapter-item "><a href="strategy/é…å°äº¤æ˜“.html">é…å°äº¤æ˜“</a></li><li class="chapter-item "><a href="strategy/æµ·é¾œäº¤æ˜“.html">æµ·é¾œäº¤æ˜“</a></li><li class="chapter-item "><a href="strategy/è‚¡æµ·ç­‹è‚‰äºº.html">è‚¡æµ·ç­‹è‚‰äºº</a></li><li class="chapter-item "><a href="strategy/å¦‚ä½•é¿å…éæ“¬åˆ.html">å¦‚ä½•é¿å…éæ“¬åˆ</a></li><li class="chapter-item "><a href="strategy/å¤šç©ºæ“ä½œè¡“.html">å¤šç©ºæ“ä½œè¡“</a></li><li class="chapter-item "><a href="strategy/è³‡é‡‘æ§ç®¡æ‰æ˜¯ç‹é“.html">è³‡é‡‘æ§ç®¡æ‰æ˜¯ç‹é“</a></li><li class="chapter-item "><a href="strategy/00713_00675Læ­£äºŒèœˆèš£ç­–ç•¥.html">æ­£äºŒèœˆèš£ç­–ç•¥</a></li><li class="chapter-item "><a href="strategy/è³ªæŠ¼00713+æ­£äºŒ.html">è³ªæŠ¼00713+æ­£äºŒ</a></li><li class="chapter-item "><a href="strategy/phcebus/phcebus.html">phcebus</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/phcebus/è²å¼æ€è€ƒ.html">è²å¼æ€è€ƒ</a></li><li class="chapter-item "><a href="strategy/phcebus/è²·è‚¡3å¿ƒæ³•.html">è²·è‚¡3å¿ƒæ³•</a></li></ol></li><li class="chapter-item "><a href="strategy/Option/option.html">é¸æ“‡æ¬Š</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/Option/option_note.html">Option note</a></li></ol></li><li class="chapter-item "><a href="strategy/vectorbt.html">VectorBT</a></li><li class="chapter-item "><a href="strategy/orderbook.html">Orderbook</a></li><li class="chapter-item "><a href="strategy/é¸è‚¡æ¢ä»¶.html">é¸è‚¡æ¢ä»¶</a></li><li class="chapter-item "><a href="strategy/å¦‚ä½•é€²å ´.html">å¦‚ä½•é€²å ´</a></li><li class="chapter-item "><a href="strategy/å¦‚ä½•å‡ºå ´.html">å¦‚ä½•å‡ºå ´</a></li><li class="chapter-item "><a href="strategy/å»ºå€‰åŠ ç¢¼.html">å»ºå€‰åŠ ç¢¼</a></li><li class="chapter-item "><a href="strategy/DT.html">ç•¶æ²–</a></li><li class="chapter-item "><a href="strategy/ç•¶æ²–åšç©º.html">ç•¶æ²–åšç©º</a></li><li class="chapter-item "><a href="strategy/æŠ„åº•.html">æŠ„åº•</a></li><li class="chapter-item "><a href="strategy/éº»é“æ˜/éº»é“æ˜.html">éº»é“æ˜</a></li><li class="chapter-item "><a href="strategy/è³ºè´å¤§ç›¤çš„å‹•èƒ½æŠ•è³‡æ³•.html">è³ºè´å¤§ç›¤çš„å‹•èƒ½æŠ•è³‡æ³•</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/éº»é“æ˜/å‡çªç ´.html">å‡çªç ´</a></li></ol></li><li class="chapter-item "><a href="strategy/å¥‡æ­£/å¥‡æ­£.html">å¥‡æ­£</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/å¥‡æ­£/è³‡é‡‘æ§ç®¡èˆ‡è©¦å–®ç­–ç•¥.html">è³‡é‡‘æ§ç®¡èˆ‡è©¦å–®ç­–ç•¥</a></li><li class="chapter-item "><a href="strategy/å¥‡æ­£/å¦‚ä½•å‡ºå ´.html">å¦‚ä½•å‡ºå ´</a></li></ol></li><li class="chapter-item "><a href="strategy/ptt_stock/a0808996.html">PTT Stock</a></li><li class="chapter-item "><a href="strategy/Book/JG.html">JG</a></li><li class="chapter-item "><a href="strategy/bnf.html">BNF</a></li><li class="chapter-item "><a href="strategy/cis.html">CIS</a></li><li class="chapter-item "><a href="strategy/GA.html">GA</a></li><li class="chapter-item "><a href="strategy/stock.html">Stock</a></li><li class="chapter-item "><a href="strategy/note.html">Resource</a></li><li class="chapter-item "><a href="strategy/nansen.html">Nansen</a></li><li class="chapter-item "><a href="strategy/example.html">Example</a></li><li class="chapter-item "><a href="strategy/other.html">Other</a></li><li class="chapter-item "><a href="strategy/sample.html">Sample</a></li><li class="chapter-item "><a href="strategy/shioaji.html">shioaji æ¨¡æ“¬</a></li><li class="chapter-item "><a href="strategy/grid.html">Grid</a></li><li class="chapter-item "><a href="strategy/pine-script.html">pine-script</a></li><li class="chapter-item "><a href="strategy/æ‹¾äººç‰™æ…§.html">æ‹¾äººç‰™æ…§</a></li><li class="chapter-item "><a href="strategy/sharpe_ratio.html">å¤æ™®å€¼</a></li><li class="chapter-item "><a href="strategy/display_mae_mfe_analysis.html">MAE&amp;MFEåˆ†æ</a></li><li class="chapter-item "><a href="strategy/æµ·é¾œæŠ•è³‡æ³•å‰‡.html">æµ·é¾œæŠ•è³‡æ³•å‰‡</a></li><li class="chapter-item "><a href="strategy/edge-ratio-follow-application.html">å½ˆæ€§é€²å‡ºå ´çš„åˆ¤æ–·</a></li><li class="chapter-item "><a href="strategy/ä¸‰å¿ƒæ³•é †å‹¢æ“ä½œé™³æ—å…ƒ10å¹´è³‡ç”¢ç¿»10å€.html">ä¸‰å¿ƒæ³•é †å‹¢æ“ä½œé™³æ—å…ƒ10å¹´è³‡ç”¢ç¿»10å€</a></li><li class="chapter-item "><a href="strategy/Jump.html">JUMP</a></li><li class="chapter-item "><a href="strategy/å¼µæ¾å…æŠ•è³‡å¿ƒæ³•.html">å¼µå…æŠ•è³‡å¿ƒæ³•</a></li><li class="chapter-item "><a href="strategy/vectorbt_é…å°.html">vectorbt é…å°</a></li><li class="chapter-item "><a href="strategy/äº¤æ˜“çš„è¡Œç‚ºèˆ‡æ€ç¶­åˆ†äº«.html">äº¤æ˜“çš„è¡Œç‚ºèˆ‡æ€ç¶­åˆ†äº«</a></li><li class="chapter-item "><a href="strategy/æŠ•è³‡æŠ•æ©Ÿçš„è§€å¿µèˆ‡å¿ƒå¾—åˆ†äº«.html">æŠ•è³‡æŠ•æ©Ÿçš„è§€å¿µèˆ‡å¿ƒå¾—åˆ†äº«</a></li><li class="chapter-item "><a href="strategy/finlab.html">Finlab</a></li><li class="chapter-item "><a href="strategy/backtrader/basis.html">Backtrader</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶ä¸€Backtraderä»‹ç´¹.html">Pythonå›æ¸¬æ¡†æ¶ä¸€Backtraderä»‹ç´¹</a></li><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶äºŒå®šæœŸå®šé¡æŠ•è³‡.html">Python å›æ¸¬æ¡†æ¶ï¼ˆäºŒï¼‰å®šæœŸå®šé¡æŠ•è³‡</a></li><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶ä¸‰æŠ€è¡“æŒ‡æ¨™.html">Python å›æ¸¬æ¡†æ¶ï¼ˆä¸‰ï¼‰æŠ€è¡“æŒ‡æ¨™</a></li><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶å››CrossOverå’ŒSignal.html">Python å›æ¸¬æ¡†æ¶ï¼ˆå››ï¼‰CrossOver å’Œ Signal</a></li><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶äº”Sizer.html">Python å›æ¸¬æ¡†æ¶ï¼ˆäº”ï¼‰Sizer</a></li><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶å…­Analyzers.html">Python å›æ¸¬æ¡†æ¶ï¼ˆå…­ï¼‰Analyzers</a></li><li class="chapter-item "><a href="strategy/backtrader/å¤šè‚¡çµ„åˆæ“ä½œç­–ç•¥.html">å¤šè‚¡çµ„åˆæ“ä½œ</a></li><li class="chapter-item "><a href="strategy/backtrader/å‡ç·šäº¤å‰ç­–ç•¥.html">å‡ç·šäº¤å‰ç­–ç•¥</a></li><li class="chapter-item "><a href="strategy/backtrader/å”å¥‡å®‰é€šé“ç­–ç•¥.html">å”å¥‡å®‰é€šé“ç­–ç•¥</a></li><li class="chapter-item "><a href="strategy/backtrader/Sizersæ¨¡çµ„.html">Sizersæ¨¡çµ„</a></li><li class="chapter-item "><a href="strategy/backtrader/Observersæ¨¡çµ„.html">Observersæ¨¡çµ„</a></li><li class="chapter-item "><a href="strategy/backtrader/Pyfolio.html">Pyfolio</a></li><li class="chapter-item "><a href="strategy/backtrader/Sample.html">Sample</a></li><li class="chapter-item "><a href="strategy/backtrader/performance.html">Performance</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="mq/kafka.html">MQ</a></li><li class="chapter-item expanded "><a href="mq/kafka-python.html">Kafkaçš„é€šä¿—ç¸½çµ</a></li><li class="chapter-item expanded "><a href="database/database.html">Database</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="database/redis.html">Redis</a></li><li class="chapter-item "><a href="database/hash.html">Redis Hash</a></li><li class="chapter-item "><a href="database/clickhouse.html">ClickHouse</a></li><li class="chapter-item "><a href="database/dolphin.html">Dolphin</a></li><li class="chapter-item "><a href="database/sqlite.html">Sqlite</a></li></ol></li><li class="chapter-item expanded "><a href="cryptotrade/cryptotrade.html">CryptoTrade</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="cryptotrade/binance/binance.html">Binance</a></li><li class="chapter-item "><a href="cryptotrade/binance/oco.html">å¦‚ä½•å°‡OCOè¨‚å–®ç™¼é€åˆ°Binance</a></li></ol></li><li class="chapter-item expanded "><a href="git/git.html">Git</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="git/git-remove-commited-files.html">git-remove-commited-files</a></li><li class="chapter-item "><a href="git/cheat-sheet.html">Git å¸¸ç”¨</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_notes" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="linux-æ•ˆèƒ½åˆ†æå·¥å…·-perf"><a class="header" href="#linux-æ•ˆèƒ½åˆ†æå·¥å…·-perf">Linux æ•ˆèƒ½åˆ†æå·¥å…·: Perf</a></h1>
<h2 id="ç°¡ä»‹"><a class="header" href="#ç°¡ä»‹">ç°¡ä»‹</a></h2>
<p><a href="https://perf.wiki.kernel.org/index.php/Main_Page">Perf</a> å…¨åæ˜¯ Performance Eventï¼Œæ˜¯åœ¨ Linux 2.6.31 ä»¥å¾Œå…§å»ºçš„ç³»çµ±æ•ˆèƒ½åˆ†æå·¥å…·ï¼Œå®ƒéš¨è‘—æ ¸å¿ƒä¸€ä½µé‡‹å‡ºã€‚è—‰ç”± perfï¼Œæ‡‰ç”¨ç¨‹å¼å¯ä»¥åˆ©ç”¨ PMU (Performance Monitoring Unit), tracepoint å’Œæ ¸å¿ƒå…§éƒ¨çš„ç‰¹æ®Šè¨ˆæ•¸å™¨ (counter) ä¾†é€²è¡Œçµ±è¨ˆï¼Œå¦å¤–é‚„èƒ½åŒæ™‚åˆ†æé‹è¡Œä¸­çš„æ ¸å¿ƒç¨‹å¼ç¢¼ï¼Œå¾è€Œæ›´å…¨é¢ç­è§£æ‡‰ç”¨ç¨‹å¼ä¸­çš„æ•ˆèƒ½ç“¶é ¸ã€‚</p>
<p>ç›¸è¼ƒæ–¼ <a href="https://en.wikipedia.org/wiki/OProfile">OProfile</a> å’Œ <a href="https://sourceware.org/binutils/docs/gprof/">GProf</a> ï¼Œperf çš„å„ªå‹¢åœ¨æ–¼èˆ‡ Linux Kernel ç·Šå¯†çµåˆï¼Œä¸¦å¯å—ç›Šæ–¼æœ€å…ˆç´å…¥æ ¸å¿ƒçš„æ–°ç‰¹å¾µã€‚perf åŸºæœ¬åŸç†æ˜¯å°ç›®æ¨™é€²è¡Œå–æ¨£ï¼Œç´€éŒ„ç‰¹å®šçš„æ¢ä»¶ä¸‹æ‰€åµæ¸¬çš„äº‹ä»¶æ˜¯å¦ç™¼ç”Ÿä»¥åŠç™¼ç”Ÿçš„æ¬¡æ•¸ã€‚ä¾‹å¦‚æ ¹æ“š tick ä¸­æ–·é€²è¡Œå–æ¨£ï¼Œå³åœ¨ tick ä¸­æ–·å…§è§¸ç™¼å–æ¨£é»ï¼Œåœ¨å–æ¨£é»è£¡åˆ¤æ–·è¡Œç¨‹ (process) ç•¶æ™‚çš„ contextã€‚å‡å¦‚ä¸€å€‹è¡Œç¨‹ 90% çš„æ™‚é–“éƒ½èŠ±è²»åœ¨å‡½å¼ foo() ä¸Šï¼Œé‚£éº¼ 90% çš„å–æ¨£é»éƒ½æ‡‰è©²è½åœ¨å‡½å¼ foo() çš„ä¸Šä¸‹æ–‡ä¸­ã€‚</p>
<p>Perf å¯å–æ¨£çš„äº‹ä»¶éå¸¸å¤šï¼Œå¯ä»¥åˆ†æ Hardware eventï¼Œå¦‚ cpu-cyclesã€instructions ã€cache-missesã€branch-misses â€¦ç­‰ç­‰ã€‚å¯ä»¥åˆ†æ Software eventï¼Œå¦‚ page-faultsã€context-switches â€¦ç­‰ç­‰ï¼Œå¦å¤–ä¸€ç¨®å°±æ˜¯ Tracepoint eventã€‚çŸ¥é“äº† cpu-cyclesã€instructions æˆ‘å€‘å¯ä»¥ç­è§£ Instruction per cycle æ˜¯å¤šå°‘ï¼Œé€²è€Œåˆ¤æ–·ç¨‹å¼ç¢¼æœ‰æ²’æœ‰å¥½å¥½åˆ©ç”¨ CPUï¼Œcache-misses å¯ä»¥æ›‰å¾—æ˜¯å¦æœ‰å–„ç”¨ Locality of reference ï¼Œbranch-misses å¤šäº†æ˜¯å¦å°è‡´åš´é‡çš„ pipeline hazardï¼Ÿå¦å¤– Perf é‚„å¯ä»¥å°å‡½å¼é€²è¡Œæ¡æ¨£ï¼Œç­è§£æ•ˆèƒ½å¡åœ¨å“ªé‚Šã€‚</p>
<h2 id="å®‰è£"><a class="header" href="#å®‰è£">å®‰è£</a></h2>
<p>é¦–å…ˆåˆ©ç”¨ä»¥ä¸‹æŒ‡ä»¤æŸ¥çœ‹ç›®å‰çš„ Kernel config æœ‰æ²’æœ‰å•Ÿç”¨ Perfã€‚å¦‚æœ PC ä¸Šæ˜¯è£ä¸€èˆ¬ Linux distroï¼Œé è¨­å€¼æ‡‰è©²éƒ½æœ‰é–‹å•Ÿã€‚</p>
<pre><code class="language-sh">ï¼„ cat "/boot/config-`uname -r`" | grep "PERF_EVENT"
</code></pre>
<p>å¦‚æœè‡ªå·±ç·¨è­¯æ ¸å¿ƒå¯ä»¥åƒç…§<a href="http://www.carbondesignsystems.com/virtual-prototype-blog/using-the-arm-performance-monitor-unit-pmu-linux-driver">é€™ç¯‡æ–‡ç« </a>ä¾†å•Ÿç”¨ perfã€‚</p>
<p>åƒè€ƒçš„ç’°å¢ƒæ˜¯ Ubuntu 14.04ï¼Œkernel ç‰ˆæœ¬ 3.16.0ã€‚æœ‰å…©ç¨®æ–¹æ³•å¯ä»¥å®‰è£</p>
<ol>
<li>å‰é¢è¬›åˆ°ï¼Œperf æ˜¯ Linux å…§å»ºæ”¯æŒçš„æ•ˆèƒ½å„ªåŒ–å·¥å…·ï¼Œåœ¨ 2.6.31 ç‰ˆæœ¬ä¹‹å¾Œï¼Œæˆ‘å€‘å¯ä»¥ç›´æ¥åˆ° <a href="https://www.kernel.org/">Linux Kernel Archives</a> ä¸‹è¼‰å°æ‡‰ç‰ˆæœ¬çš„ç¨‹å¼ç¢¼ï¼Œè§£å£“ç¸®å¾Œåˆ° <code>tools/perf</code> è£¡é¢å»ç·¨è­¯ï¼Œé€šå¸¸éç¨‹ä¸­æœƒæœ‰ç›¸ä¾çš„å¥—ä»¶éœ€è¦å®‰è£ï¼Œä¾æŒ‡ç¤ºå®Œæˆå®‰è£å¾Œï¼Œç·¨è­¯å³å¯æˆåŠŸï¼Œæœ€å¾Œå†æŠŠç·¨è­¯å®Œæˆçš„ perf ç§»è‡³ <code>/usr/bin</code> ä¸­å°±å¯ä»¥ä½¿ç”¨äº†ã€‚ é€™ç¨®æ–¹æ³•é€šå¸¸é©ç”¨æ–¼æ›´æ–°é kernel çš„ä½¿ç”¨è€…ï¼Œå› ç‚ºæ›´æ–°é kernel å¾Œæœƒé€ æˆ distribution package èˆ‡ kernel version ä¸ç›¸ç¬¦ã€‚ä¸€èˆ¬ä½¿ç”¨è€…æ¡ç”¨ç¬¬äºŒç¨®æ–¹æ³•å³å¯ã€‚</li>
<li>ä½¿ç”¨ apt-get é€²è¡Œå®‰è£ã€‚</li>
</ol>
<pre><code class="language-sh">$ sudo apt-get install linux-tools-common
</code></pre>
<p>æ¥è‘—è¼¸å…¥ perf list æˆ– perf top æª¢æŸ¥ä¸€ä¸‹ perf å¯ä¸å¯ä»¥ä½¿ç”¨ã€‚</p>
<p>å¦‚æœå‡ºç¾ä»¥ä¸‹çš„è¨Šæ¯ï¼Œè¡¨ç¤ºé‚„æ¼äº†äº›æ±è¥¿ã€‚</p>
<pre><code>WARNING: perf not found for kernel 3.16.0-50
You may need to install the following packages for this specific kernel:
    linux-tools-3.16.0-50-generic
    linux-cloud-tools-3.16.0-50-generic
</code></pre>
<p>ä¸Šé¢çš„ Kernel ç‰ˆæœ¬å¯èƒ½å’Œä½ ä¸ä¸€æ¨£ï¼Œæ ¹æ“šæŒ‡ç¤ºå®‰è£èµ·ä¾†å³å¯ã€‚ä¸æ”¾å¿ƒçš„è©±å¯ä»¥ä½¿ç”¨<code>ï¼„ uname -r</code>ç¢ºèªã€‚</p>
<pre><code class="language-sh">$ sudo apt-get install linux-tools-3.16.0-50-generic linux-cloud-tools-3.16.0-50-generic
</code></pre>
<ol>
<li>åˆ°é€™è£¡ perf çš„å®‰è£å°±å®Œæˆäº†ã€‚ä¸éé€™è£¡æˆ‘å†ç¨å¾®è£œå……ä¸€ä¸‹ï¼Œå¦‚æœä½ ä¸æ˜¯åˆ‡æ›åˆ° root çš„æƒ…æ³ä¸‹è¼¸å…¥</li>
</ol>
<pre><code class="language-sh">$ perf top
</code></pre>
<p>å…¶å¯¦æœƒå‡ºç¾ä»¥ä¸‹éŒ¯èª¤ç•«é¢ã€‚</p>
<p><img src="images/perf_top_error.png" alt="img" /></p>
<p>kernel.perf_event_paranoid æ˜¯ç”¨ä¾†æ±ºå®šä½ åœ¨æ²’æœ‰ root æ¬Šé™ä¸‹ (Normal User) ä½¿ç”¨ perf æ™‚ï¼Œä½ å¯ä»¥å–å¾—å“ªäº› event dataã€‚é è¨­å€¼æ˜¯ 1 ï¼Œä½ å¯ä»¥è¼¸å…¥</p>
<pre><code class="language-sh">$ cat /proc/sys/kernel/perf_event_paranoid
</code></pre>
<p>ä¾†æŸ¥çœ‹æ¬Šé™å€¼ã€‚ä¸€å…±æœ‰å››ç¨®æ¬Šé™å€¼:</p>
<p><code>2</code> : ä¸å…è¨±ä»»ä½•é‡æ¸¬ã€‚ä½†éƒ¨ä»½ç”¨ä¾†æŸ¥çœ‹æˆ–åˆ†æå·²å­˜åœ¨çš„ç´€éŒ„çš„æŒ‡ä»¤ä»å¯ä½¿ç”¨ï¼Œå¦‚ perf lsã€perf reportã€perf timechartã€ perf traceã€‚</p>
<p><code>1</code> : ä¸å…è¨± CPU events dataã€‚ä½†å¯ä»¥ä½¿ç”¨ perf statã€perf record ä¸¦å–å¾— Kernel profiling dataã€‚</p>
<p><code>0</code> : ä¸å…è¨± raw tracepoint accessã€‚ä½†å¯ä»¥ä½¿ç”¨ perf statã€perf record ä¸¦å–å¾— CPU events dataã€‚</p>
<p><code>-1</code>: æ¬Šé™å…¨é–‹ã€‚</p>
<p>æœ€å¾Œå¦‚æœè¦æª¢æ¸¬ cache miss event ï¼Œéœ€è¦å…ˆå–æ¶ˆ kernel pointer çš„ç¦ç”¨ã€‚</p>
<pre><code class="language-sh">$ sudo sh -c " echo 0 &gt; /proc/sys/kernel/kptr_restrict"
</code></pre>
<h2 id="å…ˆä¾†å€‹ç¯„ä¾‹æš–èº«å§"><a class="header" href="#å…ˆä¾†å€‹ç¯„ä¾‹æš–èº«å§">å…ˆä¾†å€‹ç¯„ä¾‹æš–èº«å§ï¼</a></h2>
<p>ä¸€é–‹å§‹ï¼Œæˆ‘å€‘å…ˆä½¿ç”¨ç¬¬ä¸€æ¬¡ä½œæ¥­ ã€Œè¨ˆç®—åœ“å‘¨ç‡ã€ çš„ç¨‹å¼ä¾†é«”æœƒä¸€ä¸‹ perf ä½¿ç”¨ã€‚ [perf_top_example.c]</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;

double compute_pi_baseline(size_t N) {
    double pi = 0.0;
    double dt = 1.0 / N;
    for (size_t i = 0; i &lt; N; i++) {
        double x = (double) i / N;
        pi += dt / (1.0 + x * x);
    }
    return pi * 4.0;
}
int main() {
    printf("pid: %d\n", getpid());
    sleep(10);
    compute_pi_baseline(50000000);
    return 0;
}
</code></pre>
<p>å°‡ä¸Šè¿°ç¨‹å¼å­˜æª”ç‚º perf_top_example.cï¼Œä¸¦åŸ·è¡Œï¼š</p>
<pre><code class="language-sh">g++ -c perf_top_example.c
g++ perf_top_example.o -o example
./example
</code></pre>
<p>åŸ·è¡Œä¸Šè¿°ç¨‹å¼å¾Œï¼Œå¯ä»¥å–å¾—ä¸€å€‹ pid å€¼ï¼Œå†æ ¹æ“š pid è¼¸å…¥</p>
<pre><code class="language-sh">perf top -p $pid
</code></pre>
<p>æ‡‰è©²æœƒå¾—åˆ°é¡ä¼¼ä¸‹é¢çš„çµæœï¼š</p>
<p><img src="images/perf_computepi_example.png" alt="img" /></p>
<p>é è¨­çš„ performance event æ˜¯ ã€Œcyclesã€ï¼Œæ‰€ä»¥é€™æ¢æŒ‡ä»¤å¯ä»¥åˆ†æå‡ºæ¶ˆè€— CPU é€±æœŸæœ€å¤šçš„éƒ¨ä»½ï¼Œçµæœé¡¯ç¤ºå‡½å¼ compute_pi_baseline() ä½”äº†è¿‘ 99.9ï¼…ï¼Œè·Ÿé æœŸä¸€æ¨£ï¼Œæ­¤å‡½å¼æ˜¯ç¨‹å¼ä¸­çš„ã€Œç†±é»ã€ï¼æœ‰äº†ä¸€äº›æ„Ÿè¦ºå¾Œï¼Œå¾Œé¢æœƒè©³ç´°ä¸€é»ä»‹ç´¹ perf ç”¨æ³•ã€‚</p>
<h2 id="èƒŒæ™¯çŸ¥è­˜"><a class="header" href="#èƒŒæ™¯çŸ¥è­˜">èƒŒæ™¯çŸ¥è­˜</a></h2>
<p>ä»¥ä¸‹ç¯€éŒ„ä¸Šæµ·äº¤å¤§é€šä¿¡èˆ‡é›»å­å·¥ç¨‹ç³»çš„åŠ‰æ˜å¯«çš„æ–‡ç« ï¼š</p>
<p><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-perf1/">Perf â€“ Linuxä¸‹çš„ç³»çµ±æ€§èƒ½èª¿å„ªå·¥å…·</a></p>
<p><a href="https://zh.wikipedia.org/zh-tw/Wikipedia:%E7%B9%81%E7%B0%A1%E5%88%86%E6%AD%A7%E8%A9%9E%E8%A1%A8#.E7.A7.91.E6.8A.80">ç°¡ç¹é«”ä¸­æ–‡è©å½™å°ç…§ï¼šç§‘æŠ€çº‡</a> (æœ¬èª²ç¨‹æ–Ÿé…Œä¿®æ”¹è©å½™ï¼Œ<code>==&gt;</code> é–‹é ­è¡¨ç¤ºè£œå……)</p>
<ul>
<li><strong>èƒŒæ™¯çŸ¥è­˜</strong></li>
</ul>
<p>æœ‰äº›èƒŒæ™¯çŸ¥è­˜æ˜¯åˆ†ææ€§èƒ½å•é¡Œæ™‚éœ€è¦ç­è§£çš„ã€‚æ¯”å¦‚ç¡¬ä»¶ cacheï¼›å†æ¯”å¦‚ä½œæ¥­ç³»çµ±æ ¸å¿ƒã€‚æ‡‰ç”¨ç¨‹å¼çš„è¡Œç‚ºç´°ç¯€å¾€å¾€æ˜¯å’Œé€™äº›æ±è¥¿äº’ç›¸ç‰½æ‰¯çš„ï¼Œé€™äº›åº•å±¤çš„æ±è¥¿æœƒä»¥æ„æƒ³ä¸åˆ°çš„æ–¹å¼å½±éŸ¿æ‡‰ç”¨ç¨‹å¼çš„æ€§èƒ½ï¼Œæ¯”å¦‚æŸäº›ç¨‹å¼ç„¡æ³•å……åˆ†åˆ©ç”¨ cacheï¼Œå¾è€Œå°è‡´æ€§èƒ½ä¸‹é™ã€‚æ¯”å¦‚ä¸å¿…è¦åœ°å‘¼å«éå¤šçš„ç³»çµ±å‘¼å«ï¼Œé€ æˆé »ç¹çš„æ ¸å¿ƒ / ä½¿ç”¨è€…å±¤ç´šçš„åˆ‡æ› â€¦ç­‰ç­‰ã€‚é€™è£¡åªæ˜¯ç‚ºæœ¬æ–‡çš„å¾ŒçºŒå…§å®¹åšäº›æ¦‚è¿°ï¼Œé—œæ–¼æ•ˆèƒ½èª¿æ ¡é‚„æœ‰å¾ˆå¤šæ±è¥¿ã€‚</p>
<ul>
<li><strong>æ•ˆèƒ½ç›¸é—œçš„è™•ç†å™¨ç¡¬é«”ç‰¹æ€§ï¼ŒPMU ç°¡ä»‹</strong></li>
</ul>
<p>ç•¶æ¼”ç®—æ³•å·²è¶¨æ–¼æœ€ä½³åŒ–ï¼Œç¨‹å¼ç¢¼ä¸æ–·ç²¾ç°¡ï¼Œäººå€‘èª¿åˆ°æœ€å¾Œï¼Œä¾¿éœ€è¦æ–¤æ–¤è¨ˆè¼ƒäº†ã€‚cacheã€pipeline ç­‰å¹³æ™‚ä¸å¤§æ³¨æ„çš„æ±è¥¿ä¹Ÿå¿…é ˆç²¾æ‰“ç´°ç®—äº†ã€‚</p>
<ul>
<li><strong>ç¡¬é«”ç‰¹æ€§ä¹‹ cache</strong></li>
</ul>
<p>è¨˜æ†¶é«”å­˜å–å¾ˆå¿«ï¼Œä½†ä»ç„¡æ³•å’Œè™•ç†å™¨çš„æŒ‡ä»¤åŸ·è¡Œé€Ÿåº¦ç›¸æä¸¦è«–ã€‚ç‚ºäº†å¾è¨˜æ†¶é«”ä¸­è®€å–æŒ‡ä»¤ (instruction) å’Œè³‡æ–™ (data)ï¼Œè™•ç†å™¨éœ€è¦ç­‰å¾…ï¼Œç”¨è™•ç†å™¨çš„æ™‚é–“ä¾†è¡¡é‡ï¼Œé€™ç¨®ç­‰å¾…éå¸¸æ¼«é•·ã€‚cache æ˜¯ä¸€ç¨® SRAMï¼Œå®ƒçš„å­˜å–é€Ÿç‡éå¸¸å¿«ï¼Œèˆ‡è™•ç†å™¨è™•ç†é€Ÿåº¦è¼ƒç‚ºæ¥è¿‘ã€‚å› æ­¤å°‡å¸¸ç”¨çš„è³‡æ–™ä¿å­˜åœ¨ cache ä¸­ï¼Œè™•ç†å™¨ä¾¿ç„¡é ˆç­‰å¾…ï¼Œå¾è€Œæé«˜æ•ˆèƒ½ã€‚cache çš„å°ºå¯¸ä¸€èˆ¬éƒ½å¾ˆå°ï¼Œå……åˆ†åˆ©ç”¨ cache æ˜¯è»Ÿé«”æ•ˆèƒ½æ”¹å–„éç¨‹ä¸­ï¼Œéå¸¸é‡è¦çš„éƒ¨åˆ†ã€‚</p>
<ul>
<li><strong>ç¡¬é«”ç‰¹æ€§ä¹‹ pipeline, superscalar, out-ot-order execution</strong></li>
</ul>
<p>ææ˜‡æ•ˆèƒ½æœ€æœ‰æ•ˆçš„æ–¹å¼ä¹‹ä¸€å°±æ˜¯å¹³è¡Œ (parallelism)ã€‚è™•ç†å™¨åœ¨è¨­è¨ˆæ™‚ä¹Ÿå„˜å¯èƒ½åœ°å¹³è¡Œï¼Œæ¯”å¦‚ pipeline, superscalar, out-of-executionã€‚</p>
<p>è™•ç†å™¨è™•ç†ä¸€æ¢æŒ‡ä»¤éœ€è¦åˆ†å¤šå€‹æ­¥é©Ÿå®Œæˆï¼Œæ¯”å¦‚ fetch æŒ‡ä»¤ï¼Œç„¶å¾Œå®Œæˆé‹ç®—ï¼Œæœ€å¾Œå°‡è¨ˆç®—çµæœè¼¸å‡ºåˆ°åŒ¯æµæ’ (bus) ä¸Šã€‚åœ¨è™•ç†å™¨å…§éƒ¨ï¼Œé€™å¯ä»¥çœ‹ä½œä¸€å€‹ä¸‰ç´š pipelineï¼Œå¦‚ä¸‹åœ–è™•ç†å™¨ pipeline æ‰€ç¤ºï¼š</p>
<p><img src="images/3stage_pipeline.gif" alt="img" /></p>
<p>æŒ‡ä»¤å¾å·¦é‚Šé€²å…¥è™•ç†å™¨ï¼Œä¸Šåœ–ä¸­çš„ pipeline æœ‰ä¸‰ç´šï¼Œä¸€å€‹æ™‚é˜é€±æœŸå…§å¯ä»¥åŒæ™‚è™•ç†ä¸‰æ¢æŒ‡ä»¤ï¼Œåˆ†åˆ¥è¢« pipeline çš„ä¸åŒéƒ¨åˆ†è™•ç†ã€‚</p>
<p>Superscalar æŒ‡ä¸€å€‹æ™‚é˜é€±æœŸè§¸ç™¼ (issue) å¤šæ¢æŒ‡ä»¤çš„ pipelineæ©Ÿå™¨æ¶æ§‹ï¼Œæ¯”å¦‚ Intel çš„ Pentium è™•ç†å™¨ï¼Œå…§éƒ¨æœ‰å…©å€‹åŸ·è¡Œå–®å…ƒï¼Œåœ¨ä¸€å€‹æ™‚é˜é€±æœŸå…§å…è¨±åŸ·è¡Œå…©æ¢æŒ‡ä»¤ã€‚</p>
<p>==&gt; é€™æ¨£ç¨±ç‚º dual-issueï¼Œå¯æƒ³åƒç‚ºä¸€å€‹ packet è£¡åŒæ™‚æœ‰å…©çµ„ pipelined çš„ instruction</p>
<p>==&gt; æ¯”æ–¹èªªï¼Œ<a href="http://www.arm.com/products/processors/cortex-a/cortex-a5.php">Cortex-A5</a> å’Œ Cortex-A8 ä¸€æ¨£æ¡ç”¨ ARMv7-A æŒ‡ä»¤é›†ï¼Œä½†æ˜¯ Cortex-A5 æ˜¯ Cortext-A8/A9 çš„ç²¾ç°¡ç‰ˆï¼Œæœ‰ä»¥ä¸‹å·®ç•°ï¼š</p>
<p>1.pipeline è‡ª 13 stages æ¸›ç‚º 8 stages 2.instruction è‡ª dual-issue æ¸›ç‚º single-issue 3.NEON/FPU ç‚ºé¸é… 4.ä¸å…·æœ‰ L2 Cache</p>
<p>æ­¤å¤–ï¼Œåœ¨è™•ç†å™¨å…§éƒ¨ï¼Œä¸åŒæŒ‡ä»¤æ‰€éœ€è¦çš„åŸ·è¡Œæ™‚é–“å’Œæ™‚é˜é€±æœŸæ˜¯ä¸åŒçš„ï¼Œå¦‚æœåš´æ ¼æŒ‰ç…§ç¨‹åºçš„åŸ·è¡Œé †åºåŸ·è¡Œï¼Œé‚£éº¼å°±ç„¡æ³•å……åˆ†åˆ©ç”¨è™•ç†å™¨çš„ pipelineã€‚å› æ­¤æŒ‡ä»¤æœ‰å¯èƒ½è¢«äº‚åºåŸ·è¡Œ (out-of-order execution)ã€‚</p>
<p>ä¸Šè¿°ä¸‰ç¨®å¹³è¡ŒæŠ€è¡“å°æ‰€åŸ·è¡Œçš„æŒ‡ä»¤æœ‰ä¸€å€‹åŸºæœ¬è¦æ±‚ï¼Œå³ç›¸é„°çš„æŒ‡ä»¤ç›¸äº’æ²’æœ‰ä¾è³´é—œä¿‚ã€‚å‡å¦‚æŸæ¢æŒ‡ä»¤éœ€è¦ä¾è³´å‰é¢ä¸€æ¢æŒ‡ä»¤çš„åŸ·è¡Œçµæœæ•¸æ“šï¼Œé‚£éº¼ pipeline ä¾¿å¤±å»ä½œç”¨ï¼Œå› ç‚ºç¬¬äºŒæ¢æŒ‡ä»¤å¿…é ˆç­‰å¾…ç¬¬ä¸€æ¢æŒ‡ä»¤å®Œæˆã€‚å› æ­¤å¥½çš„è»Ÿé«”å¿…é ˆå„˜é‡é¿å…ç”¢ç”Ÿé€™ç¨®ç¨‹å¼ç¢¼ã€‚</p>
<ul>
<li><strong>ç¡¬é«”ç‰¹æ€§ä¹‹ branch prediction</strong></li>
</ul>
<p>branch prediction æŒ‡ä»¤å°è»Ÿé«”æ•ˆèƒ½å½±éŸ¿è¼ƒå¤§ã€‚å°¤å…¶æ˜¯ç•¶è™•ç†å™¨æ¡ç”¨æµæ°´ç·šè¨­è¨ˆä¹‹å¾Œï¼Œå‡è¨­ pipeline æœ‰ä¸‰ç´šï¼Œä¸”ç›®å‰é€²å…¥ pipeline çš„ç¬¬ä¸€é“æŒ‡ä»¤ç‚ºåˆ†æ”¯ (branch) æŒ‡ä»¤ã€‚å‡è¨­è™•ç†å™¨é †åºè®€å–æŒ‡ä»¤ï¼Œé‚£éº¼å¦‚æœåˆ†æ”¯çš„çµæœæ˜¯è·³èºåˆ°å…¶ä»–æŒ‡ä»¤ï¼Œé‚£éº¼è¢«è™•ç†å™¨ pipeline æ‰€ fetch çš„å¾ŒçºŒå…©æ¢æŒ‡ä»¤å‹¢å¿…è¢«æ£„ç½® (ä¾†ä¸åŠåŸ·è¡Œ)ï¼Œå¾è€Œå½±éŸ¿æ€§èƒ½ã€‚ç‚ºæ­¤ï¼Œå¾ˆå¤šè™•ç†å™¨éƒ½æä¾›äº† branch predictionï¼Œæ ¹æ“šåŒä¸€æ¢æŒ‡ä»¤çš„æ­·å²åŸ·è¡Œè¨˜éŒ„é€²è¡Œé æ¸¬ï¼Œè®€å–æœ€å¯èƒ½çš„ä¸‹ä¸€æ¢æŒ‡ä»¤ï¼Œè€Œä¸¦éé †åºè®€å–æŒ‡ä»¤ã€‚</p>
<p>==&gt; æ­é…ç°¡å ±: <a href="http://www.cs.ucr.edu/~gupta/teaching/203A-09/My6.pdf">Branch Prediction</a></p>
<p>branch prediction å°è»Ÿé«”æ¶æ§‹æœ‰äº›è¦æ±‚ï¼Œå°æ–¼é‡è¤‡æ€§çš„åˆ†æ”¯æŒ‡ä»¤åºåˆ—ï¼Œbranch prediction ç¡¬é«”æ‰èƒ½å¾—åˆ°è¼ƒå¥½çš„é æ¸¬çµæœï¼Œè€Œå°æ–¼é¡ä¼¼ switch-case ä¸€é¡çš„ç¨‹å¼çµæ§‹ï¼Œå‰‡å¾€å¾€ä¸æ˜“å¾—åˆ°ç†æƒ³çš„é æ¸¬çµæœã€‚</p>
<p>==&gt; å°ç…§é–±è®€: <a href="http://igoro.com/archive/fast-and-slow-if-statements-branch-prediction-in-modern-processors/">Fast and slow if-statements: branch prediction in modern processors</a></p>
<p>==&gt; ç·¨è­¯å™¨æä¾›çš„è¼”åŠ©æ©Ÿåˆ¶: <a href="http://cellperformance.beyond3d.com/articles/2006/04/branch-patterns-using-gcc.html">Branch Patterns, Using GCC</a></p>
<p>ä¸Šé¢ä»‹ç´¹çš„å¹¾ç¨®è™•ç†å™¨ç‰¹æ€§å°è»Ÿé«”æ•ˆèƒ½å½±éŸ¿å¾ˆå¤§ï¼Œç„¶è€Œä¾è³´æ™‚é˜é€²è¡Œå®šæœŸæ¡æ¨£çš„ profiler æ¨¡å¼ç„¡æ³•é—¡è¿°ç¨‹å¼å°é€™äº›è™•ç†å™¨ç¡¬é«”ç‰¹æ€§çš„ä½¿ç”¨æƒ…æ³ã€‚è™•ç†å™¨å» å•†é‡å°é€™ç¨®æƒ…æ³ï¼Œåœ¨ç¡¬é«”ä¸­åŠ å…¥äº† PMU (performance monitor unit)ã€‚PMU å…è¨±ç¡¬é«”é‡å°æŸç¨®äº‹ä»¶è¨­ç½® counterï¼Œæ­¤å¾Œè™•ç†å™¨ä¾¿é–‹å§‹çµ±è¨ˆè©²äº‹ä»¶çš„ç™¼ç”Ÿæ¬¡æ•¸ï¼Œç•¶ç™¼ç”Ÿçš„æ¬¡æ•¸è¶…é counter å…§è¨­å®šçš„æ•¸å€¼å¾Œï¼Œä¾¿ç”¢ç”Ÿä¸­æ–·ã€‚æ¯”å¦‚ cache miss é”åˆ°æŸå€‹å€¼å¾Œï¼ŒPMU ä¾¿èƒ½ç”¢ç”Ÿç›¸æ‡‰çš„ä¸­æ–·ã€‚ä¸€æ—¦æ•ç²é€™äº›ä¸­æ–·ï¼Œä¾¿å¯åˆ†æç¨‹å¼å°é€™äº›ç¡¬é«”ç‰¹æ€§çš„ä½¿ç”¨ç‡äº†ã€‚</p>
<ul>
<li><strong>Tracepoints</strong></li>
</ul>
<p>Tracepoint æ˜¯æ•£è½åœ¨æ ¸å¿ƒåŸå§‹ç¨‹å¼ç¢¼çš„ä¸€äº› hookï¼Œä¸€æ—¦ä½¿èƒ½ï¼Œåœ¨æŒ‡å®šçš„ç¨‹å¼ç¢¼è¢«é‹è¡Œæ™‚ï¼Œtracepoint å°±æœƒè¢«è§¸ç™¼ï¼Œé€™æ¨£çš„ç‰¹æ€§å¯è¢«å„ç¨® trace/debug å·¥å…·æ‰€ä½¿ç”¨ï¼Œperf å°±æ˜¯é€™æ¨£çš„æ¡ˆä¾‹ã€‚è‹¥ä½ æƒ³çŸ¥é“åœ¨æ‡‰ç”¨ç¨‹å¼åŸ·è¡Œæ™‚æœŸï¼Œæ ¸å¿ƒè¨˜æ†¶é«”ç®¡ç†æ¨¡çµ„çš„è¡Œç‚ºï¼Œå³å¯é€éæ½›ä¼åœ¨ slab åˆ†é…å™¨ä¸­çš„ tracepointã€‚ç•¶æ ¸å¿ƒé‹è¡Œåˆ°é€™äº› tracepoint æ™‚ï¼Œä¾¿æœƒé€šçŸ¥ perfã€‚</p>
<p>Perf å°‡ tracepoint ç”¢ç”Ÿçš„äº‹ä»¶è¨˜éŒ„ä¸‹ä¾†ï¼Œç”Ÿæˆå ±å‘Šï¼Œé€šéåˆ†æé€™äº›å ±å‘Šï¼Œæ•ˆèƒ½åˆ†æèª¿æ ¡çš„å·¥ç¨‹äººå“¡ä¾¿å¯ç­è§£ç¨‹å¼åŸ·è¡Œæ™‚æœŸçš„æ ¸å¿ƒç¨®ç¨®ç´°ç¯€ï¼Œä¹Ÿèƒ½åšå‡ºé‡å°æ•ˆèƒ½æ›´æº–ç¢ºçš„è¨ºæ–·ã€‚</p>
<h2 id="perf-åŸºæœ¬ä½¿ç”¨"><a class="header" href="#perf-åŸºæœ¬ä½¿ç”¨">Perf åŸºæœ¬ä½¿ç”¨</a></h2>
<p>å‰é¢æœ‰æåˆ°ï¼ŒPerf èƒ½è§¸ç™¼çš„äº‹ä»¶åˆ†ç‚ºä¸‰é¡ï¼š</p>
<ul>
<li><strong>hardware</strong> : ç”± PMU ç”¢ç”Ÿçš„äº‹ä»¶ï¼Œæ¯”å¦‚ cache-missesã€cpu-cyclesã€instructionsã€branch-misses â€¦ç­‰ç­‰ï¼Œé€šå¸¸æ˜¯ç•¶éœ€è¦ç­è§£ç¨‹åºå°ç¡¬é«”ç‰¹æ€§çš„ä½¿ç”¨æƒ…æ³æ™‚æœƒä½¿ç”¨ã€‚</li>
<li><strong>software</strong> : æ˜¯æ ¸å¿ƒç¨‹å¼ç”¢ç”Ÿçš„äº‹ä»¶ï¼Œæ¯”å¦‚ context-switchesã€page-faultsã€cpu-clockã€cpu-migrations â€¦ç­‰ç­‰ã€‚</li>
<li><strong>tracepoint</strong> : æ˜¯æ ¸å¿ƒä¸­çš„éœæ…‹ tracepoint æ‰€è§¸ç™¼çš„äº‹ä»¶ï¼Œé€™äº› tracepoint ç”¨ä¾†åˆ¤æ–·åœ¨ç¨‹å¼åŸ·è¡Œæ™‚æœŸï¼Œæ ¸å¿ƒçš„è¡Œç‚ºç´°ç¯€ï¼Œæ¯”å¦‚ slab è¨˜æ†¶é«”é…ç½®å™¨çš„é…ç½®æ¬¡æ•¸ç­‰ã€‚</li>
</ul>
<p>Perf åŒ…å« 20 å¹¾ç¨®å­å·¥å…·é›†ï¼Œä¸éæˆ‘é‚„æ²’ç¢°éå¾ˆå¤šï¼Œæˆ‘æ ¹æ“šç›®å‰ç†è§£å…ˆä»‹ç´¹ä»¥ä¸‹ã€‚ å¦‚æœæƒ³çœ‹ç¬¬ä¸€æ‰‹è³‡æ–™</p>
<pre><code class="language-sh">$ perf help &lt;command&gt;
</code></pre>
<p>###perf list é€™æ‡‰è©²æ˜¯å¤§éƒ¨åˆ†çš„äººç¬¬ä¸€æ¬¡å®‰è£ perf å¾Œæ‰€ä¸‹çš„ç¬¬ä¸€å€‹æŒ‡ä»¤ï¼Œå®ƒèƒ½å°å‡º perf å¯ä»¥è§¸ç™¼å“ªäº› eventï¼Œä¸åŒ CPU å¯èƒ½æ”¯æ´ä¸åŒ hardware eventï¼Œä¸åŒ kernel ç‰ˆæœ¬æ”¯æ´çš„ softwareã€tracepoint event ä¹Ÿä¸åŒã€‚æˆ‘çš„ perf ç‰ˆæœ¬æ˜¯<code>3.19.8</code>ï¼Œæ‰€æ”¯æ´çš„ event å·²ç¶“è¶…é 1400 é …ï¼ˆå¦å¤–è¦åˆ—å‡º Tracepoint event å¿…é ˆé–‹å•Ÿ root æ¬Šé™ï¼‰ã€‚</p>
<pre><code class="language-sh">$ perf list
</code></pre>
<p><img src="images/perf_list.png" alt="img" /></p>
<h3 id="perf-top"><a class="header" href="#perf-top">perf top</a></h3>
<p>perf top å…¶å¯¦è·Ÿå¹³å¸¸ Linux å…§å»ºçš„ top æŒ‡ä»¤å¾ˆç›¸ä¼¼ã€‚å®ƒèƒ½å¤ ã€Œå³æ™‚ã€çš„åˆ†æå„å€‹å‡½å¼åœ¨æŸå€‹ event ä¸Šçš„ç†±é»ï¼Œæ‰¾å‡ºæ‹–æ…¢ç³»çµ±çš„å‡¶æ‰‹ï¼Œå°±å¦‚åŒä¸Šé¢é‚£å€‹ç¯„ä¾‹ä¸€æ¨£ã€‚ç”šè‡³ï¼Œå³ä½¿æ²’æœ‰ç‰¹å®šçš„ç¨‹åºè¦è§€å¯Ÿï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥ä¸‹é” <code>$ perf top</code> æŒ‡ä»¤ä¾†è§€å¯Ÿæ˜¯ä»€éº¼ç¨‹åºåƒæ‰ç³»çµ±æ•ˆèƒ½ï¼Œå°è‡´ç³»çµ±ç•°å¸¸è®Šæ…¢ã€‚è­¬å¦‚æˆ‘åŸ·è¡Œä¸€å€‹ç„¡çª®è¿´åœˆï¼š</p>
<pre><code class="language-c">int main() {
    long int i = 0;
    while(1) {
        i++;
        add(i);
        div(i);
    }
    return 0;
}
</code></pre>
<p>å¯ä»¥ç™¼ç¾ç´…è‰²ç†±é»å°±å‡ºç¾äº†ã€‚å³é‚Šç¬¬ä¸€åˆ—ç‚ºå„å‡½å¼çš„ç¬¦è™Ÿï¼Œå·¦é‚Šç¬¬ä¸€è¡Œæ˜¯è©²ç¬¦è™Ÿå¼•ç™¼çš„ event åœ¨æ•´å€‹ã€Œç›£è¦–åŸŸã€ä¸­ä½”çš„æ¯”ä¾‹ï¼Œæˆ‘å€‘ç¨±ä½œè©²ç¬¦è™Ÿçš„ç†±åº¦ï¼Œç›£è¦–åŸŸæŒ‡çš„æ˜¯ perf ç›£æ§çš„æ‰€æœ‰ç¬¦è™Ÿï¼Œé è¨­å€¼åŒ…æ‹¬ç³»çµ±æ‰€æœ‰ç¨‹åºã€æ ¸å¿ƒä»¥åŠæ ¸å¿ƒ module çš„å‡½å¼ï¼Œå·¦é‚Šç¬¬äºŒè¡Œå‰‡ç‚ºè©²ç¬¦è™Ÿæ‰€åœ¨çš„ Shared Object ã€‚è‹¥ç¬¦è™Ÿæ—é¡¯ç¤º<code>[.]</code>è¡¨ç¤ºå…¶ä½æ–¼ User modeï¼Œ<code>[k]</code>å‰‡ç‚º kernel modeã€‚</p>
<p><img src="images/perf_top_while.png" alt="img" /></p>
<p>ï¼ˆç•¶ä½ é—œæ‰è©²ç¨‹åºä¹‹å¾Œï¼Œé€™å€‹ç›£è¦–ç•«é¢ (tui ç•Œé¢) è£¡çš„è©²ç¨‹åºä¸æœƒã€Œé¦¬ä¸Šã€æ¶ˆå¤±ï¼Œè€Œæ˜¯å…¶ overhead çš„æ¯”ä¾‹ä¸€ç›´æ¸›å°‘ç„¶å¾Œæ…¢æ…¢é›¢é–‹åˆ—è¡¨ï¼‰ã€‚</p>
<p>æŒ‰ä¸‹ <code>h</code>å¯ä»¥å‘¼å« help ï¼Œå®ƒæœƒåˆ—å‡º perf top çš„æ‰€æœ‰åŠŸèƒ½å’Œå°æ‡‰æŒ‰éµã€‚ æˆ‘å€‘ä¾†è©¦çœ‹çœ‹ Annotateï¼ˆè¨»è§£ï¼‰ï¼Œé€™åŠŸèƒ½å¯ä»¥é€²ä¸€æ­¥æ·±å…¥åˆ†ææŸå€‹ç¬¦è™Ÿã€‚ä½¿ç”¨æ–¹å‘éµç§»åˆ°ä½ æœ‰èˆˆè¶£çš„ç¬¦è™ŸæŒ‰ä¸‹<code>a</code>ã€‚ å®ƒæœƒé¡¯ç¤ºå„æ¢æŒ‡ä»¤çš„ event å–æ¨£ç‡ï¼ˆè€—æ™‚è¼ƒå¤šçš„éƒ¨ä»½å°±å®¹æ˜“è¢« perf å–æ¨£åˆ°ï¼‰ã€‚</p>
<p><img src="images/perf_top_annotate.png" alt="img" /></p>
<p>æœ€å¾Œè‹¥ä½ æƒ³è¦è§€å¯Ÿå…¶ä»– event ( é è¨­ cycles ) å’ŒæŒ‡å®šå–æ¨£é »ç‡ ( é è¨­æ¯ç§’4000æ¬¡ ) :</p>
<pre><code>$ perf top -e cache-misses -c 5000
</code></pre>
<h3 id="perf-stat"><a class="header" href="#perf-stat">perf stat</a></h3>
<p>ç›¸è¼ƒæ–¼ topï¼Œä½¿ç”¨ perf stat å¾€å¾€æ˜¯ä½ å·²ç¶“æœ‰å€‹è¦å„ªåŒ–çš„ç›®æ¨™ï¼Œå°é€™å€‹ç›®æ¨™é€²è¡Œç‰¹å®šæˆ–ä¸€ç³»åˆ—çš„ event æª¢æŸ¥ï¼Œé€²è€Œç­è§£è©²ç¨‹åºçš„æ•ˆèƒ½æ¦‚æ³ã€‚ï¼ˆevent æ²’æœ‰æŒ‡å®šçš„è©±ï¼Œé è¨­æœƒæœ‰åç¨®å¸¸ç”¨ eventã€‚ï¼‰ æˆ‘å€‘ä¾†å°ä»¥ä¸‹ç¨‹å¼ä½¿ç”¨ perf stat å·¥å…· åˆ†æ cache miss æƒ…å½¢</p>
<pre><code class="language-c">static char array[10000][10000];
int main (void){
  int i, j;
  for (i = 0; i &lt; 10000; i++)
    for (j = 0; j &lt; 10000; j++)
       array[j][i]++;
  return 0;
}
</code></pre>
<pre><code class="language-sh">$ perf stat --repeat 5 -e cache-misses,cache-references,instructions,cycles ./perf_stat_cache_miss
    Performance counter stats for './perf_stat_cache_miss' (5 runs):
    4,416,226        cache-misses        #    3.437 % of all cache refs    ( +-  0.27% )
    128,483,262      cache-references                                      ( +-  0.02% )
    2,123,281,496    instructions        #    0.65  insns per cycle        ( +-  0.02% )
    3,281,498,034    cycles                                                ( +-  0.21% )
        1.299352302 seconds time elapsed                                   ( +-  0.19% )
</code></pre>
<p><code>--repeat &lt;n&gt;</code>æˆ–æ˜¯<code>-r &lt;n&gt;</code> å¯ä»¥é‡è¤‡åŸ·è¡Œ n æ¬¡è©²ç¨‹åºï¼Œä¸¦é¡¯ç¤ºæ¯å€‹ event çš„è®ŠåŒ–å€é–“ã€‚ <code>cache-misses,cache-references</code>å’Œ <code>instructions,cycles</code>é¡ä¼¼é€™ç¨®æˆå°çš„ eventï¼Œè‹¥åŒæ™‚å‡ºç¾ perf æœƒå¾ˆè²¼å¿ƒå¹«ä½ è¨ˆç®—æ¯”ä¾‹ã€‚</p>
<p>æ ¹æ“šé€™æ¬¡ perf stat çµæœå¯ä»¥æ˜é¡¯ç™¼ç¾ç¨‹åºæœ‰å¾ˆé«˜çš„ cache missï¼Œé€£å¸¶å½±éŸ¿ IPC åªæœ‰<code>0.65</code>ã€‚</p>
<p>å¦‚æœæˆ‘å€‘å–„ç”¨ä¸€ä¸‹å­˜å–çš„å±€éƒ¨æ€§ï¼Œå°‡ <code>iï¼Œj</code>å°èª¿æ”¹æˆ<code>array[i][j]++</code>ã€‚</p>
<pre><code>    Performance counter stats for './perf_stat_cache_miss' (5 runs):
    2,263,131        cache-misses        #   93.742 % of all cache refs    ( +-  0.53% )
    2,414,202        cache-references                                      ( +-  1.82% )
    2,123,275,176    instructions        #    1.98  insns per cycle        ( +-  0.03% )
    1,074,868,730    cycles                                                ( +-  1.96% )
        0.432727146 seconds time elapsed                                   ( +-  1.99% )
</code></pre>
<p>cache-references å¾ <code>128,483,262</code>ä¸‹é™åˆ° <code>2,414,202</code>ï¼Œå·®äº†äº”åå¹¾å€ï¼ŒåŸ·è¡Œæ™‚é–“ä¹Ÿç¸®çŸ­ç‚ºåŸä¾†çš„ä¸‰åˆ†ä¹‹ä¸€ï¼</p>
<p>###perf record &amp; perf report æœ‰åˆ¥æ–¼ statï¼Œrecord å¯ä»¥é‡å°å‡½å¼ç´šåˆ¥é€²è¡Œ event çµ±è¨ˆï¼Œæ–¹ä¾¿æˆ‘å€‘å°ç¨‹åºã€Œç†±é»ã€ä½œæ›´ç²¾ç´°çš„åˆ†æå’Œå„ªåŒ–ã€‚ æˆ‘å€‘ä¾†å°ä»¥ä¸‹ç¨‹å¼ï¼Œä½¿ç”¨ perf record é€²è¡Œ branch æƒ…æ³åˆ†æ</p>
<pre><code class="language-c">#define N 5000000
static int array[N] = { 0 };
void normal_loop(int a) {
    int i;
    for (i = 0; i &lt; N; i++)
        array[i] = array[i]+a;
}
void unroll_loop(int a) {
    int i;
    for (i = 0; i &lt; N; i+=5){
        array[i] = array[i]+1;
        array[i+1] = array[i+1]+a;
        array[i+2] = array[i+2]+a;
        array[i+3] = array[i+3]+a;
        array[i+4] = array[i+4]+a;
    }
}
int main() {
    normal_loop(1);
    unroll_loop(1);
    return 0;
}
</code></pre>
<pre><code class="language-sh">$ perf record -e branch-misses:u,branch-instructions:u ./perf_record_example
$ perf report
</code></pre>
<p><code>:u</code>æ˜¯è®“ perf åªçµ±è¨ˆç™¼ç”Ÿåœ¨ user space çš„ eventã€‚æœ€å¾Œå¯ä»¥è§€å¯Ÿåˆ°è¿´åœˆå±•é–‹å‰å¾Œ branch-instructions çš„å·®è·ã€‚</p>
<p>å¦å¤–ï¼Œä½¿ç”¨ record æœ‰å¯èƒ½æœƒç¢°åˆ°çš„å•é¡Œæ˜¯å–æ¨£é »ç‡å¤ªä½ï¼Œæœ‰äº›å‡½å¼çš„è¨Šæ¯æ²’æœ‰æ²’é¡¯ç¤ºå‡ºä¾†ï¼ˆæ²’å–æ¨£åˆ°ï¼‰ï¼Œé€™æ™‚å¯ä»¥ä½¿ç”¨ <code>-F &lt;frequcncy&gt;</code>ä¾†èª¿é«˜å–æ¨£é »ç‡ï¼Œå¯ä»¥è¼¸å…¥ä»¥ä¸‹æŸ¥çœ‹æœ€å¤§å€¼ï¼Œè¦æ›´æ”¹ä¹Ÿæ²’å•é¡Œï¼Œä½†èƒ½èª¿åˆ°å¤šå¤§å¯èƒ½é‚„è¦æŸ¥ä¸€ä¸‹ã€‚</p>
<pre><code class="language-sh">$ cat /proc/sys/kernel/perf_event_max_sample_rate
</code></pre>
<h2 id="åƒè€ƒè³‡æ–™"><a class="header" href="#åƒè€ƒè³‡æ–™">åƒè€ƒè³‡æ–™</a></h2>
<ul>
<li><a href="http://www.brendangregg.com/linuxperf.html">Linux Performance</a></li>
<li><a href="https://perf.wiki.kernel.org/index.php/Tutorial#Sample_analysis_with_perf_report">Tutorial - Linux kernel profiling with perf</a> [Perf wiki]</li>
<li>Perf - Linuxä¸‹çš„ç³»çµ±æ€§èƒ½èª¿å„ªå·¥å…· / åŠ‰æ˜ [IBM developerWorks]
<ul>
<li><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-perf1/">ç¬¬ä¸€éƒ¨åˆ† - ç°¡ä»‹ã€èƒŒæ™¯çŸ¥è­˜ã€åŸºæœ¬ä½¿ç”¨</a></li>
<li><a href="http://www.ibm.com/developerworks/cn/linux/l-cn-perf2/index.html">ç¬¬äºŒéƒ¨åˆ† - tracepointã€probeã€schedã€benchã€lockã€Kmemã€timechartã€ä½¿ç”¨ Script å¢å¼· perf çš„åŠŸèƒ½</a></li>
</ul>
</li>
<li><a href="http://rts.lab.asu.edu/web_438/project_final/CSE_598_Performance_Monitoring_Unit.pdf">A Study of Performance Monitoring Unit, perf and perf_events subsystem</a> [PDF]</li>
<li><a href="http://kernel.taobao.org/index.php?title=Documents/Perf_FAQ">Perf FAQ</a> [kernel.taobao.org]</li>
<li><a href="http://unix.stackexchange.com/questions/14227/do-i-need-root-admin-permissions-to-run-userspace-perf-tool-perf-events-ar">Do I need root (admin) permissions to run userspace â€˜perfâ€™ tool?</a></li>
<li><a href="http://www.carbondesignsystems.com/virtual-prototype-blog/using-the-arm-performance-monitor-unit-pmu-linux-driver">Using the ARM Performance Monitor Unit (PMU) Linux Driver</a></li>
<li><a href="http://blog.csdn.net/trochiluses/article/details/17346803">perf æ€§èƒ½åˆ†æå¯¦ä¾‹â€”â€”ä½¿ç”¨perfå„ªåŒ–cacheåˆ©ç”¨ç‡</a> [CSDN]</li>
</ul>
<h2 id="context-switches"><a class="header" href="#context-switches">Context Switches</a></h2>
<p>Context Switches  ä¸Šä¸‹æ–‡åˆ‡æ›ï¼Œæœ‰æ™‚ä¹Ÿè¢«ç¨±ç‚ºè™•ç†ç¨‹åºåˆ‡æ›(process switch)æˆ–ä»»å‹™åˆ‡æ›ã€‚æ˜¯ä¸€å€‹é‡è¦çš„æ€§èƒ½æŒ‡æ¨™ã€‚</p>
<p>CPUå¾ä¸€å€‹åŸ·è¡Œç·’åˆ‡æ›åˆ°å¦å¤–ä¸€å€‹åŸ·è¡Œç·’ï¼Œéœ€è¦ä¿å­˜ç•¶å‰ä»»å‹™çš„é‹è¡Œç’°å¢ƒï¼Œæ¢å¾©å°‡è¦é‹è¡Œä»»å‹™çš„é‹è¡Œç’°å¢ƒï¼Œå¿…ç„¶å¸¶ä¾†æ€§èƒ½æ¶ˆè€—ã€‚</p>
<p>Context Switches ä¸Šä¸‹æ–‡åˆ‡æ›ç°¡ä»‹</p>
<p>ä½œæ¥­ç³»çµ±å¯ä»¥åŒæ™‚é‹è¡Œå¤šå€‹è™•ç†ç¨‹åºï¼Œ ç„¶è€Œä¸€é¡†CPUåŒæ™‚åªèƒ½åŸ·è¡Œä¸€é …ä»»å‹™ï¼Œä½œæ¥­ç³»çµ±åˆ©ç”¨æ™‚é–“ç‰‡è¼ªè½‰çš„æ–¹å¼ï¼Œè®“ä½¿ç”¨è€…æ„Ÿè¦ºé€™äº›ä»»å‹™æ­£åœ¨åŒæ™‚é€²è¡Œã€‚ CPUçµ¦æ¯å€‹ä»»å‹™éƒ½æœå‹™ä¸€å®šçš„æ™‚é–“, ç„¶å¾ŒæŠŠç•¶å‰ä»»å‹™çš„ç‹€æ…‹ä¿å­˜ä¸‹ä¾†, åœ¨è¼‰å…¥ä¸‹ä¸€ä»»å‹™çš„ç‹€æ…‹å¾Œ, ç¹¼çºŒæœå‹™ä¸‹ä¸€ä»»å‹™ã€‚ä»»å‹™çš„ç‹€æ…‹ä¿å­˜åŠå†è¼‰å…¥, é€™æ®µéç¨‹å°±å«åšä¸Šä¸‹æ–‡åˆ‡æ›ã€‚</p>
<p>æ™‚é–“ç‰‡è¼ªè½‰çš„æ–¹å¼ä½¿å¤šå€‹ä»»å‹™åœ¨åŒä¸€é¡†CPUä¸ŠåŸ·è¡Œè®Šæˆäº†å¯èƒ½, ä½†åŒæ™‚ä¹Ÿå¸¶ä¾†äº†ä¿å­˜ç¾å ´å’Œè¼‰å…¥ç¾å ´çš„ç›´æ¥æ¶ˆè€—ã€‚</p>
<p>ä¸Šä¸‹æ–‡åˆ‡æ›çš„æ€§èƒ½æ¶ˆè€—</p>
<p>Context Switchséé«˜ï¼Œå°è‡´CPUå°±åƒå€‹æ¬é‹å·¥ä¸€æ¨£ï¼Œé »ç¹åœ¨æš«å­˜å™¨(CPU Register)å’Œé‹è¡Œä½‡åˆ—(run queue)ä¹‹é–“å¥”æ³¢ï¼Œç³»çµ±æ›´å¤šçš„æ™‚é–“éƒ½èŠ±è²»ç·šä¸Šç¨‹åˆ‡æ›ä¸Šï¼Œè€Œä¸æ˜¯èŠ±åœ¨çœŸæ­£åšæœ‰ç”¨å·¥ä½œçš„åŸ·è¡Œç·’ä¸Šã€‚</p>
<p>ç›´æ¥æ¶ˆè€—åŒ…æ‹¬: CPUæš«å­˜å™¨éœ€è¦ä¿å­˜å’Œè¼‰å…¥, ç³»çµ±èª¿åº¦å™¨çš„ç¨‹å¼ç¢¼éœ€è¦åŸ·è¡Œ, TLBå¯¦ä¾‹éœ€è¦é‡æ–°è¼‰å…¥, CPU çš„pipelineéœ€è¦åˆ·æ‰ã€‚</p>
<p>é–“æ¥æ¶ˆè€—ï¼šå¤šæ ¸çš„cacheä¹‹é–“å¾—å…±äº«è³‡æ–™ã€‚é–“æ¥æ¶ˆè€—å°æ–¼ç¨‹åºçš„å½±éŸ¿è¦çœ‹åŸ·è¡Œç·’å·¥ä½œå€é‹ç®—å…ƒæ“šçš„å¤§å°ã€‚</p>
<p>æ€§èƒ½åˆ†ææŸ¥çœ‹Context Switchesçš„æ–¹æ³•</p>
<p>Linuxä¸­å¯ä»¥é€šéå·¥å…·vmstat, dstat, pidstatä¾†è§€å¯ŸCSçš„åˆ‡æ›æƒ…æ³ã€‚vmstat, dstatåªèƒ½è§€å¯Ÿæ•´å€‹ç³»çµ±çš„åˆ‡æ›æƒ…æ³ï¼Œè€Œpidstatå¯ä»¥æ›´ç²¾ç¢ºåœ°è§€å¯ŸæŸå€‹è™•ç†ç¨‹åºçš„ä¸Šä¸‹æ–‡åˆ‡æ›æƒ…æ³ã€‚</p>
<p>æœ€å¸¸è¦‹çš„ï¼Œåœ¨ä¸€äº›<a href="https://zh.wikipedia.org/wiki/%E6%8E%92%E7%A8%8B">æ’ç¨‹</a>ï¼ˆschedulingï¼‰<a href="https://zh.wikipedia.org/wiki/%E7%AE%97%E6%B3%95">æ¼”ç®—æ³•</a>å…§ï¼Œå…¶ä¸­è¡Œç¨‹æœ‰æ™‚å€™éœ€è¦æš«æ™‚é›¢é–‹CPUï¼Œè®“å¦ä¸€å€‹è¡Œç¨‹é€²ä¾†CPUé‹ä½œã€‚åœ¨å…ˆä½”å¼å¤šå·¥ç³»çµ±ä¸­ï¼Œæ¯ä¸€å€‹è¡Œç¨‹éƒ½å°‡è¼ªæµåŸ·è¡Œä¸å®šé•·åº¦çš„æ™‚é–“ï¼Œé€™äº›æ™‚é–“æ®µè½ç¨±ç‚º<a href="https://zh.wikipedia.org/wiki/%E6%99%82%E9%96%93%E7%89%87">æ™‚é–“ç‰‡</a>ã€‚å¦‚æœè¡Œç¨‹ä¸¦éè‡ªé¡˜è®“å‡ºCPU(ä¾‹å¦‚åŸ·è¡Œ<a href="https://zh.wikipedia.org/wiki/I/O">I/O</a>æ“ä½œæ™‚ï¼Œè¡Œç¨‹å°±éœ€æ”¾æ£„CPUä½¿ç”¨æ¬Š)ï¼Œç•¶æ™‚é™åˆ°æ™‚ï¼Œç³»çµ±å°‡ç”¢ç”Ÿä¸€å€‹å®šæ™‚ä¸­æ–·ï¼Œ<a href="https://zh.wikipedia.org/wiki/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%B5%B1">ä½œæ¥­ç³»çµ±</a>å°‡æ’å®šç”±å…¶å®ƒçš„è¡Œç¨‹ä¾†åŸ·è¡Œã€‚æ­¤æ©Ÿåˆ¶ç”¨ä»¥ç¢ºä¿CPUä¸è‡´è¢«è¼ƒä¾è³´è™•ç†å™¨<a href="https://zh.wikipedia.org/wiki/%E9%81%8B%E7%AE%97">é‹ç®—</a>çš„è¡Œç¨‹å£Ÿæ–·ã€‚è‹¥ç„¡å®šæ™‚ä¸­æ–·ï¼Œé™¤éè¡Œç¨‹è‡ªé¡˜è®“å‡ºCPUï¼Œå¦å‰‡è©²è¡Œç¨‹å°‡æŒçºŒåŸ·è¡Œã€‚å°æ–¼æ“æœ‰è¼ƒå¤šI/O<a href="https://zh.wikipedia.org/wiki/%E6%8C%87%E4%BB%A4">æŒ‡ä»¤</a>çš„è¡Œç¨‹ï¼Œå¾€å¾€åŸ·è¡Œä¸äº†å¤šä¹…ï¼Œä¾¿éœ€è¦è®“å‡ºCPUï¼›è€Œè¼ƒä¾è³´è™•ç†å™¨çš„è¡Œç¨‹ç›¸å°è€Œè¨€I/Oæ“ä½œè¼ƒå°‘ï¼Œåè€Œèƒ½ä¸€ç›´æŒçºŒä½¿ç”¨CPUï¼Œä¾¿å½¢æˆäº†<a href="https://zh.wikipedia.org/wiki/%E7%8D%A8%E4%BD%94">å£Ÿæ–·</a>ç¾è±¡ã€‚</p>
<hr />
<h2 id="åœ¨-linux-ä¸Šä½¿ç”¨-perf-åšæ•ˆèƒ½åˆ†æå…¥é–€ç¯‡"><a class="header" href="#åœ¨-linux-ä¸Šä½¿ç”¨-perf-åšæ•ˆèƒ½åˆ†æå…¥é–€ç¯‡">åœ¨ Linux ä¸Šä½¿ç”¨ Perf åšæ•ˆèƒ½åˆ†æ(å…¥é–€ç¯‡)</a></h2>
<h2 id="ç°¡ä»‹-1"><a class="header" href="#ç°¡ä»‹-1">ç°¡ä»‹</a></h2>
<p>é€éæ•ˆèƒ½åˆ†æå·¥å…· (Profiler)ï¼Œæˆ‘å€‘å¯ä»¥å¾—çŸ¥æ›´å¤šé—œæ–¼è»Ÿé«”çš„é‹è¡Œè³‡è¨Šï¼Œåƒæ˜¯èŠ±äº†å¤šå°‘è¨˜æ†¶é«”ã€å¤šå°‘ CPU Cyclesã€å¤šå°‘ Cache Missesã€I/O è™•ç†æ™‚é–“ç­‰ç­‰ï¼Œé€™äº›è³‡è¨Šå°æˆ‘å€‘å»æ‰¾åˆ°ç¨‹å¼æ•ˆèƒ½ç“¶é ¸å¾ˆæœ‰å¹«åŠ©ã€‚æƒ³è¾¦æ³•æ‰¾åˆ°é‚£è£¡è®“ç¨‹å¼è®Šæ…¢ï¼Œé€²è€Œæœ€å¤§åŒ–æ•ˆèƒ½ï¼Œä¾¿æ˜¯æˆ‘å€‘åšæ•ˆèƒ½åˆ†æçš„æœ€å¤§ç›®çš„ã€‚</p>
<p>æœ¬æ–‡å°‡ä»‹ç´¹ Linux ä¸Šçš„ <a href="http://www.brendangregg.com/perf.html">perf</a> æ•ˆèƒ½åˆ†æå·¥å…·ï¼Œè—‰ç”±ä¸€å€‹ç°¡å–®çš„ç¨‹å¼ç¯„ä¾‹ï¼Œç¤ºç¯„å¦‚ä½•ä½¿ç”¨ perf å»åˆ†æä¸€éš»ç¨‹å¼ï¼Œæˆ‘å€‘å°‡æœƒç™¼ç¾ä½¿ç”¨åˆ†æå·¥å…·æ™‚èƒ½æ›´è¼•æ˜“çš„ç™¼ç¾å•é¡Œæ ¹æºã€‚æœ¬æ–‡åƒè€ƒ Gabriel Krisman Bertaz å¯«çš„ <a href="https://www.collabora.com/news-and-blog/blog/2017/03/21/performance-analysis-in-linux/">Performance analysis in Linux</a>ã€‚</p>
<p>æœ¬æ–‡å¯ä»¥æ­é…æˆ‘çš„æ•™å­¸å½±ç‰‡ï¼š</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Mba2ONCA0kI" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="" style="color: rgb(119, 119, 119); font-family: &quot;Times New Roman&quot;; font-size: 19.2px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;"></iframe>
<h2 id="ä¸€å€‹-branch-prediction-çš„ç¯„ä¾‹"><a class="header" href="#ä¸€å€‹-branch-prediction-çš„ç¯„ä¾‹">ä¸€å€‹ Branch Prediction çš„ç¯„ä¾‹</a></h2>
<p>Stack Overflow ä¸Šæœ‰ä¸€å€‹å¾ˆç«çš„å•é¡Œã€Œ<a href="https://stackoverflow.com/questions/11227809/">Why is processing a sorted array faster than processing an unsorted array?</a>ã€ã€‚</p>
<p>å•é¡Œçš„ Code å¦‚ä¸‹ï¼š</p>
<p><code>test.cc</code>ï¼š</p>
<pre><code class="language-c++">#include &lt;algorithm&gt;
#include &lt;ctime&gt;
#include &lt;iostream&gt;

int main()
{
    // æ¸¬è©¦ç”¨é™£åˆ—
    const int arr_len = 32768;
    int data[arr_len];

    for (int c = 0; c &lt; arr_len; ++c)
        data[c] = std::rand() % 256;

    // std::sort(data, data + arr_len); // æ˜¯å¦æ’åº
    
    long long sum = 0;

    for (int i = 0; i &lt; 30000; ++i)
    {
        for (int c = 0; c &lt; arr_len; ++c)
        {
            if (data[c] &gt;= 128) { // æ•…æ„é¸ 256 ä¸€åŠ  
                sum += data[c];
            }
        }
    }

    std::cout &lt;&lt; "sum = " &lt;&lt; sum &lt;&lt; std::endl;
}
</code></pre>
<p>é¦–å…ˆæˆ‘å€‘å…ˆç·¨è­¯æœªæ’åºç‰ˆæœ¬ï¼š</p>
<pre><code class="language-shell">$ g++ test.cc -o unsort
</code></pre>
<p>æ¥è‘—æˆ‘å€‘æŠŠ <code>sort</code> é‚£è¡Œå–æ¶ˆè¨»è§£ï¼Œå†ç·¨è­¯ä¸€æ¬¡ï¼š</p>
<pre><code class="language-shell">$ g++ test.cc -o sort
</code></pre>
<p>å…ˆä¾†çœ‹çœ‹åŸ·è¡Œæ™‚é–“ï¼š</p>
<pre><code class="language-shell">$ time ./unsort
real    0m5.671s

$ time ./sort
real    0m1.932s
</code></pre>
<p>å•é¡Œå¤§æ„æ˜¯èªª <code>data</code> å¦‚æœæ’åˆ—éå¾Œï¼Œä¸Šé¢é€™æ®µç¨‹å¼ç¢¼åè€Œæ›´å¿«ï¼Œå¦‚åŒæˆ‘å€‘å¯¦é©—çµæœã€‚æˆ‘å€‘çŸ¥é“æ’åºçš„è¤‡é›œåº¦æ˜¯ O(NlogN)ï¿½(ï¿½ï¿½ï¿½ï¿½ï¿½)ï¼Œæ‰€ä»¥æ‡‰è©²æœƒæ¯”æ²’æ’ç›´æ¥è·‘çš„ O(N)ï¿½(ï¿½) é‚„æ…¢ï¼Œä½†çµæœæ˜¯æ’åºå¾Œåè€Œæ›´å¿«ã€‚</p>
<p>å°±çµè«–ä¾†èªªï¼Œæˆ‘å€‘çŸ¥é“é€™å€‹çµæœæ˜¯å› ç‚º CPU æœƒåš <strong>Branch Prediction</strong>ã€‚ç™½è©±ä¾†èªªå°±æ˜¯ä¸Šæ¬¡å¦‚æœ <code>if</code> æ˜¯ <code>true</code>ï¼Œä¸‹æ¬¡å°±å…ˆçŒœä¹Ÿæ˜¯ <code>true</code>ï¼ŒCPU å¯ä»¥è—‰ç”±å…ˆçŒœä¾†å·è·‘ï¼ŒçŒœå°äº†çš„è©±å°±å¯ä»¥è·‘æ›´å¿«ï¼›ä½†ç›¸å°çš„çŒœéŒ¯çš„è©±å·è·‘çš„æ±è¥¿é€šé€šè¦ä¸Ÿæ‰ï¼Œåè€Œæ›´æµªè²»æ™‚é–“ï¼Œç¨±ç‚º Branch Miss(è©³ç´°åŸç†å¯ä»¥åƒè€ƒã€Œè¨ˆç®—æ©Ÿçµ„ç¹”ã€)ã€‚æ‰€ä»¥ Branch Prediction ç®—æ˜¯ä¸€ç¨®é›™é¢åˆƒï¼Œå¦‚æœå¯ä»¥ä¸€ç›´è®“æ¢ä»¶åˆ¤æ–·æœ‰ç›¸åŒçµæœå°±å¯ä»¥é€²è€ŒåŠ é€Ÿç¨‹å¼ï¼Œåä¹‹åˆ¤æ–·ä¸€ç›´åè¦†ä¸å®šå°±æœƒå°è‡´ä¸€ç›´ã€ŒçŒœæ¸¬ã€éŒ¯èª¤è€Œè®Šæ…¢ï¼Œå› æ­¤åœ¨ä¸Šé¢ç¨‹å¼ç¢¼ä¸­æ’åˆ—éçš„ç‰ˆæœ¬åè€Œæ¯”è¼ƒå¿«ï¼Œå› ç‚ºçŒœæ¸¬éŒ¯èª¤åªæœƒç™¼ç”Ÿä¸€æ¬¡ï¼Œå°±æ˜¯åœ¨ <code>data</code> å‰›å¥½åœ¨ <code>128</code> é™„è¿‘çš„ä½ç½®ï¼Œåœ¨é‚£ä¹‹å‰å…¨éƒ¨æœƒæ˜¯ <code>false</code>ï¼Œè€Œå¾Œéƒ½æœƒæ˜¯ <code>true</code>ã€‚</p>
<h2 id="perf-æ•ˆèƒ½åˆ†æå·¥å…·"><a class="header" href="#perf-æ•ˆèƒ½åˆ†æå·¥å…·">Perf æ•ˆèƒ½åˆ†æå·¥å…·</a></h2>
<p>æƒ³è¦æ‰¾åˆ°ä¸€æ®µç¨‹å¼ç¢¼çš„å•é¡Œé€šå¸¸ä¸å®¹æ˜“ï¼Œå°±ä»¥ä¸Šé¢çš„ç¨‹å¼ç¯„ä¾‹ä¾†èªªï¼Œå‡è¨­æˆ‘å€‘æœæ¼”ç®—æ³•å»åˆ†æå°±æœƒèµ°éŒ¯è·¯ï¼Œå¯¦éš›å•é¡Œå…¶å¯¦åœ¨è¨ˆç®—æ©Ÿçµ„ç¹”çš„åŸç†ã€‚å…‰æ˜¯ä¸€æ®µç°¡å–®çš„ç¨‹å¼ç¢¼å°±è®“æˆ‘å€‘å¯èƒ½æ‰¾ä¸åˆ°åŸå› ï¼Œæ›´ç”­èªªç¢°åˆ°ä¸€å€‹å¤§çš„ç¨‹å¼ï¼Œè£¡é¢æœ‰å„ç¨®å•é¡Œå­˜åœ¨ï¼Œå¯èƒ½æ˜¯æ¼”ç®—æ³•ã€è¨˜æ†¶é«”å¿«å–ã€CPU æŒ‡ä»¤ã€ç¶²è·¯é€£ç·šã€I/O ç­‰ç­‰ï¼Œé€™æ™‚æˆ‘å€‘éœ€è¦ä¸€å€‹åˆ†æç¨‹å¼ä¾†å¹«åŠ©æˆ‘å€‘ã€‚</p>
<p>Linux ä¸Šå…¶å¯¦æœ‰å¾ˆå¤šå·¥å…·å¯ä»¥ä½¿ç”¨ï¼š</p>
<p><img src="images/91632981-533ee680-ea17-11ea-90f8-06676583ea52.png" alt="Linux åˆ†æå·¥å…·" /></p>
<p>ä¸éæœ¬æ–‡å°‡é‡å° perf åšä»‹ç´¹ï¼Œä¸¦ç”¨ä¸Šé¢ç¨‹å¼ä¾†ç¤ºç¯„å‡è¨­æˆ‘å€‘é‚„ä¸çŸ¥é“å•é¡Œæ˜¯å› ç‚º Branch Missï¼Œå¦‚ä½•ç”¨ perf æ‰¾åˆ°å•é¡Œã€‚</p>
<p>ä½ å¯ä»¥ç”¨ä¸‹é¢æŒ‡ä»¤åœ¨ Ubuntu ä¸Šè£ perfï¼š</p>
<pre><code class="language-shell">$ sudo apt install linux-tools-$(uname -r) linux-tools-generic
</code></pre>
<p>æˆ–æ˜¯ä½ ä¹Ÿå¯ä»¥è€ƒæ…®è‡ªå·±å¾ Linux Kernel ç·¨è­¯ perf ä¾†ç”¨ï¼š</p>
<pre><code class="language-shell">$ sudo apt install flex bison libelf-dev libunwind-dev libaudit-dev libslang2-dev libdw-dev
$ git clone https://github.com/torvalds/linux --depth=1
$ cd linux/tools/perf/
$ make
$ make install
$ sudo cp perf /usr/bin
$ perf
</code></pre>
<p>å®‰è£å®Œ perf å¾Œï¼Œä½ å¯èƒ½æœƒéœ€è¦è¨­å®šç³»çµ±æ¬Šé™ï¼Œé è¨­æ‡‰è©²æœƒä½¿ perf æ¬Šé™ä¸è¶³ï¼š</p>
<pre><code class="language-shell">$ sudo su # As Root
$ sysctl -w kernel.perf_event_paranoid=-1
$ echo 0 &gt; /proc/sys/kernel/kptr_restrict
$ exit
</code></pre>
<h2 id="ä½¿ç”¨-perf"><a class="header" href="#ä½¿ç”¨-perf">ä½¿ç”¨ perf</a></h2>
<p>æ¥è‘—æˆ‘å€‘è¦æ¸¬è©¦çš„ç¨‹å¼ï¼Œç‚ºäº†è®“ perf èƒ½ç”¨ï¼Œæˆ‘å€‘è¦åŠ ä¸Š <code>-g3</code> åƒæ•¸é–‹å•Ÿé™¤éŒ¯æ¨¡å¼ã€‚</p>
<p>ä¸€æ¨£æ˜¯ç·¨è­¯ <code>test.cc</code>ï¼Œé¦–å…ˆæ˜¯æ²’æ’åºï¼š</p>
<pre><code class="language-shell">$ g++ test.cc -g3 -o unsort
</code></pre>
<p>æ¥è‘—æ˜¯ç·¨è­¯æœ‰æ’åºç‰ˆæœ¬ï¼š</p>
<pre><code class="language-shell">$ g++ test.cc -g3 -o sort
</code></pre>
<h3 id="perf-record"><a class="header" href="#perf-record">Perf Record</a></h3>
<p>æˆ‘å€‘ç¾åœ¨æƒ³è¦çŸ¥é“ç‚ºç”šéº¼ <code>./unsort</code> è·‘å¾—æ¯”è¼ƒæ…¢ï¼Œæˆ‘å€‘å¯ä»¥é€é <code>perf record</code> ä¾†è¨˜éŒ„ç¨‹å¼åŸ·è¡Œçš„è³‡è¨Šã€‚</p>
<pre><code class="language-shell">$ perf record ./unsort
</code></pre>
<p>é€™æ¨£ perf æœƒå°‡ <code>./unsort</code> è·‘çš„è³‡æ–™è¨˜éŒ„åœ¨ <code>perf.data</code> ä¸­ï¼Œperf å…¶ä»–æŒ‡ä»¤å¯ä»¥ç”¨ä¾†è®€å–é€™å€‹ç´€éŒ„æª”ã€‚</p>
<h3 id="perf-annotate"><a class="header" href="#perf-annotate">Perf Annotate</a></h3>
<p>æˆ‘å€‘å¯ä»¥ç”¨ <code>perf annotate</code> ä¾†çœ‹çµæœï¼š</p>
<pre><code class="language-shell">$ perf annotate
</code></pre>
<p><img src="images/91634468-44f6c780-ea23-11ea-9bf5-cd14907e22e8.png" alt="perf annotate" /></p>
<p>perf æœƒè‡ªå‹•è·³åˆ°èŠ±è²»æ¯”è¼ƒå¤šçš„å€å¡Šï¼Œå¦‚ä¸Šåœ–æ‰€ç¤ºï¼Œå·¦é‚Šæ˜¯åŸ·è¡Œæ™‚é–“æ¯”ä¾‹ï¼Œå³é‚Šæ˜¯ç¨‹å¼ç¢¼å°ç…§çš„ Assembly Codeã€‚ä½ å¯ä»¥ç”¨ä¸Šä¸‹æ–¹å‘éµç§»å‹•ï¼Œæˆ–ç”¨ <code>h</code> ä¾†çœ‹æ“ä½œèªªæ˜ã€‚</p>
<p>å…¶å¯¦å¾é€™å€‹ Assembly æ™‚é–“æ¯”ä¾‹å°±å¯ä»¥çœ‹å‡ºç«¯å€ªï¼Œé€šå¸¸æˆ‘å€‘æœƒå»çœ‹å“ªé‚ŠèŠ±æœ€å¤šæ™‚é–“ï¼Œç„¶å¾Œå»ç ”ç©¶èƒŒå¾ŒåŸå› ã€‚é€™é‚Šçš„é—œéµæ˜¯ <code>d8</code> å’Œ <code>cf</code> é€™å…©è¡Œï¼Œ<code>addl</code> å…¶å¯¦å°±æ˜¯åœ¨åš <code>sum += data[c]</code>ï¼Œæ‰€ä»¥é€™å…©è¡Œåˆ†åˆ¥ä»£è¡¨ Branch Prediction çŒœå°å’ŒçŒœéŒ¯çš„è·¯å¾‘ã€‚</p>
<p>é€™å¼µåœ–ã€Œç®­é ­ã€æ¨™è¨»çš„æ˜¯ Branch Prediction <strong>çŒœå°</strong>çš„è·¯å¾‘ï¼Œå¯ä»¥çœ‹åˆ° <code>d8</code> è¡Œä½”æ¯”å¹¾ä¹æ˜¯ 0.0%ã€‚
<img src="images/91635364-93f42b00-ea2a-11ea-89b8-19075dbc67fc.png" alt="branch prediction çŒœå°" /></p>
<p>é€™å¼µåœ–ã€Œç®­é ­ã€æ¨™è¨»çš„æ˜¯ Branch Prediction <strong>çŒœéŒ¯</strong>çš„è·¯å¾‘ï¼Œå¯ä»¥çœ‹åˆ° <code>cf</code> è¡Œä½”æ¯”å¹¾ä¹æ˜¯ 27.7%ã€‚
<img src="images/91635373-9eaec000-ea2a-11ea-8347-1f2386373a57.png" alt="branch prediction çŒœéŒ¯" /></p>
<p>æ‰€ä»¥å…¶å¯¦å°±å¯ä»¥ç™¼ç¾æ•´éš»ç¨‹å¼å› ç‚º Branch Misses æµªè²»å¾ˆå¤šæ™‚é–“ã€‚</p>
<p>é€™é‚Šæˆ‘å€‘å¯ä»¥å·å·çœ‹ä¸€ä¸‹ <code>./sort</code> çš„çµæœï¼š</p>
<pre><code class="language-shell">$ perf record ./sort &amp;&amp; perf annotate
</code></pre>
<p><img src="images/91636294-01578a00-ea32-11ea-888d-d46b2b65163c.png" alt="sort version&#39;s branch prediction" /></p>
<p>å› ç‚ºä¸æœƒæœ‰ Branch Missï¼Œå¯ä»¥è§€å¯Ÿåˆ° <code>ee</code> å’Œ <code>f7</code> çš„ <code>addl</code> åŸºæœ¬ä¸Šæ²’ä½”å¤šå°‘æ™‚é–“ã€‚</p>
<h3 id="perf-stat-1"><a class="header" href="#perf-stat-1">Perf Stat</a></h3>
<p>ç›´æ¥çœ‹ Assembly å…¶å¯¦æ»¿èŠ±æ™‚é–“çš„ï¼Œå¦‚æœæƒ³è¦ç›´æ¥ã€ŒæŒæ¡å¤§å±€ã€ï¼Œå¯ä»¥è€ƒæ…®ç”¨ <code>perf stat</code>ã€‚</p>
<pre><code class="language-shell"># æœªæ’åºç‰ˆæœ¬
$ perf stat ./unsort
sum = 94479480000

 Performance counter stats for './unsort':

          5,671.51 msec task-clock                #    1.000 CPUs utilized
                24      context-switches          #    0.004 K/sec
                 0      cpu-migrations            #    0.000 K/sec
               147      page-faults               #    0.026 K/sec
    20,366,870,320      cycles                    #    3.591 GHz
    11,328,534,095      instructions              #    0.56  insn per cycle
     2,951,455,487      branches                  #  520.401 M/sec
       467,676,925      branch-misses             #   15.85% of all branches

       5.671777216 seconds time elapsed

       5.671781000 seconds user
       0.000000000 seconds sys

# æ’åºç‰ˆæœ¬
$ perf stat ./sort
sum = 94479480000

 Performance counter stats for './sort':

          1,927.09 msec task-clock                #    1.000 CPUs utilized
                 6      context-switches          #    0.003 K/sec
                 0      cpu-migrations            #    0.000 K/sec
               146      page-faults               #    0.076 K/sec
     6,917,745,957      cycles                    #    3.590 GHz
    11,345,543,927      instructions              #    1.64  insn per cycle
     2,954,388,946      branches                  # 1533.084 M/sec
           268,192      branch-misses             #    0.01% of all branches

       1.927654198 seconds time elapsed

       1.927349000 seconds user
       0.000000000 seconds sys
</code></pre>
<p><code>perf stat</code> å¯ä»¥ç›´æ¥çœ‹åˆ°çµ±è¨ˆè³‡æ–™ï¼Œå¦‚æœæœ‰å¾ˆé«˜çš„ Context Switchã€Page Faultã€Branch Miss éƒ½ä»£è¡¨ç¨‹å¼æœ¬èº«æ•ˆèƒ½æœ‰å¾…å„ªåŒ–ã€‚</p>
<p>ä»¥ <code>unsort</code> ç‚ºä¾‹å¯ä»¥çœ‹åˆ° Branch Miss ç‰¹åˆ¥é«˜ (æ’åºç‰ˆæœ¬æœƒå¹¾ä¹æ˜¯ 0)ï¼Œé€™æ™‚æˆ‘å€‘å°±å¯ä»¥å»çœ‹åŸæœ¬çš„ç¨‹å¼å“ªé‚Šæœ‰æ¢ä»¶åˆ¤æ–·ï¼Œç„¶å¾Œæ ¹æ“š Annotate çš„æ™‚é–“æ¯”ä¾‹ï¼Œå°±å¯ä»¥å¿«é€Ÿæ‰¾åˆ°å•é¡Œé»ã€‚å¦å¤–å¾ Cycle ä¸Šæˆ‘å€‘ä¹Ÿå¯ä»¥ç™¼ç¾å…©å€‹ç‰ˆæœ¬å·®äº†ä¸‰å€ä¹‹å¤šã€‚</p>
<blockquote>
<p>æ›´å¤š perf çš„ç”¨æ³•å¯ä»¥åƒè€ƒ Brendan Gregg çš„ã€Œ<a href="http://www.brendangregg.com/perf.html">perf Examples</a>ã€ã€‚å¦å¤–é€™å€‹ HackMD çš„<a href="https://hackmd.io/@1IzBzEXXRsmj6-nLXZ9opw/HkBl5kCSU">ç­†è¨˜</a>ä¹ŸæŒºä¸éŒ¯çš„ã€‚</p>
</blockquote>
<h2 id="çµè«–"><a class="header" href="#çµè«–">çµè«–</a></h2>
<p>æœ¬æ–‡ä»‹ç´¹ perf çš„ç°¡å–®ç”¨æ³•ï¼Œç”¨ç°¡å–®çš„ç¯„ä¾‹ç¨‹å¼ç¤ºç¯„å¦‚ä½•å»è§€å¯Ÿæ•ˆèƒ½ä¸¦æ‰¾å‡ºå¯èƒ½çš„å•é¡ŒåŸå› ã€‚</p>
<p>æˆ‘å€‘å¸¸å¸¸å› ç‚ºç¨‹å¼æ•ˆèƒ½ä¸ä½³è€Œéœ€è¦åˆ†ææ•ˆèƒ½ï¼Œä½†æ‰¾åˆ°å•é¡Œçš„éç¨‹å¾€å¾€ä¸å®¹æ˜“ï¼Œä¸€æ®µç¨‹å¼ç¢¼æ•ˆèƒ½ä¸ä½³å¯èƒ½æ˜¯æ¼”ç®—æ³•èˆ‡è³‡æ–™çµæ§‹çš„å•é¡Œï¼Œå¯èƒ½æ˜¯ä½œæ¥­ç³»çµ± System Call å°è‡´ï¼Œä¹Ÿå¯èƒ½æ˜¯å› ç‚ºè™•ç†å™¨æ¶æ§‹çš„é—œä¿‚ã€‚å¦‚åŒæœ¬æ–‡çš„ç¨‹å¼ç¯„ä¾‹ï¼Œèªªæ˜ç­æ¼”ç®—æ³•çš„è¤‡é›œåº¦ä¸ä»£è¡¨çœŸå¯¦è·‘å‡ºä¾†çš„é€Ÿåº¦ï¼Œå¾€å¾€é‚„éœ€è¦å»è€ƒæ…®ä½œæ¥­ç³»çµ±æˆ–æ˜¯ç¡¬é«”æ¶æ§‹ã€‚å–„ç”¨æ•ˆèƒ½åˆ†æå·¥å…·æ‰èƒ½è®“æˆ‘å€‘æ›´å¿«æ‰¾åˆ°å•é¡Œé»ã€‚</p>

                        <script src="https://utteranc.es/client.js"
                            repo="imxood/imxood.github.io"
                            issue-term="pathname"
                            theme="boxy-light"
                            crossorigin="anonymous"
                            async>
                        </script>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../linux_system/cgroup.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../linux_system/è‡ªè£½Lib.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../linux_system/cgroup.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../linux_system/è‡ªè£½Lib.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script type="text/javascript">
            window.playground_line_numbers = true;
        </script>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>

        <script src="../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../theme/custom/mermaid.min.js"></script>
        <script type="text/javascript" src="../theme/custom/mermaid-init.js"></script>


    </body>
</html>
