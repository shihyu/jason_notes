<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Finlab - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/custom/custom.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html">Jason Notes</a></li><li class="chapter-item expanded "><a href="ubuntu/ubuntu_setup.html">Ubuntu</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ubuntu/command.html">Command</a></li><li class="chapter-item "><a href="ubuntu/gcp.html">GCP ssh</a></li><li class="chapter-item "><a href="ubuntu/wine.html">Wine</a></li></ol></li><li class="chapter-item expanded "><a href="android/android.html">Android</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="android/install_sdk.html">SDK install</a></li><li class="chapter-item "><a href="android/flutter.html">Flutter</a></li></ol></li><li class="chapter-item expanded "><a href="tools/tools.html">Tools</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="tools/asciinema.html">asciinema æŠŠçµ‚ç«¯æ“ä½œéŒ„è£½æˆ gif å‹•ç•«</a></li><li class="chapter-item "><a href="tools/finmind.html">Finmind</a></li><li class="chapter-item "><a href="tools/add-enter-and-exit-trace-for-your-function.html">addr2line</a></li><li class="chapter-item "><a href="tools/cmake.html">cmake</a></li><li class="chapter-item "><a href="tools/network.html">Network</a></li><li class="chapter-item "><a href="tools/python-pycryptodome-aes-symmetric-encryption-tutorial-examples.html">å¯¦ä½œ AES å°ç¨±å¼åŠ å¯†</a></li></ol></li><li class="chapter-item expanded "><a href="html/html.html">HTML</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="html/vue.html">Vue</a></li></ol></li><li class="chapter-item expanded "><a href="vim/vim.html">Vim</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="vim/copilot.html">copilot</a></li><li class="chapter-item "><a href="vim/tabnine.html">tabnine</a></li></ol></li><li class="chapter-item expanded "><a href="gdb/gdb.html">Gdb</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="gdb/å¸¸ç”¨æŒ‡ä»¤.html">å¸¸ç”¨æŒ‡ä»¤</a></li><li class="chapter-item "><a href="gdb/jemalloc.html">jemalloc</a></li><li class="chapter-item "><a href="gdb/graphs.html">graphs</a></li><li class="chapter-item "><a href="gdb/rust-gdb.html">rust gdb</a></li><li class="chapter-item "><a href="gdb/qemu-gdb-risc-v64.html">qemu-gdb-risc-v64-kernel</a></li><li class="chapter-item "><a href="gdb/go-rust-gdb-debug.html">ä½¿ç”¨gdb è¿½è¹¤go/rustç¨‹å¼ç¢¼</a></li><li class="chapter-item "><a href="gdb/gdb-function-trace-to-flowchart-guide.html">GDBå‡½æ•¸èª¿ç”¨è»Œè·¡åˆ†æèˆ‡æµç¨‹åœ–ç”Ÿæˆå®Œæ•´æŒ‡å—</a></li></ol></li><li class="chapter-item expanded "><a href="c++/cpp.html">C++</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="c++/benchmark.html">benchmark</a></li><li class="chapter-item "><a href="c++/ä¹˜ä»¥0.01å’Œé™¤ä»¥100å“ªå€‹å¿«.html">ä¹˜ä»¥ 0.01 å’Œé™¤ä»¥ 100 å“ªå€‹å¿«</a></li><li class="chapter-item "><a href="c++/smart_pointer.html">Smart pointer</a></li><li class="chapter-item "><a href="c++/l&rvalue.html">L&amp;R value</a></li><li class="chapter-item "><a href="c++/move.html">Move</a></li><li class="chapter-item "><a href="c++/CAS.html">CAS</a></li><li class="chapter-item "><a href="c++/HFT.html">HFT</a></li><li class="chapter-item "><a href="c++/cpp_note.html">Note</a></li><li class="chapter-item "><a href="c++/é«˜æ€§èƒ½ç¨‹å¼è¨­è¨ˆå¯¦æˆ°.html">é«˜æ€§èƒ½ç¨‹å¼è¨­è¨ˆå¯¦æˆ°</a></li><li class="chapter-item "><a href="c++/å¦‚ä½•é«˜æ•ˆåœ°å„²å­˜ä¸¦æ“ä½œè¶…å¤§è¦æ¨¡.html">å¦‚ä½•é«˜æ•ˆåœ°å„²å­˜ä¸¦æ“ä½œè¶…å¤§è¦æ¨¡</a></li><li class="chapter-item "><a href="c++/UC_CAPITAL.html">UC_CAPITAL</a></li><li class="chapter-item "><a href="c++/cpp-smart-pointers-guide.html">unique_ptr vs shared_ptr</a></li><li class="chapter-item "><a href="c++/cpp-move-semantics-guide.html">C++ Move èªæ„å®Œæ•´æŒ‡å—</a></li><li class="chapter-item "><a href="c++/interview.html">interview</a></li></ol></li><li class="chapter-item expanded "><a href="mojo/mojo.html">Mojo</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="mojo/mojo_crawler_guide.html">Mojo çˆ¬èŸ²å®Œæ•´æŒ‡å—</a></li></ol></li><li class="chapter-item expanded "><a href="riscv/riscv.html">RISC-V</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="riscv/qemu_riscv_linux.html">QEMUä¸Šé‹è¡ŒRISV-V Linux</a></li><li class="chapter-item "><a href="riscv/qemi_gdb.html">QEMU GDB</a></li><li class="chapter-item "><a href="riscv/qemu_gdb_lab.html">Qemu Gdb Lab</a></li></ol></li><li class="chapter-item expanded "><a href="centos/centos.html">CentOS</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="centos/tqdb_setup.html">TQDB å®‰è£ç´€éŒ„</a></li></ol></li><li class="chapter-item expanded "><a href="ssh/ssh.html">SSH</a></li><li class="chapter-item expanded "><a href="network/socket.html">Network</a></li><li class="chapter-item expanded "><a href="docker/docker_helloworld.html">Docker</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="docker/docker.html">Docker åŸºæœ¬æ•™å­¸</a></li><li class="chapter-item "><a href="docker/example.html">ç°¡å–®ç¯„ä¾‹</a></li><li class="chapter-item "><a href="docker/creating-the-perfect-python-dockerfile.html">Perfect python dockerfile</a></li><li class="chapter-item "><a href="docker/dockerfile-from-docker-image.html">ç”± Docker image åæ¨å…¶ Dockerfile</a></li><li class="chapter-item "><a href="docker/python_connect_redis.html">Pythoné€£æ¥Redis</a></li><li class="chapter-item "><a href="docker/command.html">Command</a></li><li class="chapter-item "><a href="docker/docker_compose.html">Docker compose</a></li><li class="chapter-item "><a href="docker/docker_compse_example.html">Docker compose example</a></li><li class="chapter-item "><a href="docker/python_redis.html">Python-Redis</a></li><li class="chapter-item "><a href="docker/redash.html">Redash</a></li><li class="chapter-item "><a href="docker/clickhouse.html">ClickHouse</a></li><li class="chapter-item "><a href="docker/clickhouse-setup.html">clickhouse-setup</a></li><li class="chapter-item "><a href="docker/python_run_from_local.html">Docker run local</a></li><li class="chapter-item "><a href="docker/redpanda.html">Redpanda</a></li><li class="chapter-item "><a href="docker/gcc.html">é‹è¡Œæœ€æ–°ç‰ˆGCC</a></li></ol></li><li class="chapter-item expanded "><a href="rust/rust.html">Rust</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust/note.html">Rustç­†è¨˜</a></li><li class="chapter-item "><a href="rust/basic.html">Rust åŸºæœ¬æ•™å­¸</a></li><li class="chapter-item "><a href="rust/ownership.html">Rust æ‰€æœ‰æ¬Šç³»çµ±</a></li><li class="chapter-item "><a href="rust/lifetime.html">Rust ç”Ÿå‘½é€±æœŸ (Lifetime)</a></li><li class="chapter-item "><a href="rust/type.html">Rust å‹åˆ¥ç³»çµ±</a></li><li class="chapter-item "><a href="rust/rust_setup.html">Rust Tools</a></li><li class="chapter-item "><a href="rust/polars.html">Polars</a></li><li class="chapter-item "><a href="rust/rust_call_c.html">Rust call C</a></li><li class="chapter-item "><a href="rust/pyo3.html">PyO3</a></li><li class="chapter-item "><a href="rust/10-rust-an-introduction.html">çµ¦ C++ ä½¿ç”¨è€…çš„ Rust ç°¡ä»‹</a></li><li class="chapter-item "><a href="rust/å¯è¦–åŒ–Rustå„è³‡æ–™çµæ§‹çš„è¨˜æ†¶é«”ä½ˆå±€.html">å¯è¦–åŒ–Rustå„è³‡æ–™çµæ§‹çš„è¨˜æ†¶é«”ä½ˆå±€</a></li><li class="chapter-item "><a href="rust/rust_note.html">å­¸ç¿’é †åº</a></li><li class="chapter-item "><a href="rust/overview.html">å¤§å±€è§€</a></li><li class="chapter-item "><a href="rust/String.html">ç†è§£å­—ä¸²</a></li><li class="chapter-item "><a href="rust/easy_rust.html">Easy Rust</a></li><li class="chapter-item "><a href="rust/rust_easy.html">Rust æ–°æ‰‹</a></li><li class="chapter-item "><a href="rust/module.html">Rust æ¨¡çµ„çµæ§‹</a></li><li class="chapter-item "><a href="rust/rust_memory.html">Rustèˆ‡è¨˜æ†¶é«”</a></li><li class="chapter-item "><a href="rust/rust_vs_cpp.html">Rust vs C++èªæ³•</a></li><li class="chapter-item "><a href="rust/rust_file_format.html">Rust æª”æ¡ˆæ ¼å¼</a></li><li class="chapter-item "><a href="rust/rust-an-introduction-in-oop.html">Rust OO</a></li><li class="chapter-item "><a href="rust/rust-an-introduction-smart-pointer.html">Rust Pointer</a></li><li class="chapter-item "><a href="rust/pointer.html">Pointer</a></li><li class="chapter-item "><a href="rust/copy_trait.html">Copy Trait</a></li><li class="chapter-item "><a href="rust/binary_lib.html">Rust å‡½æ•¸åº«/åŸ·è¡Œæª”</a></li><li class="chapter-item "><a href="rust/reqwest.html">Reqwest</a></li><li class="chapter-item "><a href="rust/print-function-name-dump-stack.html">å°å‡ºå‡½æ•¸åç¨±</a></li><li class="chapter-item "><a href="rust/criterion.html">criterion</a></li><li class="chapter-item "><a href="rust/Rustçš„ç²¾é«“.html">Rustçš„ç²¾é«“</a></li><li class="chapter-item "><a href="rust/30å¤©æ·±å…¥æ·ºå‡ºRustç³»åˆ—.html">30å¤©æ·±å…¥æ·ºå‡ºRustç³»åˆ—</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust/30å¤©æ·±å…¥æ·ºå‡ºRustç³»åˆ—/rust_30_day.html">Rust 30 Day</a></li><li class="chapter-item "><a href="rust/30å¤©æ·±å…¥æ·ºå‡ºRustç³»åˆ—/Move_Borrow_Ownership.html">è®Šæ•¸çš„æ‰€æœ‰æ¬Šèˆ‡å€Ÿå‡ºè®Šæ•¸</a></li><li class="chapter-item "><a href="rust/30å¤©æ·±å…¥æ·ºå‡ºRustç³»åˆ—/Lifetime.html">Lifetimeï¼š Borrow çš„å­˜æ´»æ™‚é–“</a></li></ol></li><li class="chapter-item "><a href="rust/cpp_vs_rust_comparison.html">C++ vs. Rust: å…¨é¢ç‰¹æ€§æ¯”è¼ƒ</a></li><li class="chapter-item "><a href="rust/cpp-move-vs-rust-ownership.html">C++ Move èªç¾© vs Rust æ‰€æœ‰æ¬Šç³»çµ±çš„æ ¸å¿ƒå·®ç•°</a></li><li class="chapter-item "><a href="rust/Rust-RESTful-API-å®Œæ•´é–‹ç™¼æŒ‡å—.html">Rust-RESTful-API-å®Œæ•´é–‹ç™¼æŒ‡å—</a></li><li class="chapter-item "><a href="rust/Rust-self-Self-èˆ‡-C++-this-å°æ¯”æŒ‡å—.html">Rust-self-Self-èˆ‡-C++-this-å°æ¯”æŒ‡å—</a></li><li class="chapter-item "><a href="rust/rust-derive-traits-comparison.html">Rust Derive Traits æ¯”è¼ƒï¼šè‡ªå‹•ç”Ÿæˆ vs æ‰‹å‹•å¯¦ä½œ</a></li><li class="chapter-item "><a href="rust/rust_traits_explained.html">Rust Traits ç™½è©±è§£é‡‹ï¼šèˆ‡ C++ çš„æ¯”è¼ƒ</a></li><li class="chapter-item "><a href="rust/rust_trait_impl_markdown.html">Rust ä¸­ trait å’Œ impl çš„å·®ç•°</a></li><li class="chapter-item "><a href="rust/rust_cpp_comparison_md.html">Rust vs C++ è©³ç´°å°æ¯”æŒ‡å—</a></li><li class="chapter-item "><a href="rust/rust_module_system_markdown.html">Rust æ¨¡çµ„ç³»çµ±å®Œæ•´æŒ‡å—</a></li><li class="chapter-item "><a href="rust/ownership_vs_borrowing_guide.html">Rust æ“æœ‰æ¬Š vs å€Ÿç”¨ï¼šç”Ÿå‘½é€±æœŸå•é¡ŒæŒ‡å—ğŸ¦€</a></li><li class="chapter-item "><a href="rust/rust_ownership_guide.html">Rust æ‰€æœ‰æ¬Šç³»çµ± - ç”Ÿæ´»åŒ–è©³è§£</a></li><li class="chapter-item "><a href="rust/rust_ownership_complete_guide.html">Rust æ‰€æœ‰æ¬Šå®Œæ•´æŒ‡å— - å¾åŸºç¤åˆ°ç²¾é€š</a></li><li class="chapter-item "><a href="rust/rust_memory_guide.html">Rust è¨˜æ†¶é«”é…ç½®æŒ‡å—ï¼šStack vs Heap</a></li><li class="chapter-item "><a href="rust/rust_wrappers_guide.html">Rust è¨˜æ†¶é«”é…ç½®æŒ‡å—ï¼šStack vs Heap</a></li></ol></li><li class="chapter-item expanded "><a href="go/go.html">Go</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="go/note.html">Golang  Note</a></li><li class="chapter-item "><a href="go/pytago.html">pytago</a></li><li class="chapter-item "><a href="go/Goç·¨ç¨‹å¯¦æˆ°æ´¾åŸºç¤å…¥é–€.html">Goç·¨ç¨‹å¯¦æˆ°æ´¾åŸºç¤å…¥é–€</a></li><li class="chapter-item "><a href="go/Goç·¨ç¨‹å¯¦æˆ°æ´¾Webé–‹ç™¼åŸºç¤.html">Goç·¨ç¨‹å¯¦æˆ°æ´¾Webé–‹ç™¼åŸºç¤</a></li><li class="chapter-item "><a href="go/golang_debugger.html">Golang Deubgger</a></li><li class="chapter-item "><a href="go/golang-go-module-tutorial.html">å¾ä¸€çŸ¥åŠè§£åˆ°ç•¥æ‡‚ Go modules</a></li><li class="chapter-item "><a href="go/go_mod.html">Go modules</a></li><li class="chapter-item "><a href="go/trace.html">Golangå¤§æ®ºå™¨ä¹‹è·Ÿè¹¤å‰–ætrace</a></li><li class="chapter-item "><a href="go/Coroutine.html">è¡Œç¨‹ã€åŸ·è¡Œç·’ã€å”ç¨‹ï¼Œå‚»å‚»åˆ†å¾—æ¸…æ¥šï¼</a></li><li class="chapter-item "><a href="go/goroutine-and-channel.html">Goä½µç™¼</a></li><li class="chapter-item "><a href="go/websocket.html">Websocket</a></li><li class="chapter-item "><a href="go/returning-pointer-from-a-function-in-go.html">Returning Pointer from a Function in Go</a></li><li class="chapter-item "><a href="go/golang-memory-management.html">GC å…¨é¢è§£æ</a></li><li class="chapter-item "><a href="go/golang-goroutine.html">Goroutine èˆ‡ GMP åŸç†å…¨é¢åˆ†æ</a></li><li class="chapter-item "><a href="go/oo.html">OO</a></li><li class="chapter-item "><a href="go/mutex-rwmutex.html">sync.Mutex å’Œ sync.RWMutex</a></li><li class="chapter-item "><a href="go/interface.html">interface</a></li><li class="chapter-item "><a href="go/example.html">Example</a></li><li class="chapter-item "><a href="go/LiveKit.html">LiveKit</a></li></ol></li><li class="chapter-item expanded "><a href="ml/ml.html">ML</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ml/pytorch.html">Pytorch</a></li><li class="chapter-item "><a href="ml/pytorch_setup.html">Pytorch å®‰è£</a></li><li class="chapter-item "><a href="ml/deap.html">Deap</a></li><li class="chapter-item "><a href="ml/cudf.html">CUDF</a></li><li class="chapter-item "><a href="ml/åˆæ¢åŸºå› æ¼”ç®—æ³•.html">åˆæ¢åŸºå› æ¼”ç®—æ³•-ç”¨ OneMax å•é¡Œç¤ºç¯„</a></li><li class="chapter-item "><a href="ml/ç°¡å–®è§£é‡‹æ¢¯åº¦ä¸‹é™æ³•.html">ç°¡å–®è§£é‡‹æ¢¯åº¦ä¸‹é™æ³•</a></li><li class="chapter-item "><a href="ml/æ¢¯åº¦ä¸‹é™æ³•_gradient_descent.html">æ¢¯åº¦ä¸‹é™æ³• gradient descent</a></li><li class="chapter-item "><a href="ml/æ¢¯åº¦æœ€ä½³è§£ç›¸é—œç®—æ³•.html">æ¢¯åº¦æœ€ä½³è§£ç›¸é—œç®—æ³•</a></li><li class="chapter-item "><a href="ml/åŸºæ–¼DEAPåº«çš„Pythoné€²åŒ–æ¼”ç®—æ³•å¾å…¥é–€åˆ°å…¥åœŸ.html">åŸºæ–¼DEAPåº«çš„Pythoné€²åŒ–æ¼”ç®—æ³•å¾å…¥é–€åˆ°å…¥åœŸ</a></li><li class="chapter-item "><a href="ml/GA.html">GA</a></li><li class="chapter-item "><a href="ml/XGBoost.html">XGBoost</a></li><li class="chapter-item "><a href="ml/YOLO.html">YOLO</a></li><li class="chapter-item "><a href="ml/yolov8æ‰‹å‹¢è­˜åˆ¥.html">YOLOv8æ‰‹å‹¢è­˜åˆ¥</a></li><li class="chapter-item "><a href="ml/Roboflow.html">Roboflow</a></li></ol></li><li class="chapter-item expanded "><a href="python/python.html">Python</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="python/Poetryå®Œå…¨å…¥é–€æŒ‡å—.html">Poetryå®Œå…¨å…¥é–€æŒ‡å—</a></li><li class="chapter-item "><a href="python/æ­å»ºgRPCæœå‹™.html">æ­å»ºgRPCæœå‹™</a></li><li class="chapter-item "><a href="python/python_debugger.html">Python Debugger</a></li><li class="chapter-item "><a href="python/decorator.html">Python decorator</a></li><li class="chapter-item "><a href="python/python-decorator.html">è£é£¾å™¨çœ‹é€™ä¸€ç¯‡å°±å¤ äº†</a></li><li class="chapter-item "><a href="python/import-concept.html">import-concept</a></li><li class="chapter-item "><a href="python/process_thread.html">Process/Threadå„ªç¼ºé»</a></li><li class="chapter-item "><a href="python/processing_communcation.html">Processing é€šè¨Š</a></li><li class="chapter-item "><a href="python/condition.html">Pythonä¸­çš„waitå’Œnotify</a></li><li class="chapter-item "><a href="python/ç”Ÿç”¢è€…æ¶ˆè²»è€…æ¨¡å¼.html">ç”Ÿç”¢è€…æ¶ˆè²»è€…æ¨¡å¼</a></li><li class="chapter-item "><a href="python/Loguru.html">Loguru</a></li><li class="chapter-item "><a href="python/cython.html">Cython</a></li><li class="chapter-item "><a href="python/WebSocket_reconnect.html">Python WebSocketé•·é€£æ¥å¿ƒè·³èˆ‡çŸ­é€£æ¥</a></li><li class="chapter-item "><a href="python/bloomrpc.html">bloomrpc</a></li><li class="chapter-item "><a href="python/concurrent.futures.html">Concurrent futures</a></li><li class="chapter-item "><a href="python/schedule.html">ä»»å‹™èª¿åº¦</a></li><li class="chapter-item "><a href="python/plot/plot.html">Plot</a></li><li class="chapter-item "><a href="python/plot/dash.html">Dash</a></li><li class="chapter-item "><a href="python/Rust_bindings_for_Python.html">Rust bindings for Python</a></li><li class="chapter-item "><a href="python/pandas.html">Pandas</a></li><li class="chapter-item "><a href="python/coroutine.html">Coroutine</a></li><li class="chapter-item "><a href="python/finmind.html">FinMind</a></li><li class="chapter-item "><a href="python/telegram_bot.html">Telegram Bot</a></li><li class="chapter-item "><a href="python/python-different-ways-to-kill-a-thread.html">Different ways kill thread</a></li><li class="chapter-item "><a href="python/websocket_client_server.html">Websocket client/server</a></li><li class="chapter-item "><a href="python/poetry.html">å¾é›¶é–‹å§‹ä½¿ç”¨ Poetry</a></li><li class="chapter-item "><a href="python/fil-memory-usage-profiler.html">Fil-memory-usage-profiler</a></li><li class="chapter-item "><a href="python/plot.html">ç¹ªåœ–</a></li><li class="chapter-item "><a href="python/shioaji.html">æ°¸è±shioaji</a></li><li class="chapter-item "><a href="python/other.html">Other</a></li></ol></li><li class="chapter-item expanded "><a href="mermaid/mermaid.html">Mermaid</a></li><li class="chapter-item expanded "><a href="linux_system/linux_system.html">Linux System</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="linux_system/1_day_socket.html">Socket</a></li><li class="chapter-item "><a href="linux_system/cgroup.html">Cgroup</a></li><li class="chapter-item "><a href="linux_system/perf.html">Perf</a></li><li class="chapter-item "><a href="linux_system/è‡ªè£½Lib.html">build Lib</a></li><li class="chapter-item "><a href="linux_system/performance.html">performance</a></li></ol></li><li class="chapter-item expanded "><a href="strategy/bollmaker.html">Strategy</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/é€ å¸‚/market_market.html">é€ å¸‚</a></li><li class="chapter-item "><a href="strategy/tw_futures.html">è‡ºæŒ‡</a></li><li class="chapter-item "><a href="strategy/arbitrage.html">å¥—åˆ©</a></li><li class="chapter-item "><a href="strategy/é…å°äº¤æ˜“.html">é…å°äº¤æ˜“</a></li><li class="chapter-item "><a href="strategy/æµ·é¾œäº¤æ˜“.html">æµ·é¾œäº¤æ˜“</a></li><li class="chapter-item "><a href="strategy/è‚¡æµ·ç­‹è‚‰äºº.html">è‚¡æµ·ç­‹è‚‰äºº</a></li><li class="chapter-item "><a href="strategy/å¦‚ä½•é¿å…éæ“¬åˆ.html">å¦‚ä½•é¿å…éæ“¬åˆ</a></li><li class="chapter-item "><a href="strategy/å¤šç©ºæ“ä½œè¡“.html">å¤šç©ºæ“ä½œè¡“</a></li><li class="chapter-item "><a href="strategy/è³‡é‡‘æ§ç®¡æ‰æ˜¯ç‹é“.html">è³‡é‡‘æ§ç®¡æ‰æ˜¯ç‹é“</a></li><li class="chapter-item "><a href="strategy/00713_00675Læ­£äºŒèœˆèš£ç­–ç•¥.html">æ­£äºŒèœˆèš£ç­–ç•¥</a></li><li class="chapter-item "><a href="strategy/è³ªæŠ¼00713+æ­£äºŒ.html">è³ªæŠ¼00713+æ­£äºŒ</a></li><li class="chapter-item "><a href="strategy/phcebus/phcebus.html">phcebus</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/phcebus/è²å¼æ€è€ƒ.html">è²å¼æ€è€ƒ</a></li><li class="chapter-item "><a href="strategy/phcebus/è²·è‚¡3å¿ƒæ³•.html">è²·è‚¡3å¿ƒæ³•</a></li></ol></li><li class="chapter-item "><a href="strategy/Option/option.html">é¸æ“‡æ¬Š</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/Option/option_note.html">Option note</a></li></ol></li><li class="chapter-item "><a href="strategy/vectorbt.html">VectorBT</a></li><li class="chapter-item "><a href="strategy/orderbook.html">Orderbook</a></li><li class="chapter-item "><a href="strategy/é¸è‚¡æ¢ä»¶.html">é¸è‚¡æ¢ä»¶</a></li><li class="chapter-item "><a href="strategy/å¦‚ä½•é€²å ´.html">å¦‚ä½•é€²å ´</a></li><li class="chapter-item "><a href="strategy/å¦‚ä½•å‡ºå ´.html">å¦‚ä½•å‡ºå ´</a></li><li class="chapter-item "><a href="strategy/å»ºå€‰åŠ ç¢¼.html">å»ºå€‰åŠ ç¢¼</a></li><li class="chapter-item "><a href="strategy/DT.html">ç•¶æ²–</a></li><li class="chapter-item "><a href="strategy/ç•¶æ²–åšç©º.html">ç•¶æ²–åšç©º</a></li><li class="chapter-item "><a href="strategy/æŠ„åº•.html">æŠ„åº•</a></li><li class="chapter-item "><a href="strategy/éº»é“æ˜/éº»é“æ˜.html">éº»é“æ˜</a></li><li class="chapter-item "><a href="strategy/è³ºè´å¤§ç›¤çš„å‹•èƒ½æŠ•è³‡æ³•.html">è³ºè´å¤§ç›¤çš„å‹•èƒ½æŠ•è³‡æ³•</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/éº»é“æ˜/å‡çªç ´.html">å‡çªç ´</a></li></ol></li><li class="chapter-item "><a href="strategy/å¥‡æ­£/å¥‡æ­£.html">å¥‡æ­£</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/å¥‡æ­£/è³‡é‡‘æ§ç®¡èˆ‡è©¦å–®ç­–ç•¥.html">è³‡é‡‘æ§ç®¡èˆ‡è©¦å–®ç­–ç•¥</a></li><li class="chapter-item "><a href="strategy/å¥‡æ­£/å¦‚ä½•å‡ºå ´.html">å¦‚ä½•å‡ºå ´</a></li></ol></li><li class="chapter-item "><a href="strategy/ptt_stock/a0808996.html">PTT Stock</a></li><li class="chapter-item "><a href="strategy/Book/JG.html">JG</a></li><li class="chapter-item "><a href="strategy/bnf.html">BNF</a></li><li class="chapter-item "><a href="strategy/cis.html">CIS</a></li><li class="chapter-item "><a href="strategy/GA.html">GA</a></li><li class="chapter-item "><a href="strategy/stock.html">Stock</a></li><li class="chapter-item "><a href="strategy/note.html">Resource</a></li><li class="chapter-item "><a href="strategy/nansen.html">Nansen</a></li><li class="chapter-item "><a href="strategy/example.html">Example</a></li><li class="chapter-item "><a href="strategy/other.html">Other</a></li><li class="chapter-item "><a href="strategy/sample.html">Sample</a></li><li class="chapter-item "><a href="strategy/shioaji.html">shioaji æ¨¡æ“¬</a></li><li class="chapter-item "><a href="strategy/grid.html">Grid</a></li><li class="chapter-item "><a href="strategy/pine-script.html">pine-script</a></li><li class="chapter-item "><a href="strategy/æ‹¾äººç‰™æ…§.html">æ‹¾äººç‰™æ…§</a></li><li class="chapter-item "><a href="strategy/sharpe_ratio.html">å¤æ™®å€¼</a></li><li class="chapter-item "><a href="strategy/display_mae_mfe_analysis.html">MAE&amp;MFEåˆ†æ</a></li><li class="chapter-item "><a href="strategy/æµ·é¾œæŠ•è³‡æ³•å‰‡.html">æµ·é¾œæŠ•è³‡æ³•å‰‡</a></li><li class="chapter-item "><a href="strategy/edge-ratio-follow-application.html">å½ˆæ€§é€²å‡ºå ´çš„åˆ¤æ–·</a></li><li class="chapter-item "><a href="strategy/ä¸‰å¿ƒæ³•é †å‹¢æ“ä½œé™³æ—å…ƒ10å¹´è³‡ç”¢ç¿»10å€.html">ä¸‰å¿ƒæ³•é †å‹¢æ“ä½œé™³æ—å…ƒ10å¹´è³‡ç”¢ç¿»10å€</a></li><li class="chapter-item "><a href="strategy/Jump.html">JUMP</a></li><li class="chapter-item "><a href="strategy/å¼µæ¾å…æŠ•è³‡å¿ƒæ³•.html">å¼µå…æŠ•è³‡å¿ƒæ³•</a></li><li class="chapter-item "><a href="strategy/vectorbt_é…å°.html">vectorbt é…å°</a></li><li class="chapter-item "><a href="strategy/äº¤æ˜“çš„è¡Œç‚ºèˆ‡æ€ç¶­åˆ†äº«.html">äº¤æ˜“çš„è¡Œç‚ºèˆ‡æ€ç¶­åˆ†äº«</a></li><li class="chapter-item "><a href="strategy/æŠ•è³‡æŠ•æ©Ÿçš„è§€å¿µèˆ‡å¿ƒå¾—åˆ†äº«.html">æŠ•è³‡æŠ•æ©Ÿçš„è§€å¿µèˆ‡å¿ƒå¾—åˆ†äº«</a></li><li class="chapter-item "><a href="strategy/finlab.html">Finlab</a></li><li class="chapter-item "><a href="strategy/backtrader/basis.html">Backtrader</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶ä¸€Backtraderä»‹ç´¹.html">Pythonå›æ¸¬æ¡†æ¶ä¸€Backtraderä»‹ç´¹</a></li><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶äºŒå®šæœŸå®šé¡æŠ•è³‡.html">Python å›æ¸¬æ¡†æ¶ï¼ˆäºŒï¼‰å®šæœŸå®šé¡æŠ•è³‡</a></li><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶ä¸‰æŠ€è¡“æŒ‡æ¨™.html">Python å›æ¸¬æ¡†æ¶ï¼ˆä¸‰ï¼‰æŠ€è¡“æŒ‡æ¨™</a></li><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶å››CrossOverå’ŒSignal.html">Python å›æ¸¬æ¡†æ¶ï¼ˆå››ï¼‰CrossOver å’Œ Signal</a></li><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶äº”Sizer.html">Python å›æ¸¬æ¡†æ¶ï¼ˆäº”ï¼‰Sizer</a></li><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶å…­Analyzers.html">Python å›æ¸¬æ¡†æ¶ï¼ˆå…­ï¼‰Analyzers</a></li><li class="chapter-item "><a href="strategy/backtrader/å¤šè‚¡çµ„åˆæ“ä½œç­–ç•¥.html">å¤šè‚¡çµ„åˆæ“ä½œ</a></li><li class="chapter-item "><a href="strategy/backtrader/å‡ç·šäº¤å‰ç­–ç•¥.html">å‡ç·šäº¤å‰ç­–ç•¥</a></li><li class="chapter-item "><a href="strategy/backtrader/å”å¥‡å®‰é€šé“ç­–ç•¥.html">å”å¥‡å®‰é€šé“ç­–ç•¥</a></li><li class="chapter-item "><a href="strategy/backtrader/Sizersæ¨¡çµ„.html">Sizersæ¨¡çµ„</a></li><li class="chapter-item "><a href="strategy/backtrader/Observersæ¨¡çµ„.html">Observersæ¨¡çµ„</a></li><li class="chapter-item "><a href="strategy/backtrader/Pyfolio.html">Pyfolio</a></li><li class="chapter-item "><a href="strategy/backtrader/Sample.html">Sample</a></li><li class="chapter-item "><a href="strategy/backtrader/performance.html">Performance</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="mq/kafka.html">MQ</a></li><li class="chapter-item expanded "><a href="mq/kafka-python.html">Kafkaçš„é€šä¿—ç¸½çµ</a></li><li class="chapter-item expanded "><a href="database/database.html">Database</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="database/redis.html">Redis</a></li><li class="chapter-item "><a href="database/hash.html">Redis Hash</a></li><li class="chapter-item "><a href="database/clickhouse.html">ClickHouse</a></li><li class="chapter-item "><a href="database/dolphin.html">Dolphin</a></li><li class="chapter-item "><a href="database/sqlite.html">Sqlite</a></li></ol></li><li class="chapter-item expanded "><a href="cryptotrade/cryptotrade.html">CryptoTrade</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="cryptotrade/binance/binance.html">Binance</a></li><li class="chapter-item "><a href="cryptotrade/binance/oco.html">å¦‚ä½•å°‡OCOè¨‚å–®ç™¼é€åˆ°Binance</a></li></ol></li><li class="chapter-item expanded "><a href="git/git.html">Git</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="git/git-remove-commited-files.html">git-remove-commited-files</a></li><li class="chapter-item "><a href="git/cheat-sheet.html">Git å¸¸ç”¨</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_notes" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="ä½æ³¢å‹•-é£†è‚¡é•·ç›¸"><a class="header" href="#ä½æ³¢å‹•-é£†è‚¡é•·ç›¸">ä½æ³¢å‹• é£†è‚¡é•·ç›¸</a></h2>
<pre><code class="language-python">def compute_candle_volatility(timeperiod=20):
    close = data.get("price:æ”¶ç›¤åƒ¹")
    high = data.get("price:æœ€é«˜åƒ¹")
    low = data.get("price:æœ€ä½åƒ¹")
    open_ = data.get("price:é–‹ç›¤åƒ¹")

    bullish_candle = close &gt;= open_
    bullish_volatility = (
        abs(close.shift() - open_)
        + abs(open_ - low)
        + abs(low - high)
        + abs(high - close)
    )
    bearish_volatility = (
        abs(close.shift() - open_)
        + abs(open_ - high)
        + abs(high - low)
        + abs(low - close)
    )
    candle_volatility = FinlabDataFrame(
        np.nan, index=close.index, columns=close.columns
    )
    candle_volatility[bullish_candle] = bullish_volatility
    candle_volatility[~bullish_candle] = bearish_volatility
    volatility = (
        candle_volatility.average(timeperiod) / close.average(timeperiod) * 100
    )
    return volatility
</code></pre>
<h2 id="æ”¶ç›¤åƒ¹è·Ÿæœˆç‡Ÿæ”¶åˆä½µ"><a class="header" href="#æ”¶ç›¤åƒ¹è·Ÿæœˆç‡Ÿæ”¶åˆä½µ">æ”¶ç›¤åƒ¹è·Ÿæœˆç‡Ÿæ”¶åˆä½µ</a></h2>
<pre><code class="language-python">import finlab
import pandas as pd
from finlab import data

pd.options.display.float_format = lambda x: "%.2f" % x


if __name__ == "__main__":
    close = data.get("price:æ”¶ç›¤åƒ¹")
    rev = data.get("monthly_revenue:ç•¶æœˆç‡Ÿæ”¶")
    print(close)
    print(rev)

    merged_df = close.merge(rev, on='date', how='left', suffixes=('_close', '_rev'))
    merged_df.fillna(method='bfill', inplace=True)
    print(merged_df, merged_df.columns)
    print(merged_df['2330_close'], merged_df['2330_rev'])
</code></pre>
<h2 id="è‡ºè‚¡æ¼²è·Œèˆ‡å¸‚å€¼æ¿å¡Šåœ–"><a class="header" href="#è‡ºè‚¡æ¼²è·Œèˆ‡å¸‚å€¼æ¿å¡Šåœ–">è‡ºè‚¡æ¼²è·Œèˆ‡å¸‚å€¼æ¿å¡Šåœ–</a></h2>
<p>å‡ºè™•: https://www.finlab.tw/dashboard2-plotly-treemap/</p>
<pre><code class="language-python">import pandas as pd
import numpy as np
import finlab
from finlab import data
import plotly.express as px


"""
https://www.finlab.tw/dashboard2-plotly-treemap/
Treemap
"""


def df_date_filter(df, start=None, end=None):
    if start:
        df = df[df.index &gt;= start]
    if end:
        df = df[df.index &lt;= end]
    return df


def create_treemap_data(start, end, item, clip=None):
    close = data.get("price:æ”¶ç›¤åƒ¹")
    basic_info = data.get("company_basic_info")
    turnover = data.get("price:æˆäº¤é‡‘é¡")
    close_data = df_date_filter(close, start, end)
    turnover_data = df_date_filter(turnover, start, end).iloc[1:].sum() / 100000000
    return_ratio = (
        (close_data.iloc[-1] / close_data.iloc[-2]).dropna().replace(np.inf, 0)
    )
    return_ratio = round((return_ratio - 1) * 100, 2)

    concat_list = [close_data.iloc[-1], turnover_data, return_ratio]
    col_names = ["stock_id", "close", "turnover", "return_ratio"]
    if item not in ["return_ratio", "turnover_ratio"]:
        try:
            custom_item = df_date_filter(data.get(item), start, end).iloc[-1].fillna(0)
        except Exception as e:
            logger.error("data error, check the data is existed between start and end.")
            logger.error(e)
            return None
        if clip:
            custom_item = custom_item.clip(*clip)
        concat_list.append(custom_item)
        col_names.append(item)

    df = pd.concat(concat_list, axis=1).dropna()
    df = df.reset_index()
    df.columns = col_names

    basic_info_df = basic_info.copy()
    basic_info_df["stock_id_name"] = basic_info_df["stock_id"] + basic_info_df["å…¬å¸ç°¡ç¨±"]

    df = df.merge(
        basic_info_df[["stock_id", "stock_id_name", "ç”¢æ¥­é¡åˆ¥", "å¸‚å ´åˆ¥", "å¯¦æ”¶è³‡æœ¬é¡(å…ƒ)"]],
        how="left",
        on="stock_id",
    )
    df = df.rename(columns={"ç”¢æ¥­é¡åˆ¥": "category", "å¸‚å ´åˆ¥": "market", "å¯¦æ”¶è³‡æœ¬é¡(å…ƒ)": "base"})
    df = df.dropna(thresh=5)
    df["market_value"] = round(df["base"] / 10 * df["close"] / 100000000, 2)
    df["turnover_ratio"] = df["turnover"] / (df["turnover"].sum()) * 100
    df["country"] = "TW-Stock"
    return df


def plot_tw_stock_treemap(
    start=None,
    end=None,
    area_ind="market_value",
    item="return_ratio",
    clip=None,
    color_scales="Temps",
):
    """Plot treemap chart for tw_stock

    Treemap charts visualize hierarchical data using nested rectangles,
    it is good for judging the overall market dynamics.

    Args:
      start(str): The date of data start point.ex:2021-01-02
      end(str):The date of data end point.ex:2021-01-05
      area_ind(str):The indicator to control treemap area size .
                    Select range is in ["market_value","turnover","turnover_ratio"]
      item(str): The indicator to control treemap area color .
                 Select range is in ["return_ratio", "turnover_ratio"]
                 or use the other customized data which you could find from finlab database page,
                 ex:'price_earning_ratio:æœ¬ç›Šæ¯”'
      clip(tuple):lower and upper pd.clip() setting for item values to make distinct colors.ex:(0,100)
      color_scales(str):Used for the built-in named continuous
                        (sequential, diverging and cyclical) color scales in Plotly
                        Ref:https://plotly.com/python/builtin-colorscales/
    Returns:
        figure
    """
    df = create_treemap_data(start, end, item, clip)
    if df is None:
        return None
    df["custom_item_label"] = round(df[item], 2).astype(str)

    if area_ind not in ["market_value", "turnover", "turnover_ratio"]:
        return None

    if item in ["return_ratio"]:
        color_continuous_midpoint = 0
    else:
        color_continuous_midpoint = np.average(df[item], weights=df[area_ind])

    fig = px.treemap(
        df,
        path=["country", "market", "category", "stock_id_name"],
        values=area_ind,
        color=item,
        color_continuous_scale=color_scales,
        color_continuous_midpoint=color_continuous_midpoint,
        custom_data=["custom_item_label", "close", "turnover"],
        title=f"TW-Stock Market TreeMap({start}~{end})"
        f"---area_ind:{area_ind}---item:{item}",
        width=1600,
        height=800,
    )

    fig.update_traces(
        textposition="middle center",
        textfont_size=24,
        texttemplate="%{label}(%{customdata[1]})&lt;br&gt;%{customdata[0]}",
    )
    return fig


if __name__ == "__main__":
    # @title è‡ºè‚¡æ¼²è·Œèˆ‡å¸‚å€¼æ¿å¡Šåœ–
    start = "2021-07-01"  # @param {type:"date"}
    end = "2021-07-02"  # @param {type:"date"}
    area_ind = "turnover_ratio"  # @param ["market_value","turnover","turnover_ratio"] {allow-input: true}
    item = (
        "return_ratio"  # @param ["return_ratio", "turnover_ratio"] {allow-input: true}
    )
    clip = 1000  # @param {type:"number"}

    plot_tw_stock_treemap(start, end, area_ind, item, clip)

</code></pre>
<h2 id="finlab--çš„-mae--gmfe--bmfe"><a class="header" href="#finlab--çš„-mae--gmfe--bmfe">finlab  çš„ mae  gmfe  bmfe</a></h2>
<p>ä»¥ 2063 ä¸–é§ mae æ˜¯  0 ä»£è¡¨  2023-01-03 é€²å ´ï½ 2023-02-01 å‡ºå ´ çš„æ‰€æœ‰æ—¥K open åƒ¹éƒ½é«˜é é€²å ´ç•¶å¤©é–‹ç›¤åƒ¹</p>
<p>æ˜¯ä»¥é€²å ´åƒ¹æ ¼åšåŸºæº–é»ï½ è—ç’ç­–ç•¥ä»¥é–‹ç›¤åƒ¹é€²å ´  é–‹ç›¤åƒ¹å‡ºå ´</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">trade_index</th><th style="text-align: left">stock_id</th><th style="text-align: left">entry_date</th><th style="text-align: left">exit_date</th><th style="text-align: left">entry_sig_date</th><th style="text-align: left">exit_sig_date</th><th style="text-align: right">return</th><th style="text-align: right">trade_price@entry_date</th><th style="text-align: right">trade_price@exit_date</th><th style="text-align: right">mae</th><th style="text-align: right">gmfe</th><th style="text-align: right">bmfe</th><th style="text-align: right">mdd</th><th style="text-align: right">return_include_fee</th></tr></thead><tbody>
<tr><td style="text-align: right">630</td><td style="text-align: left">2063 ä¸–é§</td><td style="text-align: left">2023-01-03</td><td style="text-align: left">2023-02-01</td><td style="text-align: left">2022-12-30</td><td style="text-align: left">2023-01-31</td><td style="text-align: right">0.0159</td><td style="text-align: right">43.9000</td><td style="text-align: right">44.6000</td><td style="text-align: right">0.0000</td><td style="text-align: right">0.0342</td><td style="text-align: right">0.0000</td><td style="text-align: right">-0.0287</td><td style="text-align: right">1.0000</td></tr>
<tr><td style="text-align: right">631</td><td style="text-align: left">3498 é™½ç¨‹</td><td style="text-align: left">2023-01-03</td><td style="text-align: left">2023-02-01</td><td style="text-align: left">2022-12-30</td><td style="text-align: left">2023-01-31</td><td style="text-align: right">-0.0225</td><td style="text-align: right">37.8000</td><td style="text-align: right">36.9500</td><td style="text-align: right">-0.0542</td><td style="text-align: right">0.0582</td><td style="text-align: right">0.0582</td><td style="text-align: right">-0.1062</td><td style="text-align: right">-2.8200</td></tr>
<tr><td style="text-align: right">632</td><td style="text-align: left">8996 é«˜åŠ›</td><td style="text-align: left">2023-01-03</td><td style="text-align: left">2023-02-01</td><td style="text-align: left">2022-12-30</td><td style="text-align: left">2023-01-31</td><td style="text-align: right">0.1568</td><td style="text-align: right">185.0000</td><td style="text-align: right">214.0000</td><td style="text-align: right">-0.0270</td><td style="text-align: right">0.1568</td><td style="text-align: right">0.0270</td><td style="text-align: right">-0.0526</td><td style="text-align: right">15.0000</td></tr>
<tr><td style="text-align: right">633</td><td style="text-align: left">1104 ç’°æ³¥</td><td style="text-align: left">2023-02-01</td><td style="text-align: left">2023-03-01</td><td style="text-align: left">2023-01-31</td><td style="text-align: left">2023-02-24</td><td style="text-align: right">0.0253</td><td style="text-align: right">23.7000</td><td style="text-align: right">24.3000</td><td style="text-align: right">-0.0042</td><td style="text-align: right">0.0316</td><td style="text-align: right">0.0274</td><td style="text-align: right">-0.0308</td><td style="text-align: right">1.9300</td></tr>
<tr><td style="text-align: right">634</td><td style="text-align: left">1707 è‘¡è„ç‹</td><td style="text-align: left">2023-01-03</td><td style="text-align: left">2023-03-01</td><td style="text-align: left">2022-12-30</td><td style="text-align: left">2023-02-24</td><td style="text-align: right">0.0737</td><td style="text-align: right">169.5000</td><td style="text-align: right">182.0000</td><td style="text-align: right">-0.0619</td><td style="text-align: right">0.0737</td><td style="text-align: right">0.0000</td><td style="text-align: right">-0.0619</td><td style="text-align: right">6.7500</td></tr>
<tr><td style="text-align: right">635</td><td style="text-align: left">2727 ç‹å“</td><td style="text-align: left">2023-02-01</td><td style="text-align: left">2023-03-01</td><td style="text-align: left">2023-01-31</td><td style="text-align: left">2023-02-24</td><td style="text-align: right">0.4865</td><td style="text-align: right">185.0000</td><td style="text-align: right">275.0000</td><td style="text-align: right">0.0000</td><td style="text-align: right">0.4865</td><td style="text-align: right">0.0000</td><td style="text-align: right">-0.0455</td><td style="text-align: right">47.7800</td></tr>
<tr><td style="text-align: right">636</td><td style="text-align: left">6612 å¥ˆç±³é†«æ</td><td style="text-align: left">2023-02-01</td><td style="text-align: left">2023-03-01</td><td style="text-align: left">2023-01-31</td><td style="text-align: left">2023-02-24</td><td style="text-align: right">0.2284</td><td style="text-align: right">116.0000</td><td style="text-align: right">142.5000</td><td style="text-align: right">0.0000</td><td style="text-align: right">0.3405</td><td style="text-align: right">0.0000</td><td style="text-align: right">-0.0870</td><td style="text-align: right">22.1300</td></tr>
<tr><td style="text-align: right">637</td><td style="text-align: left">2916 æ»¿å¿ƒ</td><td style="text-align: left">2023-03-01</td><td style="text-align: left">2023-04-06</td><td style="text-align: left">2023-02-24</td><td style="text-align: left">2023-03-31</td><td style="text-align: right">-0.0046</td><td style="text-align: right">32.8000</td><td style="text-align: right">32.6500</td><td style="text-align: right">-0.0244</td><td style="text-align: right">0.0549</td><td style="text-align: right">0.0549</td><td style="text-align: right">-0.0751</td><td style="text-align: right">-1.0400</td></tr>
<tr><td style="text-align: right">638</td><td style="text-align: left">3004 è±é”ç§‘</td><td style="text-align: left">2023-03-01</td><td style="text-align: left">2023-04-06</td><td style="text-align: left">2023-02-24</td><td style="text-align: left">2023-03-31</td><td style="text-align: right">0.0650</td><td style="text-align: right">89.2000</td><td style="text-align: right">93.9000</td><td style="text-align: right">-0.0695</td><td style="text-align: right">0.0650</td><td style="text-align: right">0.0381</td><td style="text-align: right">-0.1037</td><td style="text-align: right">4.6500</td></tr>
<tr><td style="text-align: right">639</td><td style="text-align: left">3052 å¤†å…¸</td><td style="text-align: left">2023-03-01</td><td style="text-align: left">2023-04-06</td><td style="text-align: left">2023-02-24</td><td style="text-align: left">2023-03-31</td><td style="text-align: right">-0.0560</td><td style="text-align: right">11.6000</td><td style="text-align: right">10.9500</td><td style="text-align: right">-0.0560</td><td style="text-align: right">0.0000</td><td style="text-align: right">0.0000</td><td style="text-align: right">-0.0560</td><td style="text-align: right">-6.1500</td></tr>
<tr><td style="text-align: right">640</td><td style="text-align: left">6664 ç¾¤ç¿Š</td><td style="text-align: left">2023-03-01</td><td style="text-align: left">2023-04-06</td><td style="text-align: left">2023-02-24</td><td style="text-align: left">2023-03-31</td><td style="text-align: right">0.0648</td><td style="text-align: right">108.0000</td><td style="text-align: right">115.0000</td><td style="text-align: right">-0.0648</td><td style="text-align: right">0.0648</td><td style="text-align: right">0.0000</td><td style="text-align: right">-0.0648</td><td style="text-align: right">5.8600</td></tr>
<tr><td style="text-align: right">641</td><td style="text-align: left">8931 å¤§æ±½é›»</td><td style="text-align: left">2023-02-01</td><td style="text-align: left">2023-04-06</td><td style="text-align: left">2023-01-31</td><td style="text-align: left">2023-03-31</td><td style="text-align: right">0.6282</td><td style="text-align: right">46.8000</td><td style="text-align: right">76.2000</td><td style="text-align: right">0.0000</td><td style="text-align: right">0.7286</td><td style="text-align: right">0.0000</td><td style="text-align: right">-0.0581</td><td style="text-align: right">61.8700</td></tr>
<tr><td style="text-align: right">642</td><td style="text-align: left">3078 åƒ‘å¨</td><td style="text-align: left">2023-04-06</td><td style="text-align: left">nan</td><td style="text-align: left">2023-03-31</td><td style="text-align: left">2023-04-30</td><td style="text-align: right">0.2362</td><td style="text-align: right">44.2500</td><td style="text-align: right">54.7000</td><td style="text-align: right">-0.0147</td><td style="text-align: right">0.3107</td><td style="text-align: right">0.0000</td><td style="text-align: right">-0.0569</td><td style="text-align: right">22.8900</td></tr>
<tr><td style="text-align: right">643</td><td style="text-align: left">3540 æ›œè¶Š</td><td style="text-align: left">2023-04-06</td><td style="text-align: left">nan</td><td style="text-align: left">2023-03-31</td><td style="text-align: left">2023-04-30</td><td style="text-align: right">0.0773</td><td style="text-align: right">38.8000</td><td style="text-align: right">41.8000</td><td style="text-align: right">-0.0052</td><td style="text-align: right">0.1521</td><td style="text-align: right">0.0013</td><td style="text-align: right">-0.0649</td><td style="text-align: right">7.1000</td></tr>
<tr><td style="text-align: right">644</td><td style="text-align: left">4119 æ—­å¯Œ</td><td style="text-align: left">2023-04-06</td><td style="text-align: left">nan</td><td style="text-align: left">2023-03-31</td><td style="text-align: left">2023-04-30</td><td style="text-align: right">0.0496</td><td style="text-align: right">121.0000</td><td style="text-align: right">127.0000</td><td style="text-align: right">0.0000</td><td style="text-align: right">0.0992</td><td style="text-align: right">0.0000</td><td style="text-align: right">-0.0451</td><td style="text-align: right">4.3500</td></tr>
<tr><td style="text-align: right">645</td><td style="text-align: left">4153 éˆºç·¯</td><td style="text-align: left">2023-04-06</td><td style="text-align: left">nan</td><td style="text-align: left">2023-03-31</td><td style="text-align: left">2023-04-30</td><td style="text-align: right">0.1000</td><td style="text-align: right">48.0000</td><td style="text-align: right">52.8000</td><td style="text-align: right">0.0000</td><td style="text-align: right">0.2625</td><td style="text-align: right">0.0000</td><td style="text-align: right">-0.1287</td><td style="text-align: right">9.3600</td></tr>
<tr><td style="text-align: right">646</td><td style="text-align: left">4190 ä½ç™»-KY</td><td style="text-align: left">2023-04-06</td><td style="text-align: left">nan</td><td style="text-align: left">2023-03-31</td><td style="text-align: left">2023-04-30</td><td style="text-align: right">0.0741</td><td style="text-align: right">94.5000</td><td style="text-align: right">101.5000</td><td style="text-align: right">-0.0169</td><td style="text-align: right">0.1111</td><td style="text-align: right">0.0000</td><td style="text-align: right">-0.0333</td><td style="text-align: right">6.7800</td></tr>
</tbody></table>
</div>
<pre><code class="language-python"># -*- coding: utf-8 -*-
"""correlationMatrix.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1jmq3ycgp65_NURP8cY3vg2SvTDXc5X8n
"""

#!pip install yfinance &gt; log.txt
#@title è¼¸å…¥ Yahoo è‚¡ç¥¨ä»£è™Ÿ(ä¾‹å¦‚: 2330.TW, AAPL, BTC-USD)
stock_ids = "2454.TW,2330.TW, AAPL, BTC-USD" #@param {type:"string"}

import yfinance as yf
import time
import pandas as pd

stocks = stock_ids.replace(' ', '').split(',')
price = {}

for s in stocks:

  print(f'download {s}')

  ss = yf.Ticker(s)

  # get historical market data
  hist = ss.history(period='1y')

  price[s] = hist['Close']
  time.sleep(3)

import seaborn
import matplotlib.pyplot as plt

plt.rcParams['figure.figsize'] = (10, 6)
seaborn.heatmap(pd.DataFrame(price).pct_change().dropna(how='any').corr(), cmap="YlGnBu",vmax=1,vmin=-1, annot=True)
</code></pre>
<p><img src="images/correlationMatrix.png" alt="" /></p>
<h2 id="finlabç­–ç•¥"><a class="header" href="#finlabç­–ç•¥">finlabç­–ç•¥</a></h2>
<pre><code class="language-python">from finlab import data
from finlab.backtest import sim
import pandas as pd
import redis
import finlab

def connect_redis():
    r = None
    pool = redis.ConnectionPool(host="localhost", port=6379, db=8)
    try:
        r = redis.Redis(connection_pool=pool, charset="utf-8")
    except Exception as err:
        logger.error(err)
    return r

# rs = connect_redis()
# rs.flushdb()

finlab.login("")
score = data.get('etl:finlab_tw_stock_market_ind')['score']
close = data.get("price:æ”¶ç›¤åƒ¹")
vol = data.get("price:æˆäº¤è‚¡æ•¸")
vol_ma = vol.average(10)
rev = data.get('monthly_revenue:ç•¶æœˆç‡Ÿæ”¶')
rev_year_growth = data.get('monthly_revenue:å»å¹´åŒæœˆå¢æ¸›(%)')
rev_month_growth = 	data.get('monthly_revenue:ä¸Šæœˆæ¯”è¼ƒå¢æ¸›(%)')

# è‚¡åƒ¹å‰µå¹´æ–°é«˜
cond1 = (close == close.rolling(250).max())

# æ’é™¤æœˆç‡Ÿæ”¶é€£3æœˆè¡°é€€10%ä»¥ä¸Š
cond2 = ~(rev_year_growth &lt; -10).sustain(3) 

# æ’é™¤æœˆç‡Ÿæ”¶æˆé•·è¶¨å‹¢éè€(12å€‹æœˆå…§æœ‰è‡³å°‘8å€‹æœˆå–®æœˆç‡Ÿæ”¶å¹´å¢ç‡å¤§æ–¼60%)
cond3 = ~(rev_year_growth &gt; 60).sustain(12,8) 

# ç¢ºèªç‡Ÿæ”¶åº•éƒ¨ï¼Œè¿‘æœˆç‡Ÿæ”¶è„«é›¢è¿‘å¹´ç©€åº•(é€£çºŒ3æœˆçš„"å–®æœˆç‡Ÿæ”¶è¿‘12æœˆæœ€å°å€¼/è¿‘æœˆç‡Ÿæ”¶" &lt; 0.8)
cond4 = ((rev.rolling(12).min())/(rev) &lt; 0.8).sustain(3)

# å–®æœˆç‡Ÿæ”¶æœˆå¢ç‡é€£çºŒ3æœˆå¤§æ–¼-40%
cond5 = (rev_month_growth &gt; -40).sustain(3)

# æµå‹•æ€§æ¢ä»¶
cond6 = vol_ma &gt; 200*1000

buy = cond1 &amp; cond2  &amp; cond3 &amp; cond4 &amp; cond5 &amp; cond6

# è²·æ¯”è¼ƒå†·é–€çš„è‚¡ç¥¨
buy = vol_ma*buy
buy = buy[buy&gt;0]
buy = buy.is_smallest(5)
long_position = buy.resample('M').last().reindex(close.index,method='ffill')

score_df = score &gt;= 4
long_position *= score_df

# åšç©ºè¨Šè™Ÿï½å¤šå–®é‡å¤§ç›¤è¨Šè™Ÿè½‰ç©ºæ™‚å‡ºå ´ï¼Œä¸¦åæ‰‹åšç©ºæŒ‡æ•¸é¿éšª
short_target = '00632R'
short_position = close[[short_target]].notna() * ~score_df
position = pd.concat([long_position, short_position], axis=1)

report = sim(position, upload=True, position_limit=1/3, fee_ratio=1.425/1000/3, stop_loss=0.08,  trade_at_price='open' ,name='XXXX', live_performance_start='2022-06-01')
print(report.get_trades().to_markdown())

</code></pre>
<pre><code class="language-python">from finlab import data
from finlab.backtest import sim
import finlab

finlab.login("")

close = data.get("price:æ”¶ç›¤åƒ¹")
vol = data.get("price:æˆäº¤è‚¡æ•¸")
vol_ma = vol.average(10)
rev = data.get('monthly_revenue:ç•¶æœˆç‡Ÿæ”¶')
rev_year_growth = data.get('monthly_revenue:å»å¹´åŒæœˆå¢æ¸›(%)')
rev_month_growth = 	data.get('monthly_revenue:ä¸Šæœˆæ¯”è¼ƒå¢æ¸›(%)')

# è‚¡åƒ¹å‰µå¹´æ–°é«˜
cond1 = (close == close.rolling(250).max())

# æ’é™¤æœˆç‡Ÿæ”¶é€£3æœˆè¡°é€€10%ä»¥ä¸Š
cond2 = ~(rev_year_growth &lt; -10).sustain(3) 

# æ’é™¤æœˆç‡Ÿæ”¶æˆé•·è¶¨å‹¢éè€(12å€‹æœˆå…§æœ‰è‡³å°‘8å€‹æœˆå–®æœˆç‡Ÿæ”¶å¹´å¢ç‡å¤§æ–¼60%)
cond3 = ~(rev_year_growth &gt; 60).sustain(12,8)

# ç¢ºèªç‡Ÿæ”¶åº•éƒ¨(å–®æœˆç‡Ÿæ”¶æœˆå¢ç‡é€£çºŒ3æœˆå¤§æ–¼-40)
cond4 = ((rev.rolling(12).min())/(rev) &lt; 0.8).sustain(3)

# å–®æœˆç‡Ÿæ”¶æœˆå¢ç‡é€£çºŒ3æœˆå¤§æ–¼-40%
cond5 = (rev_month_growth &gt; -40).sustain(3)

# æµå‹•æ€§æ¢ä»¶
cond6 = vol_ma &gt; 200*1000

buy = cond1 &amp; cond2  &amp; cond3 &amp; cond4 &amp; cond5 &amp; cond6

# è²·æ¯”è¼ƒå†·é–€çš„è‚¡ç¥¨
buy = vol_ma*buy
buy = buy[buy&gt;0]
buy = buy.is_smallest(5)

report = sim(buy , resample="M", upload=True, position_limit=1/3, fee_ratio=1.425/1000/3, stop_loss=0.08,  trade_at_price='open',name='XXX', live_performance_start='2022-05-01')
print(report.get_trades().to_markdown())

</code></pre>
<pre><code class="language-py">from loguru import logger
from finlab import data
from finlab.backtest import sim
import finlab
import pandas as pd
import pickle
import redis
import zlib


def data_to_redis(r):
    score = data.get("etl:finlab_tw_stock_market_ind")["score"]
    close = data.get("price:æ”¶ç›¤åƒ¹")
    vol = data.get("price:æˆäº¤è‚¡æ•¸")
    vol_ma = vol.average(10)
    rev = data.get("monthly_revenue:ç•¶æœˆç‡Ÿæ”¶")
    rev_year_growth = data.get("monthly_revenue:å»å¹´åŒæœˆå¢æ¸›(%)")
    rev_month_growth = data.get("monthly_revenue:ä¸Šæœˆæ¯”è¼ƒå¢æ¸›(%)")
    EXPIRATION_SECONDS = 86400
    # Set
    r.setex("score", EXPIRATION_SECONDS, zlib.compress(pickle.dumps(score)))
    r.setex("close", EXPIRATION_SECONDS, zlib.compress(pickle.dumps(close)))
    r.setex("vol", EXPIRATION_SECONDS, zlib.compress(pickle.dumps(vol)))
    r.setex("vol_ma", EXPIRATION_SECONDS, zlib.compress(pickle.dumps(vol_ma)))
    r.setex("rev", EXPIRATION_SECONDS, zlib.compress(pickle.dumps(rev)))
    r.setex(
        "rev_year_growth",
        EXPIRATION_SECONDS,
        zlib.compress(pickle.dumps(rev_year_growth)),
    )
    r.setex(
        "rev_month_growth",
        EXPIRATION_SECONDS,
        zlib.compress(pickle.dumps(rev_month_growth)),
    )

def backtest(r):
    # Get
    score_df = pickle.loads(zlib.decompress(r.get("score")))
    close_df = pickle.loads(zlib.decompress(r.get("close")))
    vol_df = pickle.loads(zlib.decompress(r.get("vol")))
    vol_ma_df = pickle.loads(zlib.decompress(r.get("vol_ma")))
    rev_df = pickle.loads(zlib.decompress(r.get("rev")))
    rev_year_growth_df = pickle.loads(zlib.decompress(r.get("rev_year_growth")))
    rev_month_growth_df = pickle.loads(zlib.decompress(r.get("rev_month_growth")))
    # print(score_df)
    # print(close_df)
    # print(vol_df)
    # print(vol_ma_df)
    # print(rev_df)
    # print(rev_year_growth_df)
    # print(rev_month_growth_df)
    # è‚¡åƒ¹å‰µå¹´æ–°é«˜
    cond1 = close_df == close_df.rolling(250).max()

    # æ’é™¤æœˆç‡Ÿæ”¶é€£3æœˆè¡°é€€10%ä»¥ä¸Š
    cond2 = ~(rev_year_growth_df &lt; -10).sustain(3)

    # æ’é™¤æœˆç‡Ÿæ”¶æˆé•·è¶¨å‹¢éè€(12å€‹æœˆå…§æœ‰è‡³å°‘8å€‹æœˆå–®æœˆç‡Ÿæ”¶å¹´å¢ç‡å¤§æ–¼60%)
    cond3 = ~(rev_year_growth_df &gt; 60).sustain(12, 8)

    # ç¢ºèªç‡Ÿæ”¶åº•éƒ¨ï¼Œè¿‘æœˆç‡Ÿæ”¶è„«é›¢è¿‘å¹´ç©€åº•(é€£çºŒ3æœˆçš„"å–®æœˆç‡Ÿæ”¶è¿‘12æœˆæœ€å°å€¼/è¿‘æœˆç‡Ÿæ”¶" &lt; 0.8)
    cond4 = ((rev_df.rolling(12).min()) / (rev_df) &lt; 0.8).sustain(3)

    # å–®æœˆç‡Ÿæ”¶æœˆå¢ç‡é€£çºŒ3æœˆå¤§æ–¼-40%
    cond5 = (rev_month_growth_df &gt; -40).sustain(3)

    # æµå‹•æ€§æ¢ä»¶
    cond6 = vol_ma_df &gt; 200 * 1000
    buy = cond1 &amp; cond2 &amp; cond3 &amp; cond4 &amp; cond5 &amp; cond6

    # è²·æ¯”è¼ƒå†·é–€çš„è‚¡ç¥¨
    buy = vol_ma_df * buy
    buy = buy[buy &gt; 0]
    buy = buy.is_smallest(5)
    long_position = buy.resample("M").last().reindex(close_df.index, method="ffill")
    score_df = score_df &gt;= 4
    long_position *= score_df

    # åšç©ºè¨Šè™Ÿï½å¤šå–®é‡å¤§ç›¤è¨Šè™Ÿè½‰ç©ºæ™‚å‡ºå ´ï¼Œä¸¦åæ‰‹åšç©ºæŒ‡æ•¸é¿éšª
    short_target = "00632R"
    short_position = close_df[[short_target]].notna() * ~score_df
    position = pd.concat([long_position, short_position], axis=1)

    report = sim(
        position,
        upload=True,
        position_limit=1 / 3,
        fee_ratio=1.425 / 1000 / 3,
        stop_loss=0.08,
        trade_at_price="open",
        name="XXXXX",
        live_performance_start="2022-06-01",
    )
    # print(report.get_stats())


def connect_redis():
    pool = redis.ConnectionPool(host="localhost", port=6379, db=0)
    try:
        r = redis.Redis(connection_pool=pool, charset="utf-8")
    except Exception as err:
        logger.error(err)
    return r


if __name__ == "__main__":
    finlab.login(
        ""
    )
    r = connect_redis()
    # data_to_redis(r)
    backtest(r)

</code></pre>
<h2 id="highcharts_è‚¡åƒ¹èµ°å‹¢ipynb"><a class="header" href="#highcharts_è‚¡åƒ¹èµ°å‹¢ipynb">highcharts_è‚¡åƒ¹èµ°å‹¢.ipynb</a></h2>
<p>https://colab.research.google.com/drive/1W1kH3cwNUTj7hMMyF8W4wcehiWLSyAUF?usp=sharing#scrollTo=Mij5sRmwbtCP</p>
<pre><code class="language-python">import yfinance as yf

# å–å¾—è‚¡åƒ¹æ­·å²è³‡æ–™(å«è‡ºè‚¡\ç¾è‚¡\åŠ å¯†è²¨å¹£)

symbol = '2330.TW' # è‡ºè‚¡ä¸Šå¸‚:TW è‡ºè‚¡ä¸Šæ«ƒ:TWO 
start = '2018-01-01' # èµ·å§‹æ™‚é–“
end = '2022-12-31' # çµæŸæ™‚é–“

ohlcv = yf.Ticker(symbol).history('max').loc[start:end]


from highcharts import Highchart
import datetime
from IPython.display import HTML,display
import os

# å®¢è£½åŒ–èª¿æ•´åƒæ•¸
color = '#4285f4' # ç·šçš„é¡è‰² (red/green/blue/purple)
linewidth = 2 # ç·šçš„ç²—ç´°
title = symbol # æ¨™é¡Œåç¨±
width = 800 # åœ–çš„å¯¬åº¦
height = 500 # åœ–çš„é«˜åº¦


# ç¹ªåœ–è¨­å®š
H = Highchart(width=width,height=height)

x = ohlcv.index
y = round(ohlcv.Close,2)

data = [[index,s] for index,s in zip(x,y)]
H.add_data_set(data,'line','data',color=color)

H.set_options('xAxis',{'type':'datetime'})
H.set_options('title',{'text':title,'style':{'color':'black'}}) # è¨­å®štitle
H.set_options('plotOptions',{'line':{'lineWidth':linewidth,'dataLabels':{'enabled': False}}}) # è¨­å®šç·šçš„ç²—åº¦
H.set_options('tooltip',{'shared':True,'crosshairs':True}) # è¨­å®šç‚ºå¯äº’å‹•å¼

# é¡¯ç¤ºåœ–è¡¨
H.save_file('chart')
display(HTML('chart.html'))
os.remove('chart.html')
</code></pre>
<h2 id="çªç ´ç­–ç•¥è±†çŸ¥è­˜--å¦‚ä½•é¿å…å‡çªç ´"><a class="header" href="#çªç ´ç­–ç•¥è±†çŸ¥è­˜--å¦‚ä½•é¿å…å‡çªç ´">çªç ´ç­–ç•¥è±†çŸ¥è­˜ | å¦‚ä½•é¿å…å‡çªç ´?</a></h2>
<p>https://colab.research.google.com/drive/1M0XxnAMZoqoOrJQP9dyJVer5Q7YyRFOA?usp=sharing</p>
<p>https://www.finlab.tw/breakthrough_stock_picking_strategies/</p>
<pre><code class="language-python"># -*- coding: utf-8 -*-
"""è‚¡åƒ¹å‰µæ–°é«˜å‹•èƒ½.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1M0XxnAMZoqoOrJQP9dyJVer5Q7YyRFOA

## å®‰è£å¥—ä»¶
"""

# Commented out IPython magic to ensure Python compatibility.
# %%capture
# !pip install finlab &gt; log.txt
# !pip install talib-binary &gt; log.txt

"""## è‚¡åƒ¹å‰µæ–°é«˜å‹•èƒ½"""

from finlab.backtest import sim
from finlab import data

# æ¨™çš„ç¯„åœç‚ºä¸Šå¸‚æ«ƒæ™®é€šè‚¡
with data.universe(market='TSE_OTC'):
    # å–å¾—æ”¶ç›¤åƒ¹
    close = data.get("price:æ”¶ç›¤åƒ¹")
    # è‚¡åƒ¹å‰µè¿‘200æ—¥æ–°é«˜
    position = (close == close.rolling(200).max())
    # æ¯å…©é€±å†å¹³è¡¡ï¼Œå–®æª”æœ€å¤§æŒè‚¡æ¯”ä¾‹é™åˆ¶20%ï¼Œåœæ20%
    report = sim(position, resample="2W", position_limit=0.2, stop_loss=0.2, name="è‚¡åƒ¹å‰µæ–°é«˜ç­–ç•¥", upload=False)
    report.display()

"""## å‰µæ–°é«˜å»¶çºŒå‹•èƒ½ç­–ç•¥

"""

from finlab.backtest import sim
from finlab import data
with data.universe(market='TSE_OTC'):
    close = data.get("price:æ”¶ç›¤åƒ¹")
    # è¿‘5æ—¥å…§æœ‰3æ—¥ä»¥ä¸Šçš„è‚¡åƒ¹å‰µå‰200æ—¥æ–°é«˜
    position = (close == close.rolling(200).max()).sustain(5,3)
    report = sim(position, resample="2W", position_limit=0.2, stop_loss=0.2, name="å‰µæ–°é«˜å»¶çºŒå‹•èƒ½ç­–ç•¥", upload=False)
    report.display()
</code></pre>
<pre><code class="language-python">import yfinance as yf

# ä¸‹è¼‰è‡ºç©é›»è‚¡ç¥¨è³‡æ–™
df = yf.download("2317.TW", start="2014-01-01", end="2023-01-01")

# å°‡æ™‚é–“å–®ä½è½‰æ›ç‚ºæœˆä»½ï¼Œå–å¾—æ¯å€‹æœˆä»½çš„æœ€å¾Œä¸€ç­†è³‡æ–™ï¼Œä¸¦å¡«è£œç¼ºå¤±å€¼
df = df.resample("M").last().bfill()

# æ ¹æ“šåŸå§‹è³‡æ–™çš„æ™‚é–“ç´¢å¼•é‡æ–°æ’åºï¼Œä¸¦å¡«è£œç¼ºå¤±å€¼
df = df.reindex(df.index, method="bfill")

print(df)
</code></pre>
<ul>
<li>FinlabDataFrame</li>
</ul>
<pre><code class="language-python">from finlab.utils import logger
import datetime
import numpy as np
import pandas as pd
from finlab import data
import functools


class FinlabDataFrame(pd.DataFrame):
    """å›æ¸¬èªæ³•ç³–
    é™¤äº†ä½¿ç”¨ç†Ÿæ‚‰çš„ Pandas èªæ³•å¤–ï¼Œæˆ‘å€‘ä¹Ÿæä¾›å¾ˆå¤šèªæ³•ç³–ï¼Œè®“å¤§å®¶é–‹ç™¼ç¨‹å¼æ™‚ï¼Œå¯ä»¥ç”¨ç°¡æ˜“çš„èªæ³•å®Œæˆè¤‡é›œçš„åŠŸèƒ½ï¼Œè®“é–‹ç™¼ç­–ç•¥æ›´ç°¡æ½”ï¼
    æˆ‘å€‘å°‡æ‰€æœ‰çš„èªæ³•ç³–åŒ…è£¹åœ¨ `FinlabDataFrame` ä¸­ï¼Œç”¨èµ·ä¾†è·Ÿ `pd.DataFrame` ä¸€æ¨£ï¼Œä½†æ˜¯å¤šäº†å¾ˆå¤šåŠŸèƒ½ï¼
    åªè¦ä½¿ç”¨ `finlab.data.get()` æ‰€ç²å¾—çš„è³‡æ–™ï¼Œçš†ç‚º `FinlabDataFrame` æ ¼å¼ï¼Œ
    æ¥ä¸‹ä¾†æˆ‘å€‘å°±ä¾†çœ‹çœ‹ï¼Œ `FinlabDataFrame` æœ‰å“ªäº›å¥½ç”¨çš„èªæ³•ç³–å§ï¼

    ç•¶è³‡æ–™æ—¥æœŸæ²’æœ‰å°é½Šï¼ˆä¾‹å¦‚: è²¡å ± vs æ”¶ç›¤åƒ¹ vs æœˆå ±ï¼‰æ™‚ï¼Œåœ¨ä½¿ç”¨ä»¥ä¸‹é‹ç®—ç¬¦è™Ÿï¼š`+`, `-`, `*`, `/`, `&gt;`, `&gt;=`, `==`, `&lt;`, `&lt;=`, `&amp;`, `|`, `~`ï¼Œä¸éœ€è¦å…ˆå°‡è³‡æ–™å°é½Šï¼Œå› ç‚º `FinlabDataFrame` æœƒè‡ªå‹•å¹«ä½ è™•ç†ï¼Œä»¥ä¸‹æ˜¯ç¤ºæ„åœ–ã€‚

    &lt;img src="https://i.ibb.co/pQr5yx5/Screen-Shot-2021-10-26-at-5-32-44-AM.png" alt="Screen-Shot-2021-10-26-at-5-32-44-AM"&gt;

    ä»¥ä¸‹æ˜¯ç¯„ä¾‹ï¼š`cond1` èˆ‡ `cond2` åˆ†åˆ¥ç‚ºã€Œæ¯å¤©ã€ï¼Œå’Œã€Œæ¯å­£ã€çš„è³‡æ–™ï¼Œå‡å¦‚è¦å–äº¤é›†çš„æ™‚é–“ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹èªæ³•ï¼š

    ```py
    from finlab import data
    # å–å¾— FinlabDataFrame
    close = data.get('price:æ”¶ç›¤åƒ¹')
    roa = data.get('fundamental_features:ROAç¨…å¾Œæ¯å‰')

    # é‹ç®—å…©å€‹é¸è‚¡æ¢ä»¶äº¤é›†
    cond1 = close &gt; 37
    cond2 = roa &gt; 0
    cond_1_2 = cond1 &amp; cond2
</code></pre>
<pre><code>æ“·å– 1101 è‡ºæ³¥ çš„è¨Šè™Ÿå¦‚ä¸‹åœ–ï¼Œå¯ä»¥çœ‹åˆ° `cond1` è·Ÿ `cond2` è¨Šè™Ÿçš„é »ç‡é›–ç„¶ä¸ç›¸åŒï¼Œä½†æ˜¯ç”±æ–¼ `cond1` è·Ÿ `cond2` æ˜¯ `FinlabDataFrame`ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å–äº¤é›†ï¼Œè€Œä¸ç”¨è™•ç†è³‡æ–™é »ç‡å°é½Šçš„å•é¡Œã€‚
&lt;br /&gt;
&lt;img src="https://i.ibb.co/m9chXSQ/imageconds.png" alt="imageconds"&gt;

ç¸½çµä¾†èªªï¼ŒFinlabDataFrame èˆ‡ä¸€èˆ¬ dataframe å”¯äºŒä¸åŒä¹‹è™•ï¼š
1. å¤šäº†ä¸€äº› methodï¼Œå¦‚`df.is_largest()`, `df.sustain()`...ç­‰ã€‚
2. åœ¨åšå››å‰‡é‹ç®—ã€ä¸ç­‰å¼é‹ç®—å‰ï¼Œæœƒå°‡ df1ã€df2 çš„ index å–è¯é›†ï¼Œcolumn å–äº¤é›†ã€‚
"""

@property
def _constructor(self):
    return FinlabDataFrame

@staticmethod
def reshape(df1, df2):

    isfdf1 = isinstance(df1, FinlabDataFrame)
    isfdf2 = isinstance(df2, FinlabDataFrame)
    isdf1 = isinstance(df1, pd.DataFrame)
    isdf2 = isinstance(df2, pd.DataFrame)

    both_are_dataframe = (isfdf1 + isdf1) * (isfdf2 + isdf2) != 0

    d1_index_freq = df1.get_index_str_frequency() if isfdf1 else None
    d2_index_freq = df2.get_index_str_frequency() if isfdf2 else None

    if ((d1_index_freq or d2_index_freq)
      and (d1_index_freq != d2_index_freq)
      and both_are_dataframe):

        df1 = df1.index_str_to_date() if isfdf1 else df1
        df2 = df2.index_str_to_date() if isfdf2 else df2

    if isinstance(df2, pd.Series):
        df2 = pd.DataFrame({c: df2 for c in df1.columns})

    if both_are_dataframe:
        index = df1.index.union(df2.index)
        columns = df1.columns.intersection(df2.columns)

        if len(df1.index) * len(df2.index) != 0:
          index_start = max(df1.index[0], df2.index[0])
          index = [t for t in index if index_start &lt;= t]

        return df1.reindex(index=index, method='ffill')[columns], \
            df2.reindex(index=index, method='ffill')[columns]
    else:
        return df1, df2

def __lt__(self, other):
    df1, df2 = self.reshape(self, other)
    return pd.DataFrame.__lt__(df1, df2)

def __gt__(self, other):
    df1, df2 = self.reshape(self, other)
    return pd.DataFrame.__gt__(df1, df2)

def __le__(self, other):
    df1, df2 = self.reshape(self, other)
    return pd.DataFrame.__le__(df1, df2)

def __ge__(self, other):
    df1, df2 = self.reshape(self, other)
    return pd.DataFrame.__ge__(df1, df2)

def __eq__(self, other):
    df1, df2 = self.reshape(self, other)
    return pd.DataFrame.__eq__(df1, df2)

def __ne__(self, other):
    df1, df2 = self.reshape(self, other)
    return pd.DataFrame.__ne__(df1, df2)

def __sub__(self, other):
    df1, df2 = self.reshape(self, other)
    return pd.DataFrame.__sub__(df1, df2)

def __add__(self, other):
    df1, df2 = self.reshape(self, other)
    return pd.DataFrame.__add__(df1, df2)

def __mul__(self, other):
    df1, df2 = self.reshape(self, other)
    return pd.DataFrame.__mul__(df1, df2)

def __truediv__(self, other):
    df1, df2 = self.reshape(self, other)
    return pd.DataFrame.__truediv__(df1, df2)

def __rshift__(self, other):
    return self.shift(-other)

def __lshift__(self, other):
    return self.shift(other)

def __and__(self, other):
    df1, df2 = self.reshape(self, other)
    return pd.DataFrame.__and__(df1, df2)

def __or__(self, other):
    df1, df2 = self.reshape(self, other)
    return pd.DataFrame.__or__(df1, df2)

def __getitem__(self, other):
    df1, df2 = self.reshape(self, other)
    return pd.DataFrame.__getitem__(df1, df2)

def index_str_to_date(self):
  """è²¡å‹™æœˆå­£å ±ç´¢å¼•æ ¼å¼è½‰æ›

    å°‡ä»¥ä¸‹è³‡æ–™çš„ç´¢å¼•è½‰æ›æˆdatetimeæ ¼å¼:

    æœˆç‡Ÿæ”¶ (ex:2022-M1) å¾æ–‡å­—æ ¼å¼è½‰ç‚ºå…¬å‘Šæˆªæ­¢æ—¥ã€‚

    è²¡å‹™å­£å ± (ex:2022-Q1) å¾æ–‡å­—æ ¼å¼è½‰ç‚ºè²¡å ±é›»å­æª”è³‡æ–™ä¸Šå‚³æ—¥ã€‚

    é€šå¸¸ä½¿ç”¨æƒ…å¢ƒç‚ºå°ä¸åŒé€±æœŸçš„dataframeåšreindexï¼Œå¸¸ç”¨æ–¼ä»¥å…¬å‘Šæˆªæ­¢æ—¥ä½œç‚ºè¨Šè™Ÿç”¢ç”Ÿæ—¥ã€‚

    Returns:
      (pd.DataFrame): data
    Examples:

        ```py
        data.get('monthly_revenue:ç•¶æœˆç‡Ÿæ”¶').index_str_to_date()
        data.get('financial_statement:ç¾é‡‘åŠç´„ç•¶ç¾é‡‘').index_str_to_date()
        ```
  """
  if len(self.index) == 0 or not isinstance(self.index[0], str):
    return self

  if self.index[0].find('M') != -1:
    return self._index_str_to_date_month()
  elif self.index[0].find('Q') != -1:
    return self._index_str_to_date_season()

  return self

@staticmethod
def to_business_day(date):

    def skip_weekend(d):
        add_days = {5: 2, 6: 1}
        wd = d.weekday()
        if wd in add_days: d += datetime.timedelta(days=add_days[wd])
        return d

    close = data.get('price:æ”¶ç›¤åƒ¹')
    return pd.Series(date).apply(lambda d: skip_weekend(d) if d in close.index or d &lt; close.index[0] or d &gt; close.index[-1] else close.loc[d:].index[0]).values

def get_index_str_frequency(self):

    if len(self.index) == 0:
      return None

    if not isinstance(self.index[0], str):
      return None

    if (self.index.str.find('M') != -1).all():
      return 'month'

    if (self.index.str.find('Q') != -1).all():
      return 'season'

    return None

def _index_date_to_str_month(self):

    # index is already str
    if len(self.index) == 0 or not isinstance(self.index[0], pd.Timestamp):
      return self

    index = (self.index - datetime.timedelta(days=30)).strftime('%Y-M%m')
    return FinlabDataFrame(self.values, index=index, columns=self.columns)

def _index_str_to_date_month(self):

    # index is already timestamps
    if len(self.index) == 0 or not isinstance(self.index[0], str):
      return self

    if not (self.index.str.find('M') != -1).all():
      logger.warning('FinlabDataFrame: invalid index, cannot format index to monthly timestamp.')
      return self

    index = pd.to_datetime(self.index, format='%Y-M%m') + pd.offsets.MonthBegin() + datetime.timedelta(days=9)
    # chinese new year and covid-19 impact monthly revenue deadline
    replacements = {
                    datetime.datetime(2020, 2, 10): datetime.datetime(2020, 2, 15),
                    datetime.datetime(2021, 2, 10): datetime.datetime(2021, 2, 15),
                    datetime.datetime(2022, 2, 10): datetime.datetime(2022, 2, 14),
                    }
    replacer = replacements.get
    index = [replacer(n, n) for n in index]

    index = self.to_business_day(index)

    ret = FinlabDataFrame(self.values, index=index, columns=self.columns)
    ret.index.name = 'date'
 
    return ret
def _index_date_to_str_season(self):

    # index is already str
    if len(self.index) == 0 or not isinstance(self.index[0], pd.Timestamp):
      return self

    q = self.index.strftime('%m').astype(int).map({5:1, 8:2, 9:2, 10:3, 11:3, 3:4, 4:4})
    year = self.index.year.copy()
    year -= (q == 4)
    index = year.astype(str) + '-Q' + q.astype(str)

    return FinlabDataFrame(self.values, index=index, columns=self.columns)

def deadline(self):
    """è²¡å‹™å­£å ±ç´¢å¼•è½‰æ›æˆå…¬å‘Šæˆªæ­¢æ—¥

      å°‡è²¡å‹™å­£å ± (ex:2022Q1) å¾æ–‡å­—æ ¼å¼è½‰ç‚ºå…¬å‘Šæˆªæ­¢æ—¥çš„datetimeæ ¼å¼ï¼Œ
      é€šå¸¸ä½¿ç”¨æƒ…å¢ƒç‚ºå°ä¸åŒé€±æœŸçš„dataframeåšreindexï¼Œå¸¸ç”¨æ–¼ä»¥å…¬å‘Šæˆªæ­¢æ—¥ä½œç‚ºè¨Šè™Ÿç”¢ç”Ÿæ—¥ã€‚
      Returns:
        (pd.DataFrame): data
      Examples:
          ```py
          data.get('financial_statement:ç¾é‡‘åŠç´„ç•¶ç¾é‡‘').deadline()
          ```
    """
    return self._index_str_to_date_season(detail=False)

def _index_str_to_date_season(self, detail=True):

  disclosure_dates = (calc_disclosure_dates(detail)
                      .reindex_like(self)
                      .unstack())

  self.columns.name = 'stock_id'

  unstacked = self.unstack()

  ret = (pd.DataFrame({
      'value': unstacked.values,
      'disclosures': disclosure_dates.values,
    }, unstacked.index)
    .reset_index()
    .drop_duplicates(['disclosures', 'stock_id'])
    .pivot(index='disclosures', columns='stock_id', values='value').ffill()
    .pipe(lambda df: df.loc[df.index.notna()])
    .pipe(lambda df: FinlabDataFrame(df))
    .rename_axis('date')
  )

  if not detail:
      ret.index = self.to_business_day(ret.index)

  return ret

def average(self, n):
    """å– n ç­†ç§»å‹•å¹³å‡

    è‹¥è‚¡ç¥¨åœ¨æ™‚é–“çª—æ ¼å…§ï¼Œæœ‰ N/2 ç­† NaNï¼Œå‰‡æœƒç”¢ç”Ÿ NaNã€‚
    Args:
      n (positive-int): è¨­å®šç§»å‹•çª—æ ¼æ•¸ã€‚
    Returns:
      (pd.DataFrame): data
    Examples:
        è‚¡åƒ¹åœ¨å‡ç·šä¹‹ä¸Š
        ```py
        from finlab import data
        close = data.get('price:æ”¶ç›¤åƒ¹')
        sma = close.average(10)
        cond = close &gt; sma
        ```
        åªéœ€è¦ç°¡å–®çš„èªæ³•ï¼Œå°±å¯ä»¥å°‡å…¶ä¸­ä¸€éƒ¨åˆ†çš„è¨Šè™Ÿç¹ªè£½å‡ºä¾†æª¢æŸ¥ï¼š
        ```py
        import matplotlib.pyplot as plt

        close.loc['2021', '2330'].plot()
        sma.loc['2021', '2330'].plot()
        cond.loc['2021', '2330'].mul(20).add(500).plot()

        plt.legend(['close', 'sma', 'cond'])
        ```
        &lt;img src="https://i.ibb.co/Mg1P85y/sma.png" alt="sma"&gt;
    """
    return self.rolling(n, min_periods=int(n/2)).mean()

def is_largest(self, n):
    """å–æ¯åˆ—å‰ n ç­†å¤§çš„æ•¸å€¼

    è‹¥ç¬¦åˆ `True` ï¼Œåä¹‹ç‚º `False` ã€‚ç”¨ä¾†ç¯©é¸æ¯å¤©æ•¸å€¼æœ€å¤§çš„è‚¡ç¥¨ã€‚

    &lt;img src="https://i.ibb.co/8rh3tbt/is-largest.png" alt="is-largest"&gt;
    Args:
      n (positive-int): è¨­å®šæ¯åˆ—å‰ n ç­†å¤§çš„æ•¸å€¼ã€‚
    Returns:
      (pd.DataFrame): data
    Examples:
        æ¯å­£ ROA å‰ 10 åçš„è‚¡ç¥¨
        ```py
        from finlab import data

        roa = data.get('fundamental_features:ROAç¨…å¾Œæ¯å‰')
        good_stocks = roa.is_largest(10)
        ```
    """
    return self.astype(float).apply(lambda s: s.nlargest(n), axis=1).reindex_like(self).notna()

def is_smallest(self, n):
    """å–æ¯åˆ—å‰ n ç­†å°çš„æ•¸å€¼

    è‹¥ç¬¦åˆ `True` ï¼Œåä¹‹ç‚º `False` ã€‚ç”¨ä¾†ç¯©é¸æ¯å¤©æ•¸å€¼æœ€å°çš„è‚¡ç¥¨ã€‚
    Args:
      n (positive-int): è¨­å®šæ¯åˆ—å‰ n ç­†å°çš„æ•¸å€¼ã€‚
    Returns:
      (pd.DataFrame): data
    Examples:
        è‚¡åƒ¹æ·¨å€¼æ¯”æœ€å°çš„ 10 æª”è‚¡ç¥¨
        ```py
        from finlab import data

        pb = data.get('price_earning_ratio:è‚¡åƒ¹æ·¨å€¼æ¯”')
        cheap_stocks = pb.is_smallest(10)
        ```
    """
    return self.astype(float).apply(lambda s: s.nsmallest(n), axis=1).reindex_like(self).notna()

def is_entry(self):
    """é€²å ´é»

    å–é€²å ´è¨Šè™Ÿé»ï¼Œè‹¥ç¬¦åˆæ¢ä»¶çš„å€¼å‰‡ç‚ºTrueï¼Œåä¹‹ç‚ºFalseã€‚
    Returns:
      (pd.DataFrame): data
    Examples:
      ç­–ç•¥ç‚ºæ¯æ—¥æ”¶ç›¤åƒ¹å‰10é«˜ï¼Œå–é€²å ´é»ã€‚
        ```py
        from finlab import data
        data.get('price:æ”¶ç›¤åƒ¹').is_largest(10).is_entry()
        ```
    """
    return (self &amp; ~self.shift(fill_value=False))

def is_exit(self):
    """å‡ºå ´é»

    å–å‡ºå ´è¨Šè™Ÿé»ï¼Œè‹¥ç¬¦åˆæ¢ä»¶çš„å€¼å‰‡ç‚º Trueï¼Œåä¹‹ç‚º Falseã€‚
    Returns:
      (pd.DataFrame): data
    Examples:
      ç­–ç•¥ç‚ºæ¯æ—¥æ”¶ç›¤åƒ¹å‰10é«˜ï¼Œå–å‡ºå ´é»ã€‚
        ```py
        from finlab import data
        data.get('price:æ”¶ç›¤åƒ¹').is_largest(10).is_exit()
        ```
    """
    return (~self &amp; self.shift(fill_value=False))

def rise(self, n=1):
    """æ•¸å€¼ä¸Šå‡ä¸­

    å–æ˜¯å¦æ¯”å‰ç¬¬nç­†é«˜ï¼Œè‹¥ç¬¦åˆæ¢ä»¶çš„å€¼å‰‡ç‚ºTrueï¼Œåä¹‹ç‚ºFalseã€‚
    &lt;img src="https://i.ibb.co/Y72bN5v/Screen-Shot-2021-10-26-at-6-43-41-AM.png" alt="Screen-Shot-2021-10-26-at-6-43-41-AM"&gt;
    Args:
      n (positive-int): è¨­å®šæ¯”è¼ƒå‰ç¬¬nç­†é«˜ã€‚
    Returns:
      (pd.DataFrame): data
    Examples:
        æ”¶ç›¤åƒ¹æ˜¯å¦é«˜æ–¼10æ—¥å‰è‚¡åƒ¹
        ```py
        from finlab import data
        data.get('price:æ”¶ç›¤åƒ¹').rise(10)
        ```
    """
    return self &gt; self.shift(n)

def fall(self, n=1):
    """æ•¸å€¼ä¸‹é™ä¸­

    å–æ˜¯å¦æ¯”å‰ç¬¬nç­†ä½ï¼Œè‹¥ç¬¦åˆæ¢ä»¶çš„å€¼å‰‡ç‚ºTrueï¼Œåä¹‹ç‚ºFalseã€‚
    &lt;img src="https://i.ibb.co/Y72bN5v/Screen-Shot-2021-10-26-at-6-43-41-AM.png" alt="Screen-Shot-2021-10-26-at-6-43-41-AM"&gt;
    Args:
      n (positive-int): è¨­å®šæ¯”è¼ƒå‰ç¬¬nç­†ä½ã€‚
    Returns:
      (pd.DataFrame): data
    Examples:
        æ”¶ç›¤åƒ¹æ˜¯å¦ä½æ–¼10æ—¥å‰è‚¡åƒ¹
        ```py
        from finlab import data
        data.get('price:æ”¶ç›¤åƒ¹').fall(10)
        ```
    """
    return self &lt; self.shift(n)

def groupby_category(self):
    """è³‡æ–™æŒ‰ç”¢æ¥­åˆ†ç¾¤

    é¡ä¼¼ `pd.DataFrame.groupby()`çš„è™•ç†æ•ˆæœã€‚
    Returns:
      (pd.DataFrame): data
    Examples:
      åŠå°é«”å¹³å‡è‚¡åƒ¹æ·¨å€¼æ¯”æ™‚é–“åºåˆ—
        ```py
        from finlab import data
        pe = data.get('price_earning_ratio:è‚¡åƒ¹æ·¨å€¼æ¯”')
        pe.groupby_category().mean()['åŠå°é«”'].plot()
        ```
        &lt;img src="https://i.ibb.co/Tq2fKBp/pbmean.png" alt="pbmean"&gt;

        å…¨çƒ 2020 é‡åŒ–å¯¬é¬†åŠ ä¸Šæ™¶ç‰‡çŸ­ç¼ºï¼Œä½¿å¾—åŠå°é«”è‚¡åƒ¹æ·¨å€¼æ¯”è¡é«˜ã€‚
    """
    categories = data.get('security_categories')
    cat = categories.set_index('stock_id').category.to_dict()
    org_set = set(cat.values())
    set_remove_illegal = set(
        o for o in org_set if isinstance(o, str) and o != 'nan')
    set_remove_illegal

    refine_cat = {}
    for s, c in cat.items():
        if c == None or c == 'nan':
            refine_cat[s] = 'å…¶ä»–'
            continue

        if c == 'é›»è…¦åŠé€±é‚Š':
            refine_cat[s] = 'é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­'
            continue

        if c[-1] == 'æ¥­' and c[:-1] in set_remove_illegal:
            refine_cat[s] = c[:-1]
        else:
            refine_cat[s] = c

    col_categories = pd.Series(self.columns.map(
        lambda s: refine_cat[s] if s in cat else 'å…¶ä»–'))

    return self.groupby(col_categories.values, axis=1)

def entry_price(self, trade_at='close'):

    signal = self.is_entry()
    adj = data.get('etl:adj_close') if trade_at == 'close' else data.get(
        'etl:adj_open')
    adj, signal = adj.reshape(
        adj.loc[signal.index[0]: signal.index[-1]], signal)
    return adj.bfill()[signal.shift(fill_value=False)].ffill()

def sustain(self, nwindow, nsatisfy=None):
    """æŒçºŒ N å¤©æ»¿è¶³æ¢ä»¶

    å–ç§»å‹• nwindow ç­†åŠ ç¸½å¤§æ–¼ç­‰æ–¼nsatisfyï¼Œè‹¥ç¬¦åˆæ¢ä»¶çš„å€¼å‰‡ç‚ºTrueï¼Œåä¹‹ç‚ºFalseã€‚

    Args:
      nwindow (positive-int): è¨­å®šç§»å‹•çª—æ ¼ã€‚
      nsatisfy (positive-int): è¨­å®šç§»å‹•çª—æ ¼è¨ˆç®—å¾Œæœ€ä½æ»¿è¶³æ•¸å€¼ã€‚
    Returns:
      (pd.DataFrame): data
    Examples:
        æ”¶ç›¤åƒ¹æ˜¯å¦é€£å…©æ—¥ä¸Šæ¼²
        ```py
        from finlab import data
        data.get('price:æ”¶ç›¤åƒ¹').rise().sustain(2)
        ```
    """
    nsatisfy = nsatisfy or nwindow
    return self.rolling(nwindow).sum() &gt;= nsatisfy

def industry_rank(self, categories=None):
    """è¨ˆç®—ç”¢æ¥­ ranking æ’åï¼Œ0 ä»£è¡¨ç”¢æ¥­å…§æœ€ä½ï¼Œ1 ä»£è¡¨ç”¢æ¥­å…§æœ€é«˜
    Args:
      categories (list of str): æ¬²è€ƒæ…®çš„ç”¢æ¥­ï¼Œex: ['è²¿æ˜“ç™¾è²¨', 'é›²ç«¯é‹ç®—']ï¼Œé è¨­ç‚ºå…¨ç”¢æ¥­ï¼Œè«‹åƒè€ƒ `data.get('security_industry_themes')` ä¸­çš„ç”¢æ¥­é …ç›®ã€‚
    Examples:
        æœ¬æ„æ¯”ç”¢æ¥­æ’ååˆ†æ•¸
        ```py
        from finlab import data

        pe = data.get('price_earning_ratio:æœ¬ç›Šæ¯”')
        pe_rank = pe.industry_rank()
        print(pe_rank)
        ```
    """

    themes = (data.get('security_industry_themes')
        .copy() # è¤‡è£½
        .assign(category=lambda self: self.category
            .apply(lambda s: eval(s))) # å¾æ–‡å­—æ ¼å¼è½‰æˆé™£åˆ—æ ¼
        .explode('category') # å±•é–‹è³‡æ–™
    )

    categories = (categories 
        or set(themes.category[themes.category.str.find(':') == -1]))

    def calc_rank(ind):
        stock_ids = themes.stock_id[themes.category == ind]
        return (self[stock_ids].pipe(lambda self: self.rank(axis=1, pct=True)))

    return (pd.concat([calc_rank(ind) for ind in categories],axis=1)
        .groupby(level=0, axis=1).mean())

def quantile_row(self, c):
    """è‚¡ç¥¨ç•¶å¤©æ•¸å€¼åˆ†ä½æ•¸

    å–å¾—æ¯åˆ—cå®šåˆ†ä½æ•¸çš„å€¼ã€‚
    Args:
      c (positive-int): è¨­å®šæ¯åˆ— n å®šåˆ†ä½æ•¸çš„å€¼ã€‚
    Returns:
      (pd.DataFrame): data
    Examples:
        å–æ¯æ—¥è‚¡åƒ¹å‰90ï¼…åˆ†ä½æ•¸
        ```py
        from finlab import data
        data.get('price:æ”¶ç›¤åƒ¹').quantile_row(0.9)
        ```
    """
    s = self.quantile(c, axis=1)
    return s

def exit_when(self, exit):

    df, exit = self.reshape(self, exit)

    df.fillna(False, inplace=True)
    exit.fillna(False, inplace=True)

    entry_signal = df.is_entry()
    exit_signal = df.is_exit()
    exit_signal |= exit

    # build position using entry_signal and exit_signal
    position = pd.DataFrame(np.nan, index=df.index, columns=df.columns)
    position[entry_signal] = 1
    position[exit_signal] = 0

    position.ffill(inplace=True)
    position = position == 1
    position.fillna(False)
    return position

def hold_until(self, exit, nstocks_limit=None, stop_loss=-np.inf, take_profit=np.inf, trade_at='close', rank=None):
    """è¨Šè™Ÿé€²å‡ºå ´

    é€™å¤§æ¦‚æ˜¯æ‰€æœ‰ç­–ç•¥æ’°å¯«ä¸­ï¼Œæœ€é‡è¦çš„èªæ³•ç³–ï¼Œä¸Šè¿°èªæ³•ä¸­ `entries` ç‚ºé€²å ´è¨Šè™Ÿï¼Œè€Œ `exits` æ˜¯å‡ºå ´è¨Šè™Ÿã€‚æ‰€ä»¥ `entries.hold_until(exits)` ï¼Œå°±æ˜¯é€²å ´è¨Šè™Ÿç‚º `True` æ™‚ï¼Œè²·å…¥ä¸¦æŒæœ‰è©²æª”è‚¡ç¥¨ï¼Œç›´åˆ°å‡ºå ´è¨Šè™Ÿç‚º `True ` å‰‡è³£å‡ºã€‚
    &lt;img src="https://i.ibb.co/PCt4hPd/Screen-Shot-2021-10-26-at-6-35-05-AM.png" alt="Screen-Shot-2021-10-26-at-6-35-05-AM"&gt;
    æ­¤å‡½å¼æœ‰å¾ˆå¤šç´°éƒ¨è¨­å®šï¼Œå¯ä»¥è®“ä½ æœ€å¤šé¸æ“‡ N æª”è‚¡ç¥¨åšè¼ªå‹•ã€‚å¦å¤–ï¼Œç•¶è¶…é N æª”é€²å ´è¨Šè™Ÿç™¼ç”Ÿï¼Œä¹Ÿå¯ä»¥æŒ‰ç…§å®¢è£½åŒ–çš„æ’åºï¼Œé¸æ“‡å„ªå…ˆé¸å…¥çš„è‚¡ç¥¨ã€‚æœ€å¾Œï¼Œå¯ä»¥è¨­å®šåƒ¹æ ¼æ³¢å‹•ç•¶è¼ªå‹•è¨Šè™Ÿï¼Œä¾†å¢åŠ å‡ºå ´çš„æ™‚æ©Ÿé»ã€‚

    Args:
      exit (pd.Dataframe): å‡ºå ´è¨Šè™Ÿã€‚
      nstocks_limit (int)`: è¼ªå‹•æª”æ•¸ä¸Šé™ï¼Œé è¨­ç‚ºNoneã€‚
      stop_loss (float): åƒ¹æ ¼æ³¢å‹•è¼ªå‹•è¨Šè™Ÿï¼Œé è¨­ç‚ºNoneï¼Œä¸ç”Ÿæˆè¼ªå‹•è¨Šè™Ÿã€‚ç¯„ä¾‹ï¼š0.1ï¼Œä»£è¡¨æˆæœ¬åƒ¹ä¸‹è·Œ 10% æ™‚ç”¢ç”Ÿå‡ºå ´è¨Šè™Ÿã€‚
      take_profit (float): åƒ¹æ ¼æ³¢å‹•è¼ªå‹•è¨Šè™Ÿï¼Œé è¨­ç‚ºNoneï¼Œä¸ç”Ÿæˆè¼ªå‹•è¨Šè™Ÿã€‚ç¯„ä¾‹ï¼š0.1ï¼Œä»£è¡¨æˆæœ¬åƒ¹ä¸Šæ¼² 10% æ™‚ç”¢ç”Ÿå‡ºå ´è¨Šè™Ÿã€‚
      trade_at (str): åƒ¹æ ¼æ³¢å‹•è¼ªå‹•è¨Šè™Ÿåƒè€ƒåƒ¹ï¼Œé è¨­ç‚º'close'ã€‚å¯é¸ `close` æˆ– `open`ã€‚
      rank (pd.Dataframe): ç•¶å¤©é€²å ´è¨Šè™Ÿæ•¸é‡è¶…é nstocks_limit æ™‚ï¼Œä»¥ rank æ•¸å€¼è¶Šå¤§çš„è‚¡ç¥¨å„ªå…ˆé€²å ´ã€‚
    Returns:
      (pd.DataFrame): data
    Examples:
        åƒ¹æ ¼ &gt; 20 æ—¥å‡ç·šå…¥å ´, åƒ¹æ ¼ &lt; 60 æ—¥å‡ç·šå‡ºå ´ï¼Œæœ€å¤šæŒæœ‰10æª”ï¼Œè¶…é 10 å€‹é€²å ´è¨Šè™Ÿï¼Œå‰‡ä»¥è‚¡åƒ¹æ·¨å€¼æ¯”å°çš„è‚¡ç¥¨å„ªå…ˆé¸å…¥ã€‚

        ```python
        from finlab import data
        from finlab.backtest import sim

        close = data.get('price:æ”¶ç›¤åƒ¹')
        pb = data.get('price_earning_ratio:è‚¡åƒ¹æ·¨å€¼æ¯”')

        sma20 = close.average(20)
        sma60 = close.average(60)

        entries = close &gt; sma20
        exits = close &lt; sma60

        ï¼ƒpbå‰10å°çš„æ¨™çš„åšè¼ªå‹•
        position = entries.hold_until(exits, nstocks_limit=10, rank=-pb)
        sim(position)
        ```
    """
    if nstocks_limit is None:
        nstocks_limit = len(self.columns)

    union_index = self.index.union(exit.index)
    intersect_col = self.columns.intersection(exit.columns)

    if stop_loss != -np.inf or take_profit != np.inf:
        price = data.get(f'etl:adj_{trade_at}')
        union_index = union_index.union(
            price.loc[union_index[0]: union_index[-1]].index)
        intersect_col = intersect_col.intersection(price.columns)
    else:
        price = pd.DataFrame()

    if rank is not None:
        union_index = union_index.union(rank.index)
        intersect_col = intersect_col.intersection(rank.columns)

    entry = self.reindex(union_index, columns=intersect_col,
                         method='ffill').ffill().fillna(False)
    exit = exit.reindex(union_index, columns=intersect_col,
                        method='ffill').ffill().fillna(False)

    if price is not None:
        price = price.reindex(
            union_index, columns=intersect_col, method='ffill')

    if rank is not None:
        rank = rank.reindex(
            union_index, columns=intersect_col, method='ffill')
    else:
        rank = pd.DataFrame(1, index=union_index, columns=intersect_col)

    max_rank = rank.max().max()
    min_rank = rank.min().min()
    rank = (rank - min_rank) / (max_rank - min_rank)
    rank.fillna(0, inplace=True)

    def rotate_stocks(ret, entry, exit, nstocks_limit, stop_loss=-np.inf, take_profit=np.inf, price=None, ranking=None):

        nstocks = 0

        ret[0][np.argsort(entry[0])[-nstocks_limit:]] = 1
        ret[0][exit[0] == 1] = 0
        ret[0][entry[0] == 0] = 0

        entry_price = np.empty(entry.shape[1])
        entry_price[:] = np.nan

        for i in range(1, entry.shape[0]):

            # regitser entry price
            if stop_loss != -np.inf or take_profit != np.inf:
                is_entry = ((ret[i-2] == 0) if i &gt;
                            1 else (ret[i-1] == 1))

                is_waiting_for_entry = np.isnan(entry_price) &amp; (ret[i-1] == 1)

                is_entry |= is_waiting_for_entry

                entry_price[is_entry == 1] = price[i][is_entry == 1]

                # check stop_loss and take_profit
                returns = price[i] / entry_price
                stop = (returns &gt; 1 + abs(take_profit)
                        ) | (returns &lt; 1 - abs(stop_loss))
                exit[i] |= stop

            # run signal
            rank = (entry[i] * ranking[i] + ret[i-1] * 3)
            rank[exit[i] == 1] = -1
            rank[(entry[i] == 0) &amp; (ret[i-1] == 0)] = -1

            ret[i][np.argsort(rank)[-nstocks_limit:]] = 1
            ret[i][rank == -1] = 0

        return ret

    ret = pd.DataFrame(0, index=entry.index, columns=entry.columns)
    ret = rotate_stocks(ret.values,
                        entry.astype(int).values,
                        exit.astype(int).values,
                        nstocks_limit,
                        stop_loss,
                        take_profit,
                        price=price.values,
                        ranking=rank.values)

    return pd.DataFrame(ret, index=entry.index, columns=entry.columns)
</code></pre>
<p>@functools.lru_cache
def calc_disclosure_dates(detail=True):</p>
<p>cinfo = data.get('company_basic_info').copy()
cinfo['id'] = cinfo.stock_id.str.split(' ').str[0]
cinfo = cinfo.set_index('id')
cinfo = cinfo[~cinfo.index.duplicated(keep='last')]</p>
<p>def calc_default_disclosure_dates(s):
sid = s.name
cat = cinfo.loc[sid].ç”¢æ¥­é¡åˆ¥ if sid in cinfo.index else 'etf'
short_name = cinfo.loc[sid].å…¬å¸ç°¡ç¨± if sid in cinfo.index else 'etf'</p>
<pre><code>if cat == 'é‡‘èæ¥­':
  calendar = {
    '1': '-05-15',
    '2': '-08-31',
    '3': '-11-14',
    '4': '-03-31',
  }
elif cat == 'é‡‘èä¿éšªæ¥­':
  calendar = {
    '1': '-04-30',
    '2': '-08-31',
    '3': '-10-31',
    '4': '-03-31',
  }
elif 'KY' in short_name:
    calendar = {
    'old':{
        '1': '-05-15',
        '2': '-08-14',
        '3': '-11-14',
        '4': '-03-31',
          },
    'new':{
        '1': '-05-15',
        '2': '-08-31',
        '3': '-11-14',
        '4': '-03-31',
          },
    }
else:
  calendar = {
    '1': '-05-15',
    '2': '-08-14',
    '3': '-11-14',
    '4': '-03-31',
  }
get_year = lambda year, season: str(year) if int(season) != 4 else str(int(year) + 1)
ky_policy_check = lambda year: 'new' if year &gt;= '2021' else 'old'
return pd.to_datetime(s.index.map(lambda d: get_year(d[:4], d[-1]) + calendar[ky_policy_check(d[:4])][d[-1]]) if 'KY' in short_name else s.index.map(lambda d: get_year(d[:4], d[-1]) + calendar[d[-1]]))
</code></pre>
<p>def season_end(s):</p>
<pre><code>calendar = {
  '1': '-3-31',
  '2': '-6-30',
  '3': '-9-30',
  '4': '-12-31',
}
return pd.to_datetime(s.index.map(lambda d: d[:4] + calendar[d[-1]]))
</code></pre>
<p>disclosure_dates = data.get('financial_statements_upload_detail:upload_date')
disclosure_dates = disclosure_dates.apply(pd.to_datetime)</p>
<p>financial_season_end = disclosure_dates.apply(season_end)
default_disclosure_dates = disclosure_dates.apply(calc_default_disclosure_dates)</p>
<p>disclosure_dates[(disclosure_dates &gt; default_disclosure_dates)
| (disclosure_dates &lt; financial_season_end)] = pd.NaT
disclosure_dates[(disclosure_dates.diff() &lt;= datetime.timedelta(days=0))] = pd.NaT
disclosure_dates.loc['2019-Q1', '3167'] = pd.NaT
disclosure_dates.loc['2015-Q1', '5536'] = pd.NaT
disclosure_dates.loc['2018-Q1', '5876'] = pd.NaT</p>
<p>disclosure_dates = disclosure_dates.fillna(default_disclosure_dates)
disclosure_dates.columns.name = 'stock_id'</p>
<p>if detail:
return disclosure_dates
return default_disclosure_dates</p>
<pre><code>
## æœ¬ç›Šæˆé•·æ¯”(æœˆç‡Ÿæ”¶æˆªæ­¢æ—¥æ›è‚¡)

https://doc.finlab.tw/tools/guide_for_beginners/

```python
from finlab import data
from finlab.backtest import sim
import finlab

finlab.login("cdnE+4n53DXjKkN8J7spHLvPq3xwycL6gfd0PaUL+UDWOAKroWHcXUNsN82ibihU#free")


rev = data.get('monthly_revenue:ç•¶æœˆç‡Ÿæ”¶')
rev_ma3 = rev.average(3)
rev_ma12 = rev.average(12)

# ç‡Ÿæ”¶è¶¨å‹¢å¤šé ­ç­–ç•¥
cond1 = rev_ma3/rev_ma12 &gt; 1.1
cond2 = rev/rev.shift(1) &gt; 0.9
cond_all = cond1 &amp; cond2

pe = data.get('price_earning_ratio:æœ¬ç›Šæ¯”')
ç‡Ÿæ¥­åˆ©ç›Šæˆé•·ç‡ = data.get('fundamental_features:ç‡Ÿæ¥­åˆ©ç›Šæˆé•·ç‡')

# æœ¬ç›Šæˆé•·æ¯”
peg = (pe/ç‡Ÿæ¥­åˆ©ç›Šæˆé•·ç‡)

# æœ¬ç›Šæˆé•·æ¯”å’ŒåŸè¨Šè™Ÿç›¸ä¹˜ï¼Œè‹¥ä¸æŒæœ‰å‰‡ç›¸ä¹˜å¾Œç­‰æ–¼0
position = peg*(cond_all)

# åŸè¨Šè™Ÿç‚º0çš„ä¸è¦é¸ï¼Œè‹¥æ²’åŠ é€™è¡Œä¸”ç­–ç•¥åªé¸åˆ°7æª”ï¼Œä¹‹å¾Œé‚„æ˜¯æœƒé¸3æª”è¨Šè™Ÿç‚º0(ä¸æŒæœ‰)çš„è£œè¶³10æª”ï¼ŒåŸ·è¡Œé€™è¡Œå°±æœƒæ’é™¤è¨Šè™Ÿç‚º0ã€‚
position = position[position&gt;0]

# é¸è‚¡æŒ‘æœ¬ç›Šæˆé•·æ¯”å‰10å°çš„
position = position.is_smallest(10)

print(position)



# æœˆç‡Ÿæ”¶æˆªæ­¢æ—¥æ›è‚¡
position = position.reindex(rev.index_str_to_date().index, method='ffill')
print(position)
input()
report = sim(position=position, name="ç­–ç•¥æ•™å­¸ç¯„ä¾‹:peg_rev", stop_loss=0.1, upload=False)
report.display()
</code></pre>
<h2 id="è‚¡åƒ¹æ·¨å€¼æ¯”"><a class="header" href="#è‚¡åƒ¹æ·¨å€¼æ¯”">è‚¡åƒ¹æ·¨å€¼æ¯”</a></h2>
<pre><code class="language-python">from finlab import data
from finlab.backtest import sim

pb = data.get('price_earning_ratio:è‚¡åƒ¹æ·¨å€¼æ¯”')
close = data.get('price:æ”¶ç›¤åƒ¹')

position = (1/(pb * close) * (close &gt; close.average(60)) * (close &gt; 5)).is_largest(20)
report = sim(position, resample='Q',mae_mfe_window=30,mae_mfe_window_step=2)
report.display_mae_mfe_analysis()
</code></pre>
<h2 id="is_smallest"><a class="header" href="#is_smallest">is_smallest</a></h2>
<pre><code class="language-python">import pandas as pd

def is_smallest(df, n):
    return df.astype(float).apply(lambda s: s.nsmallest(n), axis=1).reindex_like(df).notna()

df = pd.DataFrame({
    'A': [1.2, 2.5, 3.1],
    'B': [2.2, 1.8, 5.5],
    'C': [3.3, 4.5, 0.7],
    'D': [4.4, 5.5, 2.2],
    'E': [5.5, 3.3, 4.4]
})

print(df)
result = is_smallest(df, 2)
print(result)

#é€™å€‹ DataFrame æœ‰ 5 åˆ— 3 è¡Œï¼ŒåŒ…å« 15 å€‹æµ®é»æ•¸å€¼ã€‚ç¾åœ¨éœ€è¦æŒ‰è¡Œæ‰¾åˆ°æ¯è¡Œæœ€å°çš„ 2 å€‹æ•¸å€¼æ‰€åœ¨çš„åˆ—ï¼Œå°‡å…¶å°æ‡‰çš„ç´¢å¼•ç½®ç‚º Trueã€‚
#
#ä½¿ç”¨ä»¥ä¸‹ç¨‹å¼ç¢¼é€²è¡Œè™•ç†ï¼š
#
#è¤‡è£½
#n = 2
#result = df.astype(float).apply(lambda s: s.nsmallest(n), axis=1).reindex_like(df).notna()
#é€™è£¡çš„ n ç‚º 2ï¼Œåœ¨ä¸Šé¢çš„ç¨‹å¼ç¢¼ä¸­ï¼Œå…ˆå°‡ df è½‰æ›ç‚ºæµ®é»æ ¼å¼ï¼Œç„¶å¾ŒæŒ‰è¡Œé€²è¡Œéæ­·ï¼Œå°æ¯ä¸€è¡Œèª¿ç”¨ s.nsmallest(n) å‡½æ•¸æ‰¾åˆ°æœ€å°çš„ 2 å€‹æ•¸å€¼æ‰€åœ¨çš„åˆ—ï¼Œå…¶å®ƒä½ç½®ç½®ç‚º NaNï¼Œè¿”å›ä¸€å€‹ Series å°è±¡ã€‚æ¥è‘—æŠŠé€™å€‹ Series å°è±¡èˆ‡åŸå§‹ DataFrame é€²è¡Œé‡ç´¢å¼•ï¼Œä¸¦ä¸”è£œç¼ºå¤±å€¼ç‚º Falseï¼Œæœ€çµ‚å¾—åˆ°ä¸€å€‹èˆ‡åŸå§‹ DataFrame ä¸€æ¨£å¤§å°çš„å¸ƒæ—å€¼ DataFrameã€‚
#
#åŸ·è¡Œä¸Šè¿°ç¨‹å¼ä¹‹å¾Œï¼Œå¯ä»¥å¾—åˆ°ä»¥ä¸‹çµæœï¼š
#
#è¤‡è£½
#       A      B      C      D      E
#0  False   True  False  False  False
#1   True  False  False  False   True
#2  False   True   True  False  False
#é€™å€‹çµæœçš„å«ç¾©æ˜¯ï¼š
#
#ç¬¬ä¸€è¡Œæœ€å°çš„ 2 å€‹æ•¸å€¼åˆ†åˆ¥ä½æ–¼ B åˆ—ï¼Œå› æ­¤ B åˆ—ç‚º Trueï¼Œå…¶é¤˜ç‚º Falseï¼›
</code></pre>
<h2 id="å¤æ™®å€¼"><a class="header" href="#å¤æ™®å€¼">å¤æ™®å€¼</a></h2>
<p>å‡ºè™•ï¼š https://www.finlab.tw/python%e6%96%b0%e6%89%8b%e6%95%99%e5%ad%b8%ef%bc%9a%e5%a4%8f%e6%99%ae%e6%8c%87%e6%95%b8%e7%ad%96%e7%95%a5/</p>
<pre><code class="language-python">import yfinance as yf
import pandas as pd
import numpy as np

def crawl_price(stock_id):
    stock = yf.Ticker(stock_id)
    df = stock.history(period="max")
    return df


twii = crawl_price("^TWII")
print(twii)
mean = twii['Close'].pct_change().rolling(252).mean()
std = twii['Close'].pct_change().rolling(252).std()

sharpe = mean / std

# sharpe ratio å¹³æ»‘
sr = sharpe
srsma = sr.rolling(60).mean()

# sharpe ratio çš„æ–œç‡
srsmadiff = srsma.diff()

# è¨ˆç®—è²·å…¥è³£å‡ºé»
buy = (srsmadiff &gt; 0) &amp; (srsmadiff.shift() &lt; 0)
sell = (srsmadiff &lt; 0) &amp; (srsmadiff.shift() &gt; 0)

# è¨ˆç®—æŒæœ‰æ™‚é–“
hold = pd.Series(np.nan, index=buy.index)
hold[buy] = 1
hold[sell] = 0
hold.ffill(inplace=True)
hold.plot()

# æŒæœ‰æ™‚å€™çš„ç¸¾æ•ˆ
adj = twii['Close'][buy.index]
(adj.pct_change().shift(-1)+1).fillna(1)[hold == 1].cumprod().plot()


def backtest(a, b, c, d, plot=False):
    sr = sharpe
    srsma = sr.rolling(a).mean()

    srsmadiff = srsma.diff() * 100
    ub = srsmadiff.quantile(b)
    lb = srsmadiff.quantile(c)
    
    buy = ((srsmadiff.shift(d) &lt; lb) &amp; (srsmadiff &gt; ub))
    sell = ((srsmadiff.shift(d) &gt; ub) &amp; (srsmadiff &lt; lb))

    hold = pd.Series(np.nan, index=buy.index)
    hold[buy] = 1
    hold[sell] = 0

    hold.ffill(inplace=True)
    
    adj = twii['Close'][buy.index]

    if plot:
        (adj.pct_change().shift(-1)+1).fillna(1)[hold == 1].cumprod().plot()
        hold.plot()

    eq = (adj.pct_change().shift(-1)+1).fillna(1)[hold == 1].cumprod()
    if len(eq) &gt; 0:
        return eq.iloc[-1]
    else:
        return 1


maxeq = 0
for a in range(100,200,20):
    for b in np.arange(0.3, 0.9, 0.03):
        for c in np.arange(0.3, 0.6, 0.03):
            for d in range(60, 180, 10):
                
                eq = backtest(a,b,c,d)
                
                if maxeq &lt; eq:
                    maxeq = eq
                    print(eq, a,b,c,d)
</code></pre>

                        <script src="https://utteranc.es/client.js"
                            repo="imxood/imxood.github.io"
                            issue-term="pathname"
                            theme="boxy-light"
                            crossorigin="anonymous"
                            async>
                        </script>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../strategy/æŠ•è³‡æŠ•æ©Ÿçš„è§€å¿µèˆ‡å¿ƒå¾—åˆ†äº«.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../strategy/backtrader/basis.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../strategy/æŠ•è³‡æŠ•æ©Ÿçš„è§€å¿µèˆ‡å¿ƒå¾—åˆ†äº«.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../strategy/backtrader/basis.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script type="text/javascript">
            window.playground_line_numbers = true;
        </script>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>

        <script src="../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../theme/custom/mermaid.min.js"></script>
        <script type="text/javascript" src="../theme/custom/mermaid-init.js"></script>


    </body>
</html>
