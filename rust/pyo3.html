<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>PyO3 - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/custom/custom.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html">Jason Notes</a></li><li class="chapter-item expanded "><a href="ubuntu/ubuntu_setup.html">Ubuntu</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ubuntu/command.html">Command</a></li><li class="chapter-item "><a href="ubuntu/gcp.html">GCP ssh</a></li><li class="chapter-item "><a href="ubuntu/wine.html">Wine</a></li></ol></li><li class="chapter-item expanded "><a href="android/android.html">Android</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="android/install_sdk.html">SDK install</a></li><li class="chapter-item "><a href="android/flutter.html">Flutter</a></li></ol></li><li class="chapter-item expanded "><a href="tools/tools.html">Tools</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="tools/asciinema.html">asciinema æŠŠçµ‚ç«¯æ“ä½œéŒ„è£½æˆ gif å‹•ç•«</a></li><li class="chapter-item "><a href="tools/finmind.html">Finmind</a></li><li class="chapter-item "><a href="tools/add-enter-and-exit-trace-for-your-function.html">addr2line</a></li><li class="chapter-item "><a href="tools/cmake.html">cmake</a></li><li class="chapter-item "><a href="tools/network.html">Network</a></li><li class="chapter-item "><a href="tools/python-pycryptodome-aes-symmetric-encryption-tutorial-examples.html">å¯¦ä½œ AES å°ç¨±å¼åŠ å¯†</a></li></ol></li><li class="chapter-item expanded "><a href="html/html.html">HTML</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="html/vue.html">Vue</a></li></ol></li><li class="chapter-item expanded "><a href="vim/vim.html">Vim</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="vim/copilot.html">copilot</a></li><li class="chapter-item "><a href="vim/tabnine.html">tabnine</a></li></ol></li><li class="chapter-item expanded "><a href="gdb/gdb.html">Gdb</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="gdb/å¸¸ç”¨æŒ‡ä»¤.html">å¸¸ç”¨æŒ‡ä»¤</a></li><li class="chapter-item "><a href="gdb/jemalloc.html">jemalloc</a></li><li class="chapter-item "><a href="gdb/graphs.html">graphs</a></li><li class="chapter-item "><a href="gdb/rust-gdb.html">rust gdb</a></li><li class="chapter-item "><a href="gdb/qemu-gdb-risc-v64.html">qemu-gdb-risc-v64-kernel</a></li><li class="chapter-item "><a href="gdb/go-rust-gdb-debug.html">ä½¿ç”¨gdb è¿½è¹¤go/rustç¨‹å¼ç¢¼</a></li><li class="chapter-item "><a href="gdb/gdb-function-trace-to-flowchart-guide.html">GDBå‡½æ•¸èª¿ç”¨è»Œè·¡åˆ†æèˆ‡æµç¨‹åœ–ç”Ÿæˆå®Œæ•´æŒ‡å—</a></li></ol></li><li class="chapter-item expanded "><a href="c++/cpp.html">C++</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="c++/benchmark.html">benchmark</a></li><li class="chapter-item "><a href="c++/ä¹˜ä»¥0.01å’Œé™¤ä»¥100å“ªå€‹å¿«.html">ä¹˜ä»¥ 0.01 å’Œé™¤ä»¥ 100 å“ªå€‹å¿«</a></li><li class="chapter-item "><a href="c++/smart_pointer.html">Smart pointer</a></li><li class="chapter-item "><a href="c++/l&rvalue.html">L&amp;R value</a></li><li class="chapter-item "><a href="c++/move.html">Move</a></li><li class="chapter-item "><a href="c++/CAS.html">CAS</a></li><li class="chapter-item "><a href="c++/HFT.html">HFT</a></li><li class="chapter-item "><a href="c++/cpp_note.html">Note</a></li><li class="chapter-item "><a href="c++/é«˜æ€§èƒ½ç¨‹å¼è¨­è¨ˆå¯¦æˆ°.html">é«˜æ€§èƒ½ç¨‹å¼è¨­è¨ˆå¯¦æˆ°</a></li><li class="chapter-item "><a href="c++/å¦‚ä½•é«˜æ•ˆåœ°å„²å­˜ä¸¦æ“ä½œè¶…å¤§è¦æ¨¡.html">å¦‚ä½•é«˜æ•ˆåœ°å„²å­˜ä¸¦æ“ä½œè¶…å¤§è¦æ¨¡</a></li><li class="chapter-item "><a href="c++/UC_CAPITAL.html">UC_CAPITAL</a></li><li class="chapter-item "><a href="c++/cpp-smart-pointers-guide.html">unique_ptr vs shared_ptr</a></li><li class="chapter-item "><a href="c++/cpp-move-semantics-guide.html">C++ Move èªæ„å®Œæ•´æŒ‡å—</a></li><li class="chapter-item "><a href="c++/interview.html">interview</a></li></ol></li><li class="chapter-item expanded "><a href="mojo/mojo.html">Mojo</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="mojo/mojo_crawler_guide.html">Mojo çˆ¬èŸ²å®Œæ•´æŒ‡å—</a></li></ol></li><li class="chapter-item expanded "><a href="riscv/riscv.html">RISC-V</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="riscv/qemu_riscv_linux.html">QEMUä¸Šé‹è¡ŒRISV-V Linux</a></li><li class="chapter-item "><a href="riscv/qemi_gdb.html">QEMU GDB</a></li><li class="chapter-item "><a href="riscv/qemu_gdb_lab.html">Qemu Gdb Lab</a></li></ol></li><li class="chapter-item expanded "><a href="centos/centos.html">CentOS</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="centos/tqdb_setup.html">TQDB å®‰è£ç´€éŒ„</a></li></ol></li><li class="chapter-item expanded "><a href="ssh/ssh.html">SSH</a></li><li class="chapter-item expanded "><a href="network/socket.html">Network</a></li><li class="chapter-item expanded "><a href="docker/docker_helloworld.html">Docker</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="docker/docker.html">Docker åŸºæœ¬æ•™å­¸</a></li><li class="chapter-item "><a href="docker/example.html">ç°¡å–®ç¯„ä¾‹</a></li><li class="chapter-item "><a href="docker/creating-the-perfect-python-dockerfile.html">Perfect python dockerfile</a></li><li class="chapter-item "><a href="docker/dockerfile-from-docker-image.html">ç”± Docker image åæ¨å…¶ Dockerfile</a></li><li class="chapter-item "><a href="docker/python_connect_redis.html">Pythoné€£æ¥Redis</a></li><li class="chapter-item "><a href="docker/command.html">Command</a></li><li class="chapter-item "><a href="docker/docker_compose.html">Docker compose</a></li><li class="chapter-item "><a href="docker/docker_compse_example.html">Docker compose example</a></li><li class="chapter-item "><a href="docker/python_redis.html">Python-Redis</a></li><li class="chapter-item "><a href="docker/redash.html">Redash</a></li><li class="chapter-item "><a href="docker/clickhouse.html">ClickHouse</a></li><li class="chapter-item "><a href="docker/clickhouse-setup.html">clickhouse-setup</a></li><li class="chapter-item "><a href="docker/python_run_from_local.html">Docker run local</a></li><li class="chapter-item "><a href="docker/redpanda.html">Redpanda</a></li><li class="chapter-item "><a href="docker/gcc.html">é‹è¡Œæœ€æ–°ç‰ˆGCC</a></li></ol></li><li class="chapter-item expanded "><a href="rust/rust.html">Rust</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust/note.html">Rustç­†è¨˜</a></li><li class="chapter-item "><a href="rust/basic.html">Rust åŸºæœ¬æ•™å­¸</a></li><li class="chapter-item "><a href="rust/ownership.html">Rust æ‰€æœ‰æ¬Šç³»çµ±</a></li><li class="chapter-item "><a href="rust/lifetime.html">Rust ç”Ÿå‘½é€±æœŸ (Lifetime)</a></li><li class="chapter-item "><a href="rust/type.html">Rust å‹åˆ¥ç³»çµ±</a></li><li class="chapter-item "><a href="rust/rust_setup.html">Rust Tools</a></li><li class="chapter-item "><a href="rust/polars.html">Polars</a></li><li class="chapter-item "><a href="rust/rust_call_c.html">Rust call C</a></li><li class="chapter-item "><a href="rust/pyo3.html">PyO3</a></li><li class="chapter-item "><a href="rust/10-rust-an-introduction.html">çµ¦ C++ ä½¿ç”¨è€…çš„ Rust ç°¡ä»‹</a></li><li class="chapter-item "><a href="rust/å¯è¦–åŒ–Rustå„è³‡æ–™çµæ§‹çš„è¨˜æ†¶é«”ä½ˆå±€.html">å¯è¦–åŒ–Rustå„è³‡æ–™çµæ§‹çš„è¨˜æ†¶é«”ä½ˆå±€</a></li><li class="chapter-item "><a href="rust/rust_note.html">å­¸ç¿’é †åº</a></li><li class="chapter-item "><a href="rust/overview.html">å¤§å±€è§€</a></li><li class="chapter-item "><a href="rust/String.html">ç†è§£å­—ä¸²</a></li><li class="chapter-item "><a href="rust/easy_rust.html">Easy Rust</a></li><li class="chapter-item "><a href="rust/rust_easy.html">Rust æ–°æ‰‹</a></li><li class="chapter-item "><a href="rust/module.html">Rust æ¨¡çµ„çµæ§‹</a></li><li class="chapter-item "><a href="rust/rust_memory.html">Rustèˆ‡è¨˜æ†¶é«”</a></li><li class="chapter-item "><a href="rust/rust_vs_cpp.html">Rust vs C++èªæ³•</a></li><li class="chapter-item "><a href="rust/rust_file_format.html">Rust æª”æ¡ˆæ ¼å¼</a></li><li class="chapter-item "><a href="rust/rust-an-introduction-in-oop.html">Rust OO</a></li><li class="chapter-item "><a href="rust/rust-an-introduction-smart-pointer.html">Rust Pointer</a></li><li class="chapter-item "><a href="rust/pointer.html">Pointer</a></li><li class="chapter-item "><a href="rust/copy_trait.html">Copy Trait</a></li><li class="chapter-item "><a href="rust/binary_lib.html">Rust å‡½æ•¸åº«/åŸ·è¡Œæª”</a></li><li class="chapter-item "><a href="rust/reqwest.html">Reqwest</a></li><li class="chapter-item "><a href="rust/print-function-name-dump-stack.html">å°å‡ºå‡½æ•¸åç¨±</a></li><li class="chapter-item "><a href="rust/criterion.html">criterion</a></li><li class="chapter-item "><a href="rust/Rustçš„ç²¾é«“.html">Rustçš„ç²¾é«“</a></li><li class="chapter-item "><a href="rust/30å¤©æ·±å…¥æ·ºå‡ºRustç³»åˆ—.html">30å¤©æ·±å…¥æ·ºå‡ºRustç³»åˆ—</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rust/30å¤©æ·±å…¥æ·ºå‡ºRustç³»åˆ—/rust_30_day.html">Rust 30 Day</a></li><li class="chapter-item "><a href="rust/30å¤©æ·±å…¥æ·ºå‡ºRustç³»åˆ—/Move_Borrow_Ownership.html">è®Šæ•¸çš„æ‰€æœ‰æ¬Šèˆ‡å€Ÿå‡ºè®Šæ•¸</a></li><li class="chapter-item "><a href="rust/30å¤©æ·±å…¥æ·ºå‡ºRustç³»åˆ—/Lifetime.html">Lifetimeï¼š Borrow çš„å­˜æ´»æ™‚é–“</a></li></ol></li><li class="chapter-item "><a href="rust/cpp_vs_rust_comparison.html">C++ vs. Rust: å…¨é¢ç‰¹æ€§æ¯”è¼ƒ</a></li><li class="chapter-item "><a href="rust/cpp-move-vs-rust-ownership.html">C++ Move èªç¾© vs Rust æ‰€æœ‰æ¬Šç³»çµ±çš„æ ¸å¿ƒå·®ç•°</a></li><li class="chapter-item "><a href="rust/Rust-RESTful-API-å®Œæ•´é–‹ç™¼æŒ‡å—.html">Rust-RESTful-API-å®Œæ•´é–‹ç™¼æŒ‡å—</a></li><li class="chapter-item "><a href="rust/Rust-self-Self-èˆ‡-C++-this-å°æ¯”æŒ‡å—.html">Rust-self-Self-èˆ‡-C++-this-å°æ¯”æŒ‡å—</a></li><li class="chapter-item "><a href="rust/rust-derive-traits-comparison.html">Rust Derive Traits æ¯”è¼ƒï¼šè‡ªå‹•ç”Ÿæˆ vs æ‰‹å‹•å¯¦ä½œ</a></li><li class="chapter-item "><a href="rust/rust_traits_explained.html">Rust Traits ç™½è©±è§£é‡‹ï¼šèˆ‡ C++ çš„æ¯”è¼ƒ</a></li><li class="chapter-item "><a href="rust/rust_trait_impl_markdown.html">Rust ä¸­ trait å’Œ impl çš„å·®ç•°</a></li><li class="chapter-item "><a href="rust/rust_cpp_comparison_md.html">Rust vs C++ è©³ç´°å°æ¯”æŒ‡å—</a></li><li class="chapter-item "><a href="rust/rust_module_system_markdown.html">Rust æ¨¡çµ„ç³»çµ±å®Œæ•´æŒ‡å—</a></li><li class="chapter-item "><a href="rust/ownership_vs_borrowing_guide.html">Rust æ“æœ‰æ¬Š vs å€Ÿç”¨ï¼šç”Ÿå‘½é€±æœŸå•é¡ŒæŒ‡å—ğŸ¦€</a></li><li class="chapter-item "><a href="rust/rust_ownership_guide.html">Rust æ‰€æœ‰æ¬Šç³»çµ± - ç”Ÿæ´»åŒ–è©³è§£</a></li><li class="chapter-item "><a href="rust/rust_ownership_complete_guide.html">Rust æ‰€æœ‰æ¬Šå®Œæ•´æŒ‡å— - å¾åŸºç¤åˆ°ç²¾é€š</a></li><li class="chapter-item "><a href="rust/rust_memory_guide.html">Rust è¨˜æ†¶é«”é…ç½®æŒ‡å—ï¼šStack vs Heap</a></li><li class="chapter-item "><a href="rust/rust_wrappers_guide.html">Rust è¨˜æ†¶é«”é…ç½®æŒ‡å—ï¼šStack vs Heap</a></li></ol></li><li class="chapter-item expanded "><a href="go/go.html">Go</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="go/note.html">Golang  Note</a></li><li class="chapter-item "><a href="go/pytago.html">pytago</a></li><li class="chapter-item "><a href="go/Goç·¨ç¨‹å¯¦æˆ°æ´¾åŸºç¤å…¥é–€.html">Goç·¨ç¨‹å¯¦æˆ°æ´¾åŸºç¤å…¥é–€</a></li><li class="chapter-item "><a href="go/Goç·¨ç¨‹å¯¦æˆ°æ´¾Webé–‹ç™¼åŸºç¤.html">Goç·¨ç¨‹å¯¦æˆ°æ´¾Webé–‹ç™¼åŸºç¤</a></li><li class="chapter-item "><a href="go/golang_debugger.html">Golang Deubgger</a></li><li class="chapter-item "><a href="go/golang-go-module-tutorial.html">å¾ä¸€çŸ¥åŠè§£åˆ°ç•¥æ‡‚ Go modules</a></li><li class="chapter-item "><a href="go/go_mod.html">Go modules</a></li><li class="chapter-item "><a href="go/trace.html">Golangå¤§æ®ºå™¨ä¹‹è·Ÿè¹¤å‰–ætrace</a></li><li class="chapter-item "><a href="go/Coroutine.html">è¡Œç¨‹ã€åŸ·è¡Œç·’ã€å”ç¨‹ï¼Œå‚»å‚»åˆ†å¾—æ¸…æ¥šï¼</a></li><li class="chapter-item "><a href="go/goroutine-and-channel.html">Goä½µç™¼</a></li><li class="chapter-item "><a href="go/websocket.html">Websocket</a></li><li class="chapter-item "><a href="go/returning-pointer-from-a-function-in-go.html">Returning Pointer from a Function in Go</a></li><li class="chapter-item "><a href="go/golang-memory-management.html">GC å…¨é¢è§£æ</a></li><li class="chapter-item "><a href="go/golang-goroutine.html">Goroutine èˆ‡ GMP åŸç†å…¨é¢åˆ†æ</a></li><li class="chapter-item "><a href="go/oo.html">OO</a></li><li class="chapter-item "><a href="go/mutex-rwmutex.html">sync.Mutex å’Œ sync.RWMutex</a></li><li class="chapter-item "><a href="go/interface.html">interface</a></li><li class="chapter-item "><a href="go/example.html">Example</a></li><li class="chapter-item "><a href="go/LiveKit.html">LiveKit</a></li></ol></li><li class="chapter-item expanded "><a href="ml/ml.html">ML</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ml/pytorch.html">Pytorch</a></li><li class="chapter-item "><a href="ml/pytorch_setup.html">Pytorch å®‰è£</a></li><li class="chapter-item "><a href="ml/deap.html">Deap</a></li><li class="chapter-item "><a href="ml/cudf.html">CUDF</a></li><li class="chapter-item "><a href="ml/åˆæ¢åŸºå› æ¼”ç®—æ³•.html">åˆæ¢åŸºå› æ¼”ç®—æ³•-ç”¨ OneMax å•é¡Œç¤ºç¯„</a></li><li class="chapter-item "><a href="ml/ç°¡å–®è§£é‡‹æ¢¯åº¦ä¸‹é™æ³•.html">ç°¡å–®è§£é‡‹æ¢¯åº¦ä¸‹é™æ³•</a></li><li class="chapter-item "><a href="ml/æ¢¯åº¦ä¸‹é™æ³•_gradient_descent.html">æ¢¯åº¦ä¸‹é™æ³• gradient descent</a></li><li class="chapter-item "><a href="ml/æ¢¯åº¦æœ€ä½³è§£ç›¸é—œç®—æ³•.html">æ¢¯åº¦æœ€ä½³è§£ç›¸é—œç®—æ³•</a></li><li class="chapter-item "><a href="ml/åŸºæ–¼DEAPåº«çš„Pythoné€²åŒ–æ¼”ç®—æ³•å¾å…¥é–€åˆ°å…¥åœŸ.html">åŸºæ–¼DEAPåº«çš„Pythoné€²åŒ–æ¼”ç®—æ³•å¾å…¥é–€åˆ°å…¥åœŸ</a></li><li class="chapter-item "><a href="ml/GA.html">GA</a></li><li class="chapter-item "><a href="ml/XGBoost.html">XGBoost</a></li><li class="chapter-item "><a href="ml/YOLO.html">YOLO</a></li><li class="chapter-item "><a href="ml/yolov8æ‰‹å‹¢è­˜åˆ¥.html">YOLOv8æ‰‹å‹¢è­˜åˆ¥</a></li><li class="chapter-item "><a href="ml/Roboflow.html">Roboflow</a></li></ol></li><li class="chapter-item expanded "><a href="python/python.html">Python</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="python/Poetryå®Œå…¨å…¥é–€æŒ‡å—.html">Poetryå®Œå…¨å…¥é–€æŒ‡å—</a></li><li class="chapter-item "><a href="python/æ­å»ºgRPCæœå‹™.html">æ­å»ºgRPCæœå‹™</a></li><li class="chapter-item "><a href="python/python_debugger.html">Python Debugger</a></li><li class="chapter-item "><a href="python/decorator.html">Python decorator</a></li><li class="chapter-item "><a href="python/python-decorator.html">è£é£¾å™¨çœ‹é€™ä¸€ç¯‡å°±å¤ äº†</a></li><li class="chapter-item "><a href="python/import-concept.html">import-concept</a></li><li class="chapter-item "><a href="python/process_thread.html">Process/Threadå„ªç¼ºé»</a></li><li class="chapter-item "><a href="python/processing_communcation.html">Processing é€šè¨Š</a></li><li class="chapter-item "><a href="python/condition.html">Pythonä¸­çš„waitå’Œnotify</a></li><li class="chapter-item "><a href="python/ç”Ÿç”¢è€…æ¶ˆè²»è€…æ¨¡å¼.html">ç”Ÿç”¢è€…æ¶ˆè²»è€…æ¨¡å¼</a></li><li class="chapter-item "><a href="python/Loguru.html">Loguru</a></li><li class="chapter-item "><a href="python/cython.html">Cython</a></li><li class="chapter-item "><a href="python/WebSocket_reconnect.html">Python WebSocketé•·é€£æ¥å¿ƒè·³èˆ‡çŸ­é€£æ¥</a></li><li class="chapter-item "><a href="python/bloomrpc.html">bloomrpc</a></li><li class="chapter-item "><a href="python/concurrent.futures.html">Concurrent futures</a></li><li class="chapter-item "><a href="python/schedule.html">ä»»å‹™èª¿åº¦</a></li><li class="chapter-item "><a href="python/plot/plot.html">Plot</a></li><li class="chapter-item "><a href="python/plot/dash.html">Dash</a></li><li class="chapter-item "><a href="python/Rust_bindings_for_Python.html">Rust bindings for Python</a></li><li class="chapter-item "><a href="python/pandas.html">Pandas</a></li><li class="chapter-item "><a href="python/coroutine.html">Coroutine</a></li><li class="chapter-item "><a href="python/finmind.html">FinMind</a></li><li class="chapter-item "><a href="python/telegram_bot.html">Telegram Bot</a></li><li class="chapter-item "><a href="python/python-different-ways-to-kill-a-thread.html">Different ways kill thread</a></li><li class="chapter-item "><a href="python/websocket_client_server.html">Websocket client/server</a></li><li class="chapter-item "><a href="python/poetry.html">å¾é›¶é–‹å§‹ä½¿ç”¨ Poetry</a></li><li class="chapter-item "><a href="python/fil-memory-usage-profiler.html">Fil-memory-usage-profiler</a></li><li class="chapter-item "><a href="python/plot.html">ç¹ªåœ–</a></li><li class="chapter-item "><a href="python/shioaji.html">æ°¸è±shioaji</a></li><li class="chapter-item "><a href="python/other.html">Other</a></li></ol></li><li class="chapter-item expanded "><a href="mermaid/mermaid.html">Mermaid</a></li><li class="chapter-item expanded "><a href="linux_system/linux_system.html">Linux System</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="linux_system/1_day_socket.html">Socket</a></li><li class="chapter-item "><a href="linux_system/cgroup.html">Cgroup</a></li><li class="chapter-item "><a href="linux_system/perf.html">Perf</a></li><li class="chapter-item "><a href="linux_system/è‡ªè£½Lib.html">build Lib</a></li><li class="chapter-item "><a href="linux_system/performance.html">performance</a></li></ol></li><li class="chapter-item expanded "><a href="strategy/bollmaker.html">Strategy</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/é€ å¸‚/market_market.html">é€ å¸‚</a></li><li class="chapter-item "><a href="strategy/tw_futures.html">è‡ºæŒ‡</a></li><li class="chapter-item "><a href="strategy/arbitrage.html">å¥—åˆ©</a></li><li class="chapter-item "><a href="strategy/é…å°äº¤æ˜“.html">é…å°äº¤æ˜“</a></li><li class="chapter-item "><a href="strategy/æµ·é¾œäº¤æ˜“.html">æµ·é¾œäº¤æ˜“</a></li><li class="chapter-item "><a href="strategy/è‚¡æµ·ç­‹è‚‰äºº.html">è‚¡æµ·ç­‹è‚‰äºº</a></li><li class="chapter-item "><a href="strategy/å¦‚ä½•é¿å…éæ“¬åˆ.html">å¦‚ä½•é¿å…éæ“¬åˆ</a></li><li class="chapter-item "><a href="strategy/å¤šç©ºæ“ä½œè¡“.html">å¤šç©ºæ“ä½œè¡“</a></li><li class="chapter-item "><a href="strategy/è³‡é‡‘æ§ç®¡æ‰æ˜¯ç‹é“.html">è³‡é‡‘æ§ç®¡æ‰æ˜¯ç‹é“</a></li><li class="chapter-item "><a href="strategy/00713_00675Læ­£äºŒèœˆèš£ç­–ç•¥.html">æ­£äºŒèœˆèš£ç­–ç•¥</a></li><li class="chapter-item "><a href="strategy/è³ªæŠ¼00713+æ­£äºŒ.html">è³ªæŠ¼00713+æ­£äºŒ</a></li><li class="chapter-item "><a href="strategy/phcebus/phcebus.html">phcebus</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/phcebus/è²å¼æ€è€ƒ.html">è²å¼æ€è€ƒ</a></li><li class="chapter-item "><a href="strategy/phcebus/è²·è‚¡3å¿ƒæ³•.html">è²·è‚¡3å¿ƒæ³•</a></li></ol></li><li class="chapter-item "><a href="strategy/Option/option.html">é¸æ“‡æ¬Š</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/Option/option_note.html">Option note</a></li></ol></li><li class="chapter-item "><a href="strategy/vectorbt.html">VectorBT</a></li><li class="chapter-item "><a href="strategy/orderbook.html">Orderbook</a></li><li class="chapter-item "><a href="strategy/é¸è‚¡æ¢ä»¶.html">é¸è‚¡æ¢ä»¶</a></li><li class="chapter-item "><a href="strategy/å¦‚ä½•é€²å ´.html">å¦‚ä½•é€²å ´</a></li><li class="chapter-item "><a href="strategy/å¦‚ä½•å‡ºå ´.html">å¦‚ä½•å‡ºå ´</a></li><li class="chapter-item "><a href="strategy/å»ºå€‰åŠ ç¢¼.html">å»ºå€‰åŠ ç¢¼</a></li><li class="chapter-item "><a href="strategy/DT.html">ç•¶æ²–</a></li><li class="chapter-item "><a href="strategy/ç•¶æ²–åšç©º.html">ç•¶æ²–åšç©º</a></li><li class="chapter-item "><a href="strategy/æŠ„åº•.html">æŠ„åº•</a></li><li class="chapter-item "><a href="strategy/éº»é“æ˜/éº»é“æ˜.html">éº»é“æ˜</a></li><li class="chapter-item "><a href="strategy/è³ºè´å¤§ç›¤çš„å‹•èƒ½æŠ•è³‡æ³•.html">è³ºè´å¤§ç›¤çš„å‹•èƒ½æŠ•è³‡æ³•</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/éº»é“æ˜/å‡çªç ´.html">å‡çªç ´</a></li></ol></li><li class="chapter-item "><a href="strategy/å¥‡æ­£/å¥‡æ­£.html">å¥‡æ­£</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/å¥‡æ­£/è³‡é‡‘æ§ç®¡èˆ‡è©¦å–®ç­–ç•¥.html">è³‡é‡‘æ§ç®¡èˆ‡è©¦å–®ç­–ç•¥</a></li><li class="chapter-item "><a href="strategy/å¥‡æ­£/å¦‚ä½•å‡ºå ´.html">å¦‚ä½•å‡ºå ´</a></li></ol></li><li class="chapter-item "><a href="strategy/ptt_stock/a0808996.html">PTT Stock</a></li><li class="chapter-item "><a href="strategy/Book/JG.html">JG</a></li><li class="chapter-item "><a href="strategy/bnf.html">BNF</a></li><li class="chapter-item "><a href="strategy/cis.html">CIS</a></li><li class="chapter-item "><a href="strategy/GA.html">GA</a></li><li class="chapter-item "><a href="strategy/stock.html">Stock</a></li><li class="chapter-item "><a href="strategy/note.html">Resource</a></li><li class="chapter-item "><a href="strategy/nansen.html">Nansen</a></li><li class="chapter-item "><a href="strategy/example.html">Example</a></li><li class="chapter-item "><a href="strategy/other.html">Other</a></li><li class="chapter-item "><a href="strategy/sample.html">Sample</a></li><li class="chapter-item "><a href="strategy/shioaji.html">shioaji æ¨¡æ“¬</a></li><li class="chapter-item "><a href="strategy/grid.html">Grid</a></li><li class="chapter-item "><a href="strategy/pine-script.html">pine-script</a></li><li class="chapter-item "><a href="strategy/æ‹¾äººç‰™æ…§.html">æ‹¾äººç‰™æ…§</a></li><li class="chapter-item "><a href="strategy/sharpe_ratio.html">å¤æ™®å€¼</a></li><li class="chapter-item "><a href="strategy/display_mae_mfe_analysis.html">MAE&amp;MFEåˆ†æ</a></li><li class="chapter-item "><a href="strategy/æµ·é¾œæŠ•è³‡æ³•å‰‡.html">æµ·é¾œæŠ•è³‡æ³•å‰‡</a></li><li class="chapter-item "><a href="strategy/edge-ratio-follow-application.html">å½ˆæ€§é€²å‡ºå ´çš„åˆ¤æ–·</a></li><li class="chapter-item "><a href="strategy/ä¸‰å¿ƒæ³•é †å‹¢æ“ä½œé™³æ—å…ƒ10å¹´è³‡ç”¢ç¿»10å€.html">ä¸‰å¿ƒæ³•é †å‹¢æ“ä½œé™³æ—å…ƒ10å¹´è³‡ç”¢ç¿»10å€</a></li><li class="chapter-item "><a href="strategy/Jump.html">JUMP</a></li><li class="chapter-item "><a href="strategy/å¼µæ¾å…æŠ•è³‡å¿ƒæ³•.html">å¼µå…æŠ•è³‡å¿ƒæ³•</a></li><li class="chapter-item "><a href="strategy/vectorbt_é…å°.html">vectorbt é…å°</a></li><li class="chapter-item "><a href="strategy/äº¤æ˜“çš„è¡Œç‚ºèˆ‡æ€ç¶­åˆ†äº«.html">äº¤æ˜“çš„è¡Œç‚ºèˆ‡æ€ç¶­åˆ†äº«</a></li><li class="chapter-item "><a href="strategy/æŠ•è³‡æŠ•æ©Ÿçš„è§€å¿µèˆ‡å¿ƒå¾—åˆ†äº«.html">æŠ•è³‡æŠ•æ©Ÿçš„è§€å¿µèˆ‡å¿ƒå¾—åˆ†äº«</a></li><li class="chapter-item "><a href="strategy/finlab.html">Finlab</a></li><li class="chapter-item "><a href="strategy/backtrader/basis.html">Backtrader</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶ä¸€Backtraderä»‹ç´¹.html">Pythonå›æ¸¬æ¡†æ¶ä¸€Backtraderä»‹ç´¹</a></li><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶äºŒå®šæœŸå®šé¡æŠ•è³‡.html">Python å›æ¸¬æ¡†æ¶ï¼ˆäºŒï¼‰å®šæœŸå®šé¡æŠ•è³‡</a></li><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶ä¸‰æŠ€è¡“æŒ‡æ¨™.html">Python å›æ¸¬æ¡†æ¶ï¼ˆä¸‰ï¼‰æŠ€è¡“æŒ‡æ¨™</a></li><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶å››CrossOverå’ŒSignal.html">Python å›æ¸¬æ¡†æ¶ï¼ˆå››ï¼‰CrossOver å’Œ Signal</a></li><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶äº”Sizer.html">Python å›æ¸¬æ¡†æ¶ï¼ˆäº”ï¼‰Sizer</a></li><li class="chapter-item "><a href="strategy/backtrader/Pythonå›æ¸¬æ¡†æ¶å…­Analyzers.html">Python å›æ¸¬æ¡†æ¶ï¼ˆå…­ï¼‰Analyzers</a></li><li class="chapter-item "><a href="strategy/backtrader/å¤šè‚¡çµ„åˆæ“ä½œç­–ç•¥.html">å¤šè‚¡çµ„åˆæ“ä½œ</a></li><li class="chapter-item "><a href="strategy/backtrader/å‡ç·šäº¤å‰ç­–ç•¥.html">å‡ç·šäº¤å‰ç­–ç•¥</a></li><li class="chapter-item "><a href="strategy/backtrader/å”å¥‡å®‰é€šé“ç­–ç•¥.html">å”å¥‡å®‰é€šé“ç­–ç•¥</a></li><li class="chapter-item "><a href="strategy/backtrader/Sizersæ¨¡çµ„.html">Sizersæ¨¡çµ„</a></li><li class="chapter-item "><a href="strategy/backtrader/Observersæ¨¡çµ„.html">Observersæ¨¡çµ„</a></li><li class="chapter-item "><a href="strategy/backtrader/Pyfolio.html">Pyfolio</a></li><li class="chapter-item "><a href="strategy/backtrader/Sample.html">Sample</a></li><li class="chapter-item "><a href="strategy/backtrader/performance.html">Performance</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="mq/kafka.html">MQ</a></li><li class="chapter-item expanded "><a href="mq/kafka-python.html">Kafkaçš„é€šä¿—ç¸½çµ</a></li><li class="chapter-item expanded "><a href="database/database.html">Database</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="database/redis.html">Redis</a></li><li class="chapter-item "><a href="database/hash.html">Redis Hash</a></li><li class="chapter-item "><a href="database/clickhouse.html">ClickHouse</a></li><li class="chapter-item "><a href="database/dolphin.html">Dolphin</a></li><li class="chapter-item "><a href="database/sqlite.html">Sqlite</a></li></ol></li><li class="chapter-item expanded "><a href="cryptotrade/cryptotrade.html">CryptoTrade</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="cryptotrade/binance/binance.html">Binance</a></li><li class="chapter-item "><a href="cryptotrade/binance/oco.html">å¦‚ä½•å°‡OCOè¨‚å–®ç™¼é€åˆ°Binance</a></li></ol></li><li class="chapter-item expanded "><a href="git/git.html">Git</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="git/git-remove-commited-files.html">git-remove-commited-files</a></li><li class="chapter-item "><a href="git/cheat-sheet.html">Git å¸¸ç”¨</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_notes" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="è§£å¯†-python-å¦‚ä½•å‘¼å«-rust-ç·¨è­¯ç”Ÿæˆçš„å‹•æ…‹é€£çµåº«"><a class="header" href="#è§£å¯†-python-å¦‚ä½•å‘¼å«-rust-ç·¨è­¯ç”Ÿæˆçš„å‹•æ…‹é€£çµåº«">è§£å¯† Python å¦‚ä½•å‘¼å« Rust ç·¨è­¯ç”Ÿæˆçš„å‹•æ…‹é€£çµåº«</a></h1>
<h2 id="æ¥”å­"><a class="header" href="#æ¥”å­">æ¥”å­</a></h2>
<p>Rust è®“ Python æ›´åŠ å‰å¤§ï¼Œéš¨è‘— Rust çš„æµè¡Œï¼Œåè€Œè®“ Python çš„ç”Ÿç”¢åŠ›æé«˜äº†ä¸å°‘ã€‚å› ç‚ºæœ‰è¶Šä¾†è¶Šå¤šçš„ Python å·¥å…·ï¼Œéƒ½é¸æ“‡äº† Rust é€²è¡Œé–‹ç™¼ï¼Œä¸¦ä¸”æ€§èƒ½ä¹Ÿå„ªæ–¼åŒé¡å‹çš„å…¶å®ƒå·¥å…·ã€‚æ¯”å¦‚ï¼š</p>
<ul>
<li>ruffï¼šé€Ÿåº¦æ¥µå¿«çš„ç¨‹å¼ç¢¼åˆ†æå·¥å…·ï¼Œä»¥åŠç¨‹å¼ç¢¼æ ¼å¼åŒ–å·¥å…·ï¼›</li>
<li>orjsonï¼šä¸€å€‹é«˜æ€§èƒ½çš„ JSON è§£æåº«ï¼›</li>
<li>watchfilesï¼šå¯ä»¥å°æŒ‡å®šç›®éŒ„é€²è¡Œå³æ™‚ç›£æ§ï¼›</li>
<li>polarsï¼šå’Œ pandas é¡ä¼¼çš„è³‡æ–™åˆ†æå·¥å…·ï¼›</li>
<li>pydanticï¼šè³‡æ–™é©—è­‰å·¥å…·ï¼›</li>
<li>......</li>
</ul>
<p>ç¸½ä¹‹ç¾åœ¨ Rust + Python å·²ç¶“æˆç‚ºäº†ä¸€å€‹è¶¨å‹¢ï¼Œä¸¦ä¸” Rust ä¹Ÿæä¾›äº†ä¸€ç³»åˆ—æˆç†Ÿå¥½ç”¨çš„å·¥å…·ï¼Œæ¯”å¦‚ PyO3ã€Maturinï¼Œå°ˆé–€ç‚º Python ç·¨å¯«æ“´å±•ã€‚ä¸éé—œæ–¼ PyO3 æˆ‘å€‘ä»¥å¾Œå†èŠï¼Œæœ¬ç¯‡æ–‡ç« å…ˆä¾†ä»‹ç´¹å¦‚ä½•å°‡ Rust ç¨‹å¼ç¢¼ç·¨è­¯æˆå‹•æ…‹åº«ï¼Œç„¶å¾Œäº¤çµ¦ Python çš„ ctypes æ¨¡çµ„å‘¼å«ã€‚</p>
<p>å› ç‚ºé€šé ctypes å‘¼å«å‹•æ…‹åº«æ˜¯æœ€ç°¡å–®çš„ä¸€ç¨®æ–¹å¼ï¼Œå®ƒåªå°ä½œæ¥­ç³»çµ±æœ‰è¦æ±‚ï¼Œåªè¦ä½œæ¥­ç³»çµ±ä¸€è‡´ï¼Œé‚£éº¼ä»»ä½•æä¾›äº† ctypes æ¨¡çµ„çš„ Python ç›´è­¯å™¨éƒ½å¯ä»¥å‘¼å«ã€‚</p>
<p>ç•¶ç„¶é€™ä¹Ÿå´é¢è¦æ±‚ï¼ŒRust æä¾›çš„ä»‹é¢ä¸èƒ½å¤ªè¤‡é›œï¼Œå› ç‚º ctypes æä¾›çš„äº’å‹•èƒ½åŠ›é‚„æ˜¯æ¯”è¼ƒæœ‰é™çš„ï¼Œæœ€æ˜é¡¯çš„å•é¡Œå°±æ˜¯ä¸åŒèªè¨€çš„è³‡æ–™é¡å‹ä¸åŒï¼Œä¸€äº›è¤‡é›œçš„äº’å‹•æ–¹å¼é‚„æ˜¯æ¯”è¼ƒé›£åšåˆ°çš„ï¼Œé‚„æœ‰å¤šåŸ·è¡Œç·’çš„æ§åˆ¶å•é¡Œç­‰ç­‰ã€‚</p>
<blockquote>
<p>ä¹‹å‰èªªéä½¿ç”¨ ctypes å‘¼å« C çš„å‹•æ…‹åº«ï¼Œè£¡é¢è©³ç´°ä»‹ç´¹äº† ctypes çš„ç”¨æ³•ï¼Œå› æ­¤æœ¬æ–‡é—œæ–¼ ctypes å°±ä¸åšè©³ç´°ä»‹ç´¹äº†ã€‚</p>
</blockquote>
<h2 id="èˆ‰å€‹ä¾‹å­"><a class="header" href="#èˆ‰å€‹ä¾‹å­">èˆ‰å€‹ä¾‹å­</a></h2>
<p>ä¸‹é¢æˆ‘å€‘èˆ‰å€‹ä¾‹å­æ„Ÿå—ä¸€ä¸‹ Python å’Œ Rust çš„äº’å‹•éç¨‹ï¼Œé¦–å…ˆé€šéå¦‚ä¸‹å‘½ä»¤å»ºç«‹ä¸€å€‹ Rust é …ç›®ï¼š</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">cargo new py_lib --lib1.
</code></pre>
<p>å»ºç«‹å®Œä¹‹å¾Œä¿®æ”¹ Cargo.tomlï¼Œåœ¨è£¡é¢åŠ å…¥å¦‚ä¸‹å…§å®¹ï¼š</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">[lib]
# ç·¨è­¯ä¹‹å¾Œçš„å‹•æ…‹åº«çš„åç¨±
name = "py_lib"
# è¡¨ç¤ºç·¨è­¯æˆä¸€å€‹å’Œ C èªè¨€äºŒé€²åˆ¶ä»‹é¢ï¼ˆABIï¼‰ç›¸å®¹çš„å‹•æ…‹é€£çµåº«
crate-type = ["cdylib"]1.2.3.4.5.
</code></pre>
<p>cdylib è¡¨ç¤ºç”Ÿæˆå‹•æ…‹åº«ï¼Œå¦‚æœæƒ³ç”Ÿæˆéœæ…‹åº«ï¼Œé‚£éº¼å°±æŒ‡å®šç‚º staticlibã€‚</p>
<p>ä¸‹é¢é–‹å§‹ç·¨å¯«åŸå§‹ç¢¼ï¼Œåœ¨ç”Ÿæˆé …ç›®ä¹‹å¾Œï¼Œsrc ç›®éŒ„ä¸‹æœƒæœ‰ä¸€å€‹ lib.rsï¼Œå®ƒæ˜¯æ•´å€‹åº«çš„å…¥å£é»ã€‚æˆ‘å€‘çš„ç¨‹å¼ç¢¼æ¯”è¼ƒç°¡å–®ï¼Œç›´æ¥å¯«åœ¨ lib.rs è£¡é¢å³å¯ã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">#[no_mangle]
pub extern "C" fn add(a: i32, b: i32) -&gt; i32 {
    a + b
}

#[no_mangle]
pub extern "C" fn get_square_root(v: i32) -&gt; f64 {
    (v as f64).sqrt()
}1.2.3.4.5.6.7.8.9.
</code></pre>
<p>åœ¨å®šç¾©å‡½æ•¸æ™‚éœ€è¦ä½¿ç”¨ pub extern "C" é€²è¡Œè²æ˜ï¼Œå®ƒè¡¨ç¤ºå»ºç«‹ä¸€å€‹å¤–éƒ¨å¯è¦‹ã€éµå¾ª C èªè¨€å‘¼å«ç´„å®šçš„å‡½æ•¸ï¼Œå› ç‚º Python ä½¿ç”¨çš„æ˜¯ C ABIã€‚</p>
<p>æ­¤å¤–é‚„è¦çµ¦å‡½æ•¸æ–°å¢ä¸€å€‹ #[no_mangle] å±¬æ€§ï¼Œè®“ç·¨è­¯å™¨åœ¨å°‡ Rust å‡½æ•¸åŒ¯å‡ºç‚º C å‡½æ•¸æ™‚ï¼Œä¸è¦æ”¹è®Šå‡½æ•¸çš„åç¨±ã€‚ç¢ºä¿åœ¨ç·¨è­¯æˆå‹•æ…‹åº«å¾Œï¼Œå‡½æ•¸åä¿æŒä¸è®Šï¼Œå¦å‰‡åœ¨å‘¼å«å‹•æ…‹åº«æ™‚å°±æ‰¾ä¸åˆ°æŒ‡å®šçš„å‡½æ•¸äº†ã€‚</p>
<p>Rust æœ‰å€‹åç¨±ä¿®é£¾ï¼ˆName Manglingï¼‰çš„æ©Ÿåˆ¶ï¼Œåœ¨è·¨èªè¨€æ“ä½œæ™‚ï¼Œæœƒä¿®æ”¹å‡½æ•¸åï¼Œå¢åŠ ä¸€äº›é¡å¤–è³‡è¨Šã€‚é€™ç¨®ä¿®æ”¹å° Rust å…§éƒ¨ä½¿ç”¨æ²’æœ‰å½±éŸ¿ï¼Œä½†æœƒå¹²æ“¾å…¶å®ƒèªè¨€çš„å‘¼å«ï¼Œå› æ­¤éœ€è¦é€šé #[no_mangle] å°‡è©²æ©Ÿåˆ¶åœç”¨æ‰ã€‚</p>
<p>ç¨‹å¼ç¢¼ç·¨å¯«å®Œæˆï¼Œæˆ‘å€‘é€šé cargo build é€²è¡Œç·¨è­¯ï¼Œç„¶å¾Œåœ¨ target/debug ç›®éŒ„ä¸‹å°±æœƒç”Ÿæˆç›¸æ‡‰çš„å‹•æ…‹åº«ã€‚ç”±æ–¼åº«çš„åç¨±æˆ‘å€‘æŒ‡å®šç‚º py_libï¼Œé‚£éº¼ç”Ÿæˆçš„åº«æª”æ¡ˆåç¨±å°±å« libpy_lib.dylibã€‚</p>
<p>ç•¶åŠŸèƒ½å…¨éƒ¨å¯¦ç¾ä¸¦ä¸”æ¸¬è©¦é€šéæ™‚ï¼Œæœ€å¥½é‡æ–°ç·¨è­¯ä¸€æ¬¡ï¼Œä¸¦åŠ ä¸Š --release åƒæ•¸ã€‚é€™æ¨£å¯ä»¥å°ç¨‹å¼ç¢¼é€²è¡Œæœ€ä½³åŒ–ï¼Œç•¶ç„¶ç·¨è­¯æ™‚é–“ä¹Ÿæœƒç¨å¾®é•·ä¸€äº›ï¼Œä¸¦ä¸”ç”Ÿæˆçš„åº«æª”æ¡ˆæœƒåœ¨ target/release ç›®éŒ„ä¸­ã€‚</p>
<p>ç·¨è­¯å™¨ç”Ÿæˆå‹•æ…‹åº«å¾Œï¼Œæœƒè‡ªå‹•åŠ ä¸Šä¸€å€‹ lib å‰ç¶´ï¼ˆWindows ç³»çµ±é™¤å¤–ï¼‰ï¼Œè‡³æ–¼å¾Œç¶´å‰‡èˆ‡ä½œæ¥­ç³»çµ±æœ‰é—œã€‚</p>
<ul>
<li>Windows ç³»çµ±ï¼Œå¾Œç¶´åç‚º .dllï¼›</li>
<li>macOS ç³»çµ±ï¼Œå¾Œç¶´åç‚º .dylibï¼›</li>
<li>Linux ç³»çµ±ï¼Œå¾Œç¶´åç‚º .soï¼›</li>
</ul>
<p>ç„¶å¾Œæˆ‘å€‘é€šé Python é€²è¡Œå‘¼å«ã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">import ctypes

# ä½¿ç”¨ ctypes å¾ˆç°¡å–®ï¼Œç›´æ¥ import é€²ä¾†
# ç„¶å¾Œä½¿ç”¨ ctypes.CDLL é€™å€‹é¡ä¾†è¼‰å…¥å‹•æ…‹é€£çµåº«
# æˆ–è€…ä½¿ç”¨ ctypes.cdll.LoadLibrary ä¹Ÿæ˜¯å¯ä»¥çš„
py_lib = ctypes.CDLL("../py_lib/target/debug/libpy_lib.dylib")

# è¼‰å…¥ä¹‹å¾Œå°±å¾—åˆ°äº†å‹•æ…‹é€£çµåº«å°è±¡ï¼Œæˆ‘å€‘èµ·åç‚º py_lib
# ç„¶å¾Œé€šéå±¬æ€§è¨ªå•çš„æ–¹å¼å»å‘¼å«è£¡é¢çš„å‡½æ•¸
print(py_lib.add(11, 22))
"""
33
"""

# å¦‚æœä¸ç¢ºå®šå‡½æ•¸æ˜¯å¦å­˜åœ¨ï¼Œé‚£éº¼å»ºè­°ä½¿ç”¨åå°„
# å› ç‚ºå‡½æ•¸ä¸å­˜åœ¨ï¼Œé€šé . çš„æ–¹å¼ç²å–æ˜¯æœƒæ‹‹ç•°å¸¸çš„
get_square_root = getattr(py_lib, "get_square_root", None)
if get_square_root:
    print(get_square_root)
    """
    &lt;_FuncPtr object at 0x7fae30a2b040&gt;
    """

# ä¸å­˜åœ¨ sub å‡½æ•¸ï¼Œæ‰€ä»¥å¾—åˆ°çš„çµæœç‚º None
sub = getattr(py_lib, "sub", None)
print(sub)
"""
None
"""1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.18.19.20.21.22.23.24.25.26.27.28.29.
</code></pre>
<p>æ‰€ä»¥ä½¿ç”¨ ctypes å»å‘¼å«å‹•æ…‹é€£çµåº«éå¸¸æ–¹ä¾¿ï¼Œéç¨‹å¾ˆç°¡å–®ï¼š</p>
<ul>
<li>1ï¼‰é€šé ctypes.CDLL å»è¼‰å…¥å‹•æ…‹åº«ï¼›</li>
<li>2ï¼‰è¼‰å…¥å‹•æ…‹é€£çµåº«ä¹‹å¾Œæœƒè¿”å›ä¸€å€‹å°è±¡ï¼Œæˆ‘å€‘ä¸Šé¢èµ·åç‚º py_libï¼›</li>
<li>3ï¼‰ç„¶å¾Œç›´æ¥é€šé py_lib å‘¼å«è£¡é¢çš„å‡½æ•¸ï¼Œä½†ç‚ºäº†ç¨‹åºçš„å¥å£¯æ€§ï¼Œå»ºè­°ä½¿ç”¨åå°„ï¼Œç¢ºå®šå‘¼å«çš„å‡½æ•¸å­˜åœ¨å¾Œæ‰æœƒå‘¼å«;</li>
</ul>
<p>æˆ‘å€‘ä»¥ä¸Šå°±æ¼”ç¤ºç­å¦‚ä½•é€šé ctypes æ¨¡çµ„ä¾†å‘¼å« Rust ç·¨è­¯ç”Ÿæˆçš„å‹•æ…‹åº«ï¼Œä½†é¡¯ç„¶ç›®å‰é‚„æ˜¯é é ä¸å¤ çš„ï¼Œæ¯”å¦‚èªªï¼š</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">from ctypes import CDLL

py_lib = CDLL("../py_lib/target/debug/libpy_lib.dylib")

square_root = py_lib.get_square_root(100)
print(square_root)  # 01.2.3.4.5.6.
</code></pre>
<p>100 çš„å¹³æ–¹æ ¹æ˜¯ 10ï¼Œä½†å»è¿”å›äº† 0ã€‚é€™æ˜¯å› ç‚º ctypes åœ¨è§£æè¿”å›å€¼çš„æ™‚å€™é»˜èªæ˜¯æŒ‰ç…§æ•´å‹ä¾†è§£æçš„ï¼Œä½†ç•¶å‰çš„å‡½æ•¸è¿”å›çš„æ˜¯æµ®é»å‹ï¼Œå› æ­¤å‡½æ•¸åœ¨å‘¼å«ä¹‹å‰éœ€è¦é¡¯å¼åœ°æŒ‡å®šå…¶è¿”å›å€¼é¡å‹ã€‚</p>
<p>ä¸éåœ¨é€™ä¹‹å‰ï¼Œæˆ‘å€‘éœ€è¦å…ˆä¾†çœ‹çœ‹ Python é¡å‹å’Œ Rust é¡å‹ä¹‹é–“çš„è½‰æ›é—œä¿‚ã€‚</p>
<h2 id="æ•¸å€¼é¡å‹"><a class="header" href="#æ•¸å€¼é¡å‹">æ•¸å€¼é¡å‹</a></h2>
<p>ä½¿ç”¨ ctypes å‘¼å«å‹•æ…‹é€£çµåº«ï¼Œä¸»è¦æ˜¯å‘¼å«åº«è£¡é¢ä½¿ç”¨ Rust ç·¨å¯«å¥½çš„å‡½æ•¸ï¼Œä½†é€™äº›å‡½æ•¸æ˜¯éœ€è¦åƒæ•¸çš„ï¼Œé‚„æœ‰è¿”å›å€¼ã€‚è€Œä¸åŒèªè¨€çš„è®Šæ•¸é¡å‹ä¸åŒï¼ŒPython ä¸èƒ½ç›´æ¥å¾€ Rust ç·¨å¯«çš„å‡½æ•¸ä¸­å‚³åƒï¼Œå› æ­¤ ctypes æä¾›äº†å¤§é‡çš„é¡ï¼Œå¹«æˆ‘å€‘å°‡ Python çš„é¡å‹è½‰æˆ Rust çš„é¡å‹ã€‚</p>
<p>èˆ‡å…¶èªªè½‰æˆ Rust çš„é¡å‹ï¼Œå€’ä¸å¦‚èªªè½‰æˆ C çš„é¡å‹ï¼Œå› ç‚º Rust åŒ¯å‡ºçš„å‡½æ•¸è¦éµå¾ª C çš„å‘¼å«ç´„å®šã€‚</p>
<p>ä¸‹é¢ä¾†æ¸¬è©¦ä¸€ä¸‹ï¼Œé¦–å…ˆç·¨å¯« Rust ç¨‹å¼ç¢¼ï¼š</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">#[no_mangle]
pub extern "C" fn add_u32(a: u32) -&gt; u32 {
    a + 1
}
#[no_mangle]
pub extern "C" fn add_isize(a: isize) -&gt; isize {
    a + 1
}
#[no_mangle]
pub extern "C" fn add_f32(a: f32) -&gt; f32 {
    a + 1.
}
#[no_mangle]
pub extern "C" fn add_f64(a: f64) -&gt; f64 {
    a + 1.
}
#[no_mangle]
pub extern "C" fn reverse_bool(a: bool) -&gt; bool {
    !a
}1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.18.19.20.
</code></pre>
<p>ç·¨è­¯ä¹‹å¾Œ Python é€²è¡Œå‘¼å«ã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">from ctypes import *

py_lib = CDLL("../py_lib/target/debug/libpy_lib.dylib")

print(py_lib.add_u32(123))
"""
124
"""
print(py_lib.add_isize(666))
"""
667
"""
try:
    print(py_lib.add_f32(3.14))
except Exception as e:
    print(e)
"""
&lt;class 'TypeError'&gt;: Don't know how to convert parameter 1
"""
# æˆ‘å€‘çœ‹åˆ°å ±éŒ¯äº†ï¼Œå‘Šè¨´æˆ‘å€‘ä¸çŸ¥é“å¦‚ä½•è½‰åŒ–ç¬¬ 1 å€‹åƒæ•¸
# å› ç‚º Python çš„è³‡æ–™å’Œ C çš„è³‡æ–™ä¸ä¸€æ¨£ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥å‚³é
# ä½†æ•´æ•¸æ˜¯å€‹ä¾‹å¤–ï¼Œé™¤äº†æ•´æ•¸ï¼Œå…¶å®ƒè³‡æ–™éƒ½éœ€è¦ä½¿ç”¨ ctypes åŒ…è£ä¸€ä¸‹
# å¦å¤–æ•´æ•¸æœ€å¥½ä¹ŸåŒ…è£ä¸€ä¸‹ï¼Œå› ç‚ºä¸åŒæ•´æ•¸ä¹‹é–“ï¼Œç²¾åº¦ä¹Ÿæœ‰å€åˆ¥
print(py_lib.add_f32(c_float(3.14)))
"""
1
"""
# é›–ç„¶æ²’å ±éŒ¯ï¼Œä½†æ˜¯çµæœä¸å°ï¼Œçµæœæ‡‰è©²æ˜¯ 3.14 + 1 = 4.14ï¼Œè€Œä¸æ˜¯ 1
# å› ç‚º ctypes å‘¼å«å‡½æ•¸æ™‚é»˜èªä½¿ç”¨æ•´å‹ä¾†è§£æï¼Œä½†è©²å‡½æ•¸è¿”å›çš„ä¸æ˜¯æ•´å‹
# éœ€è¦å‘Šè¨´ ctypesï¼Œadd_f32 å‡½æ•¸è¿”å›çš„æ˜¯ c_floatï¼Œè«‹æŒ‰ç…§ c_float ä¾†è§£æ
py_lib.add_f32.restype = c_float
print(py_lib.add_f32(c_float(3.14)))
"""
4.140000343322754
"""
# f32 å’Œ f64 æ˜¯ä¸åŒçš„é¡å‹ï¼Œä½”ç”¨çš„ä½å…ƒçµ„æ•¸ä¹Ÿä¸ä¸€æ¨£
# æ‰€ä»¥ c_float å’Œ c_double ä¹‹é–“ä¸å¯æ··ç”¨ï¼Œé›–ç„¶éƒ½æ˜¯æµ®é»æ•¸
py_lib.add_f64.restype = c_double
print(py_lib.add_f64(c_double(3.14)))
"""
4.140000000000001
"""

py_lib.reverse_bool.restype = c_bool
print(py_lib.reverse_bool(c_bool(True)))
print(py_lib.reverse_bool(c_bool(False)))
"""
False
True
"""1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.18.19.20.21.22.23.24.25.26.27.28.29.30.31.32.33.34.35.36.37.38.39.40.41.42.43.44.45.46.47.48.49.50.
</code></pre>
<p>ä¸è¤‡é›œï¼Œä»¥ä¸Šæˆ‘å€‘å°±å¯¦ç¾äº†æ•¸å€¼é¡å‹çš„å‚³éã€‚</p>
<h2 id="å­—å…ƒé¡å‹"><a class="header" href="#å­—å…ƒé¡å‹">å­—å…ƒé¡å‹</a></h2>
<p>å­—å…ƒé¡å‹æœ‰å…©ç¨®ï¼Œä¸€ç¨®æ˜¯ ASCII å­—å…ƒï¼Œæœ¬è³ªä¸Šæ˜¯å€‹ u8ï¼›ä¸€ç¨®æ˜¯ Unicode å­—å…ƒï¼Œæœ¬è³ªä¸Šæ˜¯å€‹ u32ã€‚</p>
<p>ç·¨å¯« Rust ç¨‹å¼ç¢¼ï¼š</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">#[no_mangle]
pub extern "C" fn get_char(a: u8) -&gt; u8  {
    a + 1
}

#[no_mangle]
pub extern "C" fn get_unicode(a: u32) -&gt; u32  {
    let chr = char::from_u32(a).unwrap();
    if chr == 'æ†¨' {
        'æ‰¹' as u32
    } else {
        a
    }
}1.2.3.4.5.6.7.8.9.10.11.12.13.14.
</code></pre>
<p>æˆ‘å€‘çŸ¥é“ Rust å°ˆé–€æä¾›äº† 4 å€‹ä½å…ƒçµ„ char é¡å‹ä¾†è¡¨ç¤º unicode å­—å…ƒï¼Œä½†å°æ–¼å¤–éƒ¨åŒ¯å‡ºå‡½æ•¸ä¾†èªªï¼Œä½¿ç”¨ char æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨ u8 å’Œ u32 å°±è¡Œã€‚</p>
<p>ç·¨è­¯ä¹‹å¾Œï¼ŒPython å‘¼å«ï¼š</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">from ctypes import *

py_lib = CDLL("../py_lib/target/debug/libpy_lib.dylib")

# u8 é™¤äº†å¯ä»¥ä½¿ç”¨ c_byte åŒ…è£ä¹‹å¤–ï¼Œé‚„å¯ä»¥ä½¿ç”¨ c_char
# ä¸¦ä¸” c_byte è£¡é¢åªèƒ½æ¥æ”¶æ•´æ•¸ï¼Œè€Œ c_char é™¤äº†æ•´æ•¸ï¼Œé‚„å¯ä»¥æ¥æ”¶é•·åº¦ç‚º 1 çš„ä½å…ƒçµ„ä¸²
print(c_byte(97))
print(c_char(97))
print(c_char(b"a"))
"""
c_byte(97)
c_char(b'a')
c_char(b'a')
"""
# ä»¥ä¸Šä¸‰è€…æ˜¯ç­‰åƒ¹çš„ï¼Œå› ç‚º char èªªç™½äº†å°±æ˜¯å€‹ u8

# æŒ‡å®šè¿”å›å€¼ç‚º c_byteï¼Œæœƒè¿”å›ä¸€å€‹æ•´æ•¸
py_lib.get_char.restype = c_byte
# c_byte(97)ã€c_char(97)ã€c_char(b"a") éƒ½æ˜¯ç­‰åƒ¹çš„
# å› ç‚ºå®ƒå€‘æœ¬è³ªä¸Šéƒ½æ˜¯ u8ï¼Œè‡³æ–¼ 97 ä¹Ÿå¯ä»¥è§£æç‚º u8
print(py_lib.get_char(97))  # 98
# æŒ‡å®šè¿”å›å€¼ç‚º c_charï¼Œæœƒè¿”å›ä¸€å€‹å­—å…ƒï¼ˆé•·åº¦ç‚º 1 çš„ bytes å°è±¡ï¼‰
py_lib.get_char.restype = c_char
print(py_lib.get_char(97))  # b'b'


py_lib.get_unicode.restype = c_wchar
print(py_lib.get_unicode(c_wchar("å˜¿")))  # å˜¿
# ç›´æ¥å‚³ä¸€å€‹ u32 æ•´æ•¸ä¹Ÿå¯ä»¥ï¼Œå› ç‚º unicode å­—å…ƒåº•å±¤å°±æ˜¯å€‹ u32
print(py_lib.get_unicode(ord("æ†¨")))  # æ‰¹1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.18.19.20.21.22.23.24.25.26.27.28.29.30.
</code></pre>
<p>ä»¥ä¸Šå°±æ˜¯å­—å…ƒé¡å‹çš„æ“ä½œï¼Œæ¯”è¼ƒç°¡å–®ã€‚</p>
<h2 id="å­—ä¸²é¡å‹"><a class="header" href="#å­—ä¸²é¡å‹">å­—ä¸²é¡å‹</a></h2>
<p>å†ä¾†çœ‹çœ‹å­—ä¸²ï¼Œæˆ‘å€‘ç”¨ Rust å¯¦ç¾ä¸€å€‹å‡½æ•¸ï¼Œå®ƒæ¥æ”¶ä¸€å€‹å­—ä¸²ï¼Œç„¶å¾Œè¿”å›å¤§å¯«å½¢å¼ã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">use std::ffi::{CStr, CString};
use std::os::raw::c_char;

#[no_mangle]
pub extern "C" fn to_uppercase(s: *const c_char) -&gt; *mut c_char {
    // å°‡ *const c_char è½‰æˆ &amp;CStr
    let s = unsafe {
        CStr::from_ptr(s)
    };
    // å°‡ &amp;CStr è½‰æˆ &amp;str
    // ç„¶å¾Œå‘¼å« to_uppercase è½‰æˆå¤§å¯«ï¼Œå¾—åˆ° String
    let s = s.to_str().unwrap().to_uppercase();
    // å°‡ String è½‰æˆ *mut char è¿”å›
    CString::new(s).unwrap().into_raw()
}1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.
</code></pre>
<p>è§£é‡‹ä¸€ä¸‹é‡Œé¢çš„ CStr å’Œ CStringï¼Œåœ¨ Rust ä¸­ï¼ŒCString ç”¨æ–¼å»ºç«‹ C é¢¨æ ¼çš„å­—ä¸²ï¼ˆä»¥ \0 çµå°¾ï¼‰ï¼Œæ“æœ‰è‡ªå·±çš„è¨˜æ†¶é«”ã€‚é—œéµçš„æ˜¯ï¼ŒCString æ“æœ‰å€¼çš„æ‰€æœ‰æ¬Šï¼Œç•¶å¯¦ä¾‹é›¢é–‹ç¯„ç–‡æ™‚ï¼Œå®ƒçš„è§£æ§‹å‡½å¼æœƒè¢«å‘¼å«ï¼Œç›¸é—œè¨˜æ†¶é«”æœƒè¢«è‡ªå‹•é‡‹æ”¾ã€‚</p>
<p>è€Œ CStrï¼Œå®ƒå’Œ CString ä¹‹é–“çš„é—œä¿‚å°±åƒ str å’Œ String çš„é—œä¿‚ï¼Œæ‰€ä»¥ CStr ä¸€èˆ¬ä»¥å¼•ç”¨çš„å½¢å¼å‡ºç¾ã€‚ä¸¦ä¸” CStr æ²’æœ‰ new æ–¹æ³•ï¼Œä¸èƒ½ç›´æ¥å»ºç«‹ï¼Œå®ƒéœ€è¦é€šé from_ptr æ–¹æ³•å¾åŸå§‹æŒ‡é‡è½‰åŒ–å¾—åˆ°ã€‚</p>
<p>ç„¶å¾ŒæŒ‡é‡é¡å‹æ˜¯ *const å’Œ *mutï¼Œåˆ†åˆ¥è¡¨ç¤ºæŒ‡å‘ C é¢¨æ ¼å­—ä¸²çš„é¦–å­—å…ƒçš„ä¸å¯è®ŠæŒ‡é‡å’Œå¯è®ŠæŒ‡é‡ï¼Œå®ƒå€‘çš„å€åˆ¥ä¸»è¦åœ¨æ–¼æŒ‡å‘çš„è³‡æ–™æ˜¯å¦å¯ä»¥è¢«ä¿®æ”¹ã€‚å¦‚æœä¸éœ€è¦ä¿®æ”¹ï¼Œé‚£éº¼ä½¿ç”¨ *const æœƒæ›´å®‰å…¨ä¸€äº›ã€‚</p>
<p>æˆ‘å€‘ç·¨å¯« Python ç¨‹å¼ç¢¼æ¸¬è©¦ä¸€ä¸‹ã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">from ctypes import *

py_lib = CDLL("../py_lib/target/debug/libpy_lib.dylib")
s = "hello å¤æ˜åœ°è¦º".encode("utf-8")
# é»˜èªæ˜¯æŒ‰ç…§æ•´å‹è§£æçš„ï¼Œæ‰€ä»¥ä¸æŒ‡å®šè¿”å›å€¼é¡å‹çš„è©±ï¼Œæœƒå¾—åˆ°é«’è³‡æ–™
print(py_lib.to_uppercase(c_char_p(s)))
"""
31916096
"""
# æŒ‡å®šè¿”å›å€¼ç‚º c_char_pï¼Œè¡¨ç¤ºæŒ‰ç…§ char * ä¾†è§£æ
py_lib.to_uppercase.restype = c_char_p
print(
    py_lib.to_uppercase(c_char_p(s)).decode("utf-8")
)
"""
HELLO å¤æ˜åœ°è¦º
"""1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.
</code></pre>
<p>å¾è¡¨é¢ä¸Šçœ‹ä¼¼ä¹æŒºé †åˆ©çš„ï¼Œä½†èƒŒå¾Œéš±è—è‘—è¨˜æ†¶é«”æ´©éœ²çš„é¢¨éšªï¼Œå› ç‚º Rust è£¡é¢å»ºç«‹çš„ CString é‚„é§ç•™åœ¨å †å€ï¼Œå¿…é ˆè¦å°‡å®ƒé‡‹æ”¾æ‰ã€‚æ‰€ä»¥æˆ‘å€‘é‚„è¦å¯«ä¸€å€‹å‡½æ•¸ï¼Œç”¨æ–¼é‡‹æ”¾å­—ä¸²ã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">use std::ffi::{CStr, CString};
use std::os::raw::c_char;

#[no_mangle]
pub extern "C" fn to_uppercase(s: *const c_char) -&gt; *mut c_char {
    let s = unsafe {
        CStr::from_ptr(s)
    };
    let s = s.to_str().unwrap().to_uppercase();
    CString::new(s).unwrap().into_raw()
}

#[no_mangle]
pub extern "C" fn free_cstring(s: *mut c_char) {
    unsafe {
        if s.is_null() { return }
        // åŸºæ–¼åŸå§‹æŒ‡é‡å»ºç«‹ CStringï¼Œæ‹¿åˆ°å †å€å­—ä¸²çš„æ‰€æœ‰æ¬Š
        // ç„¶å¾Œé›¢é–‹ç¯„ç–‡ï¼Œè‡ªå‹•é‡‹æ”¾
        CString::from_raw(s)
    };
}1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.18.19.20.21.
</code></pre>
<p>ç„¶å¾Œä¾†çœ‹çœ‹ Python å¦‚ä½•å‘¼å«ï¼š</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">from ctypes import *

py_lib = CDLL("../py_lib/target/debug/libpy_lib.dylib")

s = "hello å¤æ˜åœ°è¦º".encode("utf-8")
# Rust è¿”å›çš„æ˜¯åŸå§‹æŒ‡é‡ï¼Œé€™è£¡å¿…é ˆè¦æ‹¿åˆ°å®ƒä¿å­˜çš„åœ°å€
# æ‰€ä»¥æŒ‡å®šè¿”å›å€¼ç‚º c_void_pï¼Œå¦‚æœæŒ‡å®šç‚º c_char_pï¼Œ
# é‚£éº¼æœƒç›´æ¥è½‰æˆ bytes å°è±¡ï¼Œé€™æ¨£åœ°å€å°±æ‹¿ä¸åˆ°äº†
py_lib.to_uppercase.restype = c_void_p
# æ‹¿åˆ°åœ°å€ï¼Œæ­¤æ™‚çš„ ptr æ˜¯ä¸€å€‹æ™®é€šçš„æ•´æ•¸ï¼Œä½†å®ƒå’ŒæŒ‡é‡ä¿å­˜çš„åœ°å€æ˜¯ä¸€æ¨£çš„
ptr = py_lib.to_uppercase(c_char_p(s))
# å°‡ ptr è½‰æˆ c_char_pï¼Œç²å– value å±¬æ€§ï¼Œå³å¯å¾—åˆ°å…·é«”çš„ bytes å°è±¡
print(cast(ptr, c_char_p).value.decode("utf-8"))
"""
HELLO å¤æ˜åœ°è¦º
"""
# å…§å®¹æˆ‘å€‘æ‹¿åˆ°äº†ï¼Œä½†å †å€çš„å­—ä¸²é‚„æ²’æœ‰é‡‹æ”¾ï¼Œæ‰€ä»¥å‘¼å« free_cstring
py_lib.free_cstring(c_void_p(ptr))1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.18.
</code></pre>
<p>é€šé CString çš„ into_rawï¼Œå¯ä»¥åŸºæ–¼ CString å»ºç«‹åŸå§‹æŒ‡é‡ *mutï¼Œç„¶å¾Œ Python å°‡æŒ‡é‡æŒ‡å‘çš„å †å€è³‡æ–™è¤‡è£½ä¸€ä»½ï¼Œå¾—åˆ° bytes å°è±¡ã€‚</p>
<p>ä½†é€™å€‹ CString ä¾èˆŠé§ç•™åœ¨å †å€ï¼Œæ‰€ä»¥ Python ä¸èƒ½å°‡è¿”å›å€¼æŒ‡å®šç‚º c_char_pï¼Œå› ç‚ºå®ƒæœƒç›´æ¥å»ºç«‹ bytes å°è±¡ï¼Œé€™æ¨£å°±æ‹¿ä¸åˆ°æŒ‡é‡äº†ã€‚å› æ­¤å°‡è¿”å›å€¼æŒ‡å®šç‚º c_void_pï¼Œå‘¼å«å‡½æ•¸æœƒå¾—åˆ°ä¸€ä¸²æ•´æ•¸ï¼Œé€™å€‹æ•´æ•¸å°±æ˜¯æŒ‡é‡ä¿å­˜çš„åœ°å€ã€‚</p>
<p>æˆ‘å€‘ä½¿ç”¨ cast å‡½æ•¸å¯ä»¥å°‡åœ°å€è½‰æˆ c_char_pï¼Œç²å–å®ƒçš„ value å±¬æ€§æ‹¿åˆ°å…·é«”çš„ä½å…ƒçµ„ä¸²ã€‚å†é€šé c_void_p å»ºç«‹åŸå§‹æŒ‡é‡äº¤çµ¦ Rustï¼Œå‘¼å« CString çš„ from_rawï¼Œå¯ä»¥åŸºæ–¼ *mut å»ºç«‹ CStringï¼Œå¾è€Œå°‡æ‰€æœ‰æ¬Šå¥ªå›ä¾†ï¼Œç„¶å¾Œé›¢é–‹ç¯„ç–‡æ™‚é‡‹æ”¾å †è¨˜æ†¶é«”ã€‚</p>
<h2 id="çµ¦å‡½æ•¸å‚³éæŒ‡é‡"><a class="header" href="#çµ¦å‡½æ•¸å‚³éæŒ‡é‡">çµ¦å‡½æ•¸å‚³éæŒ‡é‡</a></h2>
<p>å¦‚æœæ“´å±•å‡½æ•¸è£¡é¢æ¥æ”¶çš„æ˜¯æŒ‡é‡ï¼Œé‚£éº¼ Python è¦æ€éº¼å‚³éå‘¢ï¼Ÿ</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">#[no_mangle]
pub extern "C" fn add(a: *mut i32, b: *mut i32) -&gt; i32 {
    // å®šç¾©ç‚º *mutï¼Œé‚£éº¼å¯ä»¥ä¿®æ”¹æŒ‡é‡æŒ‡å‘çš„å€¼ï¼Œå®šç¾©ç‚º *constï¼Œå‰‡ä¸èƒ½ä¿®æ”¹
    if a.is_null() || b.is_null() {
        0
    } else {
        let res = unsafe {
            *a + *b
        };
        unsafe {
            // é€™è£¡å°‡ *a å’Œ *b çµ¦æ”¹æ‰
            *a = 666;
            *b = 777;
        }
        res
    }
}1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.
</code></pre>
<p>å®šç¾©äº†ä¸€å€‹ add å‡½æ•¸ï¼Œæ¥æ”¶å…©å€‹ i32 æŒ‡é‡ï¼Œè¿”å›è§£å¼•ç”¨å¾Œç›¸åŠ çš„çµæœã€‚ä½†æ˜¯åœ¨è¿”å›ä¹‹å‰ï¼Œæˆ‘å€‘å°‡ *a å’Œ *b çš„å€¼ä¹Ÿä¿®æ”¹äº†ã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">from ctypes import *

py_lib = CDLL("../py_lib/target/debug/libpy_lib.dylib")

a = c_int(22)
b = c_int(33)
# è¨ˆç®—
print(py_lib.add(pointer(a), pointer(b)))  # 55
# æˆ‘å€‘çœ‹åˆ° a å’Œ b ä¹Ÿè¢«ä¿®æ”¹äº†
print(a, a.value)  # c_int(666) 666
print(b, b.value)  # c_int(777) 7771.2.3.4.5.6.7.8.9.10.11.
</code></pre>
<p>éå¸¸ç°¡å–®ï¼Œé‚£éº¼å•é¡Œä¾†äº†ï¼Œèƒ½ä¸èƒ½è¿”å›ä¸€å€‹æŒ‡é‡å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ç•¶ç„¶å¯ä»¥ï¼Œåªä¸éå­˜åœ¨ä¸€äº›æ³¨æ„äº‹é …ã€‚</p>
<p>ç”±æ–¼ Rust æœ¬èº«çš„è¨˜æ†¶é«”å®‰å…¨åŸå‰‡ï¼Œç›´æ¥å¾å‡½æ•¸è¿”å›ä¸€å€‹æŒ‡å‘æœ¬åœ°å±€éƒ¨è®Šæ•¸çš„æŒ‡é‡æ˜¯ä¸å®‰å…¨çš„ã€‚å› ç‚ºè©²è®Šæ•¸çš„ç¯„ç–‡åƒ…é™æ–¼å‡½æ•¸æœ¬èº«ï¼Œä¸€æ—¦å‡½æ•¸è¿”å›ï¼Œè©²è®Šæ•¸çš„è¨˜æ†¶é«”å°±æœƒè¢«å›æ”¶ï¼Œå¾è€Œå‡ºç¾æ‡¸ç©ºæŒ‡é‡ã€‚</p>
<p>ç‚ºäº†é¿å…é€™ç¨®æƒ…æ³å‡ºç¾ï¼Œæˆ‘å€‘æ‡‰è©²åœ¨å †ä¸Šåˆ†é…è¨˜æ†¶é«”ï¼Œä½†é€™åˆå‡ºç¾äº†ä¹‹å‰ CString çš„å•é¡Œã€‚Python åœ¨æ‹¿åˆ°å€¼ä¹‹å¾Œï¼Œå †è¨˜æ†¶é«”ä¾èˆŠé§ç•™åœ¨å †å€ã€‚å› æ­¤ Rust å¦‚æœæƒ³è¿”å›æŒ‡é‡ï¼Œé‚£éº¼åŒæ™‚é‚„è¦å®šç¾©ä¸€å€‹é‡‹æ”¾å‡½æ•¸ã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">#[no_mangle]
pub extern "C" fn add(a: *const i32, b: *const i32) -&gt; *mut i32 {
    // è¿”å›å€¼çš„é¡å‹æ˜¯ *mut i32ï¼Œæ‰€ä»¥ res ä¸èƒ½ç›´æ¥è¿”å›ï¼Œå› æ­¤å®ƒæ˜¯ i32
    let res = unsafe {*a + *b};
    // å»ºç«‹æ™ºèƒ½æŒ‡é‡ï¼ˆå°‡ res è£ç®±ï¼‰ï¼Œç„¶å¾Œè¿”å›åŸå§‹æŒ‡é‡
    Box::into_raw(Box::new(res))
}

#[no_mangle]
pub extern "C" fn free_i32(ptr: *mut i32) {
    if !ptr.is_null() {
        // è½‰æˆ Box&lt;i32&gt;ï¼ŒåŒæ™‚æ‹¿åˆ°æ‰€æœ‰æ¬Šï¼Œåœ¨é›¢é–‹ç¯„ç–‡æ™‚é‡‹æ”¾å †è¨˜æ†¶é«”
        unsafe { let _ = Box::from_raw(ptr); }
    }
}1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.
</code></pre>
<p>ç„¶å¾Œ Python é€²è¡Œå‘¼å«ï¼š</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">from ctypes import *

py_lib = CDLL("../py_lib/target/debug/libpy_lib.dylib")

a, b = c_int(22), c_int(33)
# æŒ‡å®šé¡å‹ç‚º c_void_p
py_lib.add.restype = c_void_p
# æ‹¿åˆ°æŒ‡é‡ä¿å­˜çš„åœ°å€
ptr = py_lib.add(pointer(a), pointer(b))
# å°‡ c_void_p è½‰æˆ POINTER(c_int) é¡å‹ï¼Œä¹Ÿå°±æ˜¯ c_int *
# é€šéå®ƒçš„ contents å±¬æ€§æ‹¿åˆ°å…·é«”çš„å€¼
print(cast(ptr, POINTER(c_int)).contents)  # c_int(55)
print(cast(ptr, POINTER(c_int)).contents.value)  # 55
# é‡‹æ”¾å †è¨˜æ†¶é«”
py_lib.free_i32(c_void_p(ptr))1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.
</code></pre>
<p>é€™æ¨£æˆ‘å€‘å°±æ‹¿åˆ°äº†æŒ‡é‡ï¼Œä¸¦ä¸”ä¹Ÿä¸æœƒå‡ºç¾è¨˜æ†¶é«”æ´©éœ²ã€‚ä½†æ˜¯å–®ç¨å®šç¾©ä¸€å€‹é‡‹æ”¾å‡½æ•¸é‚„æ˜¯æœ‰äº›éº»ç…©çš„ï¼Œæ‰€ä»¥ Rust è‡ªå‹•æä¾›äº†ä¸€å€‹ free å‡½æ•¸ï¼Œå°ˆé–€ç”¨æ–¼é‡‹æ”¾å †è¨˜æ†¶é«”ã€‚èˆ‰å€‹ä¾‹å­ï¼š</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">use std::ffi::{CStr, CString};
use std::os::raw::c_char;

#[no_mangle]
pub extern "C" fn to_uppercase(s: *const c_char) -&gt; *mut c_char {
    let s = unsafe {
        CStr::from_ptr(s)
    };
    let s = s.to_str().unwrap().to_uppercase();
    CString::new(s).unwrap().into_raw()
}

#[no_mangle]
pub extern "C" fn add(a: *const i32, b: *const i32) -&gt; *mut i32 {
    let res = unsafe {*a + *b};
    Box::into_raw(Box::new(res))
}1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.
</code></pre>
<p>é€™æ˜¯å‡ºç¾éçš„å…©å€‹å‡½æ•¸ï¼Œå®ƒå€‘çš„è¨˜æ†¶é«”éƒ½ç”³è«‹åœ¨å †å€ï¼Œä½†æˆ‘å€‘å°‡è¨˜æ†¶é«”é‡‹æ”¾å‡½æ•¸åˆªæ‰äº†ï¼Œå› ç‚º Rust è‡ªå‹•æä¾›äº†ä¸€å€‹ free å‡½æ•¸ï¼Œå°ˆé–€ç”¨æ–¼å †è¨˜æ†¶é«”çš„é‡‹æ”¾ã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">from ctypes import *

py_lib = CDLL("../py_lib/target/debug/libpy_lib.dylib")

# è¿”å›å€¼é¡å‹æŒ‡å®šç‚º c_void_pï¼Œè¡¨ç¤ºè¬èƒ½æŒ‡é‡
py_lib.to_uppercase.restype = c_void_p
py_lib.add.restype = c_void_p

ptr1 = py_lib.to_uppercase(
    c_char_p("Serpen è€å¸«".encode("utf-8"))
)
ptr2 = py_lib.add(
    pointer(c_int(123)), pointer(c_int(456))
)
# å‡½æ•¸å‘¼å«å®Œç•¢ï¼Œå°‡åœ°å€è½‰æˆå…·é«”çš„é¡å‹çš„æŒ‡é‡
print(cast(ptr1, c_char_p).value.decode("utf-8"))
"""
SERPEN è€å¸«
"""
print(cast(ptr2, POINTER(c_int)).contents.value)
"""
579
"""
# é‡‹æ”¾å †è¨˜æ†¶é«”ï¼Œç›´æ¥å‘¼å« free å‡½æ•¸å³å¯ï¼Œéå¸¸æ–¹ä¾¿
py_lib.free(c_void_p(ptr1))
py_lib.free(c_void_p(ptr2))1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.18.19.20.21.22.23.24.25.26.
</code></pre>
<p>ä»¥ä¸Šæˆ‘å€‘å°±å¯¦ç¾äº†æŒ‡é‡çš„å‚³éå’Œè¿”å›ï¼Œä½†å°æ–¼æ•´æ•¸ã€æµ®é»æ•¸è€Œè¨€ï¼Œç›´æ¥è¿”å›å®ƒå€‘çš„å€¼å³å¯ï¼Œæ²’å¿…è¦è¿”å›æŒ‡é‡ã€‚</p>
<h2 id="å‚³éé™£åˆ—"><a class="header" href="#å‚³éé™£åˆ—">å‚³éé™£åˆ—</a></h2>
<p>ä¸‹é¢ä¾†çœ‹çœ‹å¦‚ä½•å‚³éé™£åˆ—ï¼Œç”±æ–¼é™£åˆ—åœ¨ä½œç‚ºåƒæ•¸å‚³éçš„æ™‚å€™æœƒé€€åŒ–ç‚ºæŒ‡é‡ï¼Œæ‰€ä»¥é™£åˆ—çš„é•·åº¦è³‡è¨Šå°±ä¸Ÿå¤±äº†ï¼Œä½¿ç”¨ sizeof è¨ˆç®—å‡ºä¾†çš„çµæœå°±æ˜¯ä¸€å€‹æŒ‡é‡çš„å¤§å°ã€‚å› æ­¤å°‡é™£åˆ—ä½œç‚ºåƒæ•¸å‚³éçš„æ™‚å€™ï¼Œæ‡‰è©²å°‡ç•¶å‰é™£åˆ—çš„é•·åº¦è³‡è¨Šä¹Ÿå‚³ééå»ï¼Œå¦å‰‡å¯èƒ½æœƒè¨ªå•éæ³•çš„è¨˜æ†¶é«”ã€‚</p>
<p>æˆ‘å€‘å¯¦ç¾ä¸€å€‹åŠŸèƒ½ï¼ŒRust æ¥æ”¶ä¸€å€‹ Python é™£åˆ—ï¼Œé€²è¡ŒåŸåœ°æ’åºã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">use std::slice;

#[no_mangle]
pub extern "C" fn sort_array(arr: *mut i32, len: usize) {
    assert!(!arr.is_null());

    unsafe {
        // å¾—åˆ°ä¸€å€‹åˆ‡ç‰‡ &amp;mut[i32]
        let slice = slice::from_raw_parts_mut(arr, len);
        slice.sort();  // æ’åº
    }
}1.2.3.4.5.6.7.8.9.10.11.12.
</code></pre>
<p>ç„¶å¾Œ Python é€²è¡Œå‘¼å«ï¼š</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">from ctypes import *

py_lib = CDLL("../py_lib/target/debug/libpy_lib.dylib")

# ä¸€å€‹åˆ—è¡¨
data = [3, 2, 1, 5, 4, 7, 6]
# ä½†æ˜¯åˆ—è¡¨ä¸èƒ½å‚³éï¼Œå¿…é ˆè¦è½‰æˆ C é™£åˆ—
# Array_Type å°±ç›¸ç•¶æ–¼ C çš„ int array[len(data)]
Array_Type = c_int * len(data)
# å»ºç«‹é™£åˆ—
array = Array_Type(*data)
print(list(array))  # [3, 2, 1, 5, 4, 7, 6]
py_lib.sort_array(array, len(array))
print(list(array))  # [1, 2, 3, 4, 5, 6, 7]1.2.3.4.5.6.7.8.9.10.11.12.13.14.
</code></pre>
<p>æ’åºå¯¦ç¾å®Œæˆï¼Œé€™è£¡çš„é™£åˆ—æ˜¯ Python å‚³éå»çš„ï¼Œä¸¦ä¸”é€²è¡Œäº†åŸåœ°ä¿®æ”¹ã€‚é‚£ Rust å¯ä¸å¯ä»¥è¿”å›é™£åˆ—çµ¦ Python å‘¢ï¼Ÿå¾ç†è«–ä¸Šä¾†èªªå¯ä»¥ï¼Œä½†å¯¦éš›ä¸å»ºè­°é€™éº¼åšï¼Œå› ç‚ºä½ ä¸çŸ¥é“è¿”å›çš„é™£åˆ—çš„é•·åº¦æ˜¯å¤šå°‘ï¼Ÿ</p>
<p>å¦‚æœä½ çœŸçš„æƒ³è¿”å›é™£åˆ—çš„è©±ï¼Œé‚£éº¼å¯ä»¥å°‡é™£åˆ—æ‹¼æ¥æˆå­—ä¸²ï¼Œç„¶å¾Œè¿”å›ã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">use std::ffi::{c_char, CString};

#[no_mangle]
pub extern "C" fn create_array() -&gt; *mut c_char {
    // ç¯©é¸å‡º 1 åˆ° 50 ä¸­ï¼Œèƒ½è¢« 3 æ•´é™¤çš„æ•¸
    // ä¸¦ä»¥é€—è™Ÿç‚ºåˆ†éš”ç¬¦ï¼Œå°‡é€™äº›æ•´æ•¸æ‹¼æ¥æˆå­—ä¸²
    let vec = (1..=50)
        .filter(|c| *c % 3 == 0)
        .map(|c| c.to_string())
        .collect::&lt;Vec&lt;String&gt;&gt;()
        .join(",");
    CString::new(vec).unwrap().into_raw()
}1.2.3.4.5.6.7.8.9.10.11.12.13.
</code></pre>
<p>ç·¨è­¯ä¹‹å¾Œäº¤çµ¦ Python å‘¼å«ã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">from ctypes import *

py_lib = CDLL("../py_lib/target/debug/libpy_lib.dylib")

# åªè¦æ˜¯éœ€è¦é‡‹æ”¾çš„å †è¨˜æ†¶é«”ï¼Œéƒ½å»ºè­°æŒ‰ç…§ c_void_p ä¾†è§£æ
py_lib.create_array.restype = c_void_p
# æ­¤æ™‚æ‹¿åˆ°çš„å°±æ˜¯æŒ‡é‡ä¿å­˜çš„åœ°å€ï¼Œåœ¨ Python è£¡é¢å°±æ˜¯ä¸€ä¸²æ•´æ•¸
ptr = py_lib.create_array()
# ç”±æ–¼æ˜¯å­—ä¸²é¦–å­—å…ƒçš„åœ°å€ï¼Œæ‰€ä»¥è½‰æˆ char *ï¼Œæ‹¿åˆ°å…·é«”å…§å®¹
print(cast(ptr, c_char_p).value.decode("utf-8"))
"""
3,6,9,12,15,18,21,24,27,30,33,36,39,42,45,48
"""
# æ­¤æ™‚æˆ‘å€‘å°±å°‡é™£åˆ—æ‹¼æ¥æˆå­—ä¸²è¿”å›äº†
# ä½†æ˜¯å †å€çš„ CString é‚„åœ¨ï¼Œæ‰€ä»¥é‚„è¦é‡‹æ”¾æ‰ï¼Œå‘¼å« free å‡½æ•¸å³å¯
# æ³¨æ„ï¼šptr åªæ˜¯ä¸€ä¸²æ•´æ•¸ï¼Œæˆ–è€…èªªå®ƒå°±æ˜¯ Python çš„ä¸€å€‹ int å°è±¡
# æ›å¥è©±èªª ptr åªæ˜¯ä¿å­˜äº†åœ°å€å€¼ï¼Œä½†å®ƒä¸å…·å‚™æŒ‡é‡çš„å«ç¾©
# å› æ­¤éœ€è¦å†ä½¿ç”¨ c_void_p åŒ…è£ä¸€ä¸‹ï¼ˆè½‰æˆæŒ‡é‡ï¼‰ï¼Œæ‰èƒ½å‚³çµ¦ free å‡½æ•¸
py_lib.free(c_void_p(ptr))1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.18.19.
</code></pre>
<p>å› æ­¤é›–ç„¶ä¸å»ºè­°è¿”å›é™£åˆ—ï¼Œä½†å°‡é™£åˆ—è½‰æˆå­—ä¸²è¿”å›ä¹Ÿä¸å¤±ç‚ºä¸€å€‹è¾¦æ³•ï¼Œç•¶ç„¶é™¤äº†é™£åˆ—ï¼Œä½ é‚„å¯ä»¥å°‡æ›´è¤‡é›œçš„çµæ§‹è½‰æˆå­—ä¸²è¿”å›ã€‚</p>
<h2 id="å‚³éçµæ§‹é«”"><a class="header" href="#å‚³éçµæ§‹é«”">å‚³éçµæ§‹é«”</a></h2>
<p>çµæ§‹é«”æ‡‰è©²æ˜¯ Rust è£¡é¢æœ€é‡è¦çš„çµæ§‹ä¹‹ä¸€äº†ï¼Œå®ƒè¦å¦‚ä½•å’Œå¤–éƒ¨äº’å‹•å‘¢ï¼Ÿ</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">use std::ffi::c_char;

#[repr(C)]
pub struct Girl {
    pub name: *mut c_char,
    pub age: u8,
}

#[no_mangle]
pub extern "C" fn create_struct(name: *mut c_char, age: u8) -&gt; Girl {
    Girl { name, age }
}1.2.3.4.5.6.7.8.9.10.11.12.
</code></pre>
<p>å› ç‚ºçµæ§‹é«”å¯¦ä¾‹è¦è¿”å›çµ¦å¤–éƒ¨ï¼Œæ‰€ä»¥å®ƒçš„æ¬„ä½é¡å‹å¿…é ˆæ˜¯ç›¸å®¹çš„ï¼Œä¸èƒ½å®šç¾© C ç†è§£ä¸äº†çš„é¡å‹ã€‚ç„¶å¾Œé‚„è¦è¨­å®š #[repr(C)] å±¬æ€§ï¼Œä¾†ä¿è­‰çµæ§‹é«”çš„è¨˜æ†¶é«”ä½ˆå±€å’Œ C æ˜¯ç›¸å®¹çš„ã€‚</p>
<p>ä¸‹é¢é€šé cargo build å‘½ä»¤ç·¨è­¯æˆå‹•æ…‹åº«ï¼ŒPython è² è²¬å‘¼å«ã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">from ctypes import *

py_lib = CDLL("../py_lib/target/debug/libpy_lib.dylib")

class Girl(Structure):

    _fields_ = [
        ("name", c_char_p),
        ("age", c_uint8),
    ]

# æŒ‡å®š create_struct çš„è¿”å›å€¼é¡å‹ç‚º Girl
py_lib.create_struct.restype = Girl
girl = py_lib.create_struct(
    c_char_p("S è€å¸«".encode("utf-8")),
    c_uint8(18)
)
print(girl.name.decode("utf-8"))  # S è€å¸«
print(girl.age)  # 181.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.18.19.
</code></pre>
<p>å‘¼å«æˆåŠŸï¼Œä¸¦ä¸”æ­¤æ™‚æ˜¯æ²’æœ‰è¨˜æ†¶é«”æ´©éœ²çš„ã€‚</p>
<p>ç•¶é€šé FFI å°‡è³‡æ–™å¾ Rust å‚³éåˆ° Python æ™‚ï¼Œå¦‚æœå‚³éçš„æ˜¯æŒ‡é‡ï¼Œé‚£éº¼æœƒæ¶‰åŠè¨˜æ†¶é«”é‡‹æ”¾çš„å•é¡Œã€‚ä½†å¦‚æœå‚³éçš„æ˜¯å€¼ï¼Œé‚£éº¼å®ƒæœƒè¤‡è£½ä¸€ä»½çµ¦ Pythonï¼Œè€ŒåŸå§‹çš„å€¼ï¼ˆé€™è£¡æ˜¯çµæ§‹é«”å¯¦ä¾‹ï¼‰æœƒè¢«è‡ªå‹•éŠ·æ¯€ï¼Œæ‰€ä»¥ç„¡éœ€æ“”å¿ƒã€‚</p>
<p>ç„¶å¾Œæ˜¯çµæ§‹é«”å…§éƒ¨çš„æ¬„ä½ï¼Œé›–ç„¶è£¡é¢çš„ name æ¬„ä½æ˜¯ *mut c_charï¼Œä½†å®ƒçš„å€¼æ˜¯ç”± Python å‚³éä¾†çš„ï¼Œè€Œä¸æ˜¯åœ¨ Rust å…§éƒ¨å»ºç«‹çš„ï¼Œå› æ­¤æ²’æœ‰å•é¡Œã€‚</p>
<p>ä½†å¦‚æœå°‡ Rust ç¨‹å¼ç¢¼æ”¹ä¸€ä¸‹ï¼š</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">use std::ffi::{c_char, CString};

#[repr(C)]
pub struct Girl {
    pub name: *mut c_char,
    pub age: u8,
}

#[no_mangle]
pub extern "C" fn create_struct() -&gt; Girl {
    let name = CString::new("S è€å¸«").unwrap().into_raw();
    let age = 18;
    Girl { name, age }
}1.2.3.4.5.6.7.8.9.10.11.12.13.14.
</code></pre>
<p>é€™æ™‚å°±å°·å°¬äº†ï¼Œæ­¤æ™‚çš„å­—ä¸²æ˜¯ Rust è£¡é¢å»ºç«‹çš„ï¼Œè½‰æˆåŸå§‹æŒ‡é‡ä¹‹å¾Œï¼ŒRust å°‡ä¸å†ç®¡ç†ç›¸æ‡‰çš„å †è¨˜æ†¶é«”ï¼ˆå› ç‚º into_raw å°‡æ‰€æœ‰æ¬Šè½‰ç§»èµ°äº†ï¼‰ï¼Œæ­¤æ™‚å°±éœ€è¦æ‰‹å‹•å †è¨˜æ†¶é«”äº†ã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">from ctypes import *

py_lib = CDLL("../py_lib/target/debug/libpy_lib.dylib")

class Girl(Structure):

    _fields_ = [
        ("name", c_char_p),
        ("age", c_uint8),
    ]

# æŒ‡å®š create_struct çš„è¿”å›å€¼é¡å‹ç‚º Girl
py_lib.create_struct.restype = Girl
girl = py_lib.create_struct()
print(girl.name.decode("utf-8"))  # S è€å¸«
print(girl.age)  # 18
# ç›´æ¥å‚³é girl å³å¯ï¼Œæœƒé‡‹æ”¾ girl è£¡é¢çš„æ¬„ä½åœ¨å †å€çš„è¨˜æ†¶é«”
py_lib.free(girl)1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.18.
</code></pre>
<p>æ­¤æ™‚å°±ä¸æœƒå‡ºç¾è¨˜æ†¶é«”æ´©éœ²äº†ï¼Œåœ¨ free çš„æ™‚å€™ï¼Œå°‡è®Šæ•¸ girl å‚³é€²å»ï¼Œé‡‹æ”¾æ‰å…§éƒ¨æ¬„ä½ä½”ç”¨çš„å †è¨˜æ†¶é«”ã€‚</p>
<p>ç•¶ç„¶ï¼ŒRust ä¹Ÿå¯ä»¥è¿”å›çµæ§‹é«”æŒ‡é‡ï¼Œé€šé Box<T> å¯¦ç¾ã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">#[no_mangle]
pub extern "C" fn create_struct() -&gt; *mut Girl {
    let name = CString::new("S è€å¸«").unwrap().into_raw();
    let age = 18;
    Box::into_raw(Box::new(Girl { name, age }))
}1.2.3.4.5.6.
</code></pre>
<p>æ³¨æ„ï¼šä¹‹å‰æ˜¯ name æ¬„ä½åœ¨å †ä¸Šï¼Œä½†çµæ§‹é«”å¯¦ä¾‹åœ¨æ£§ä¸Šï¼Œç¾åœ¨ name æ¬„ä½å’Œçµæ§‹é«”å¯¦ä¾‹éƒ½åœ¨å †ä¸Šã€‚</p>
<p>ç„¶å¾Œ Python å‘¼å«ä¹Ÿå¾ˆç°¡å–®ï¼Œé—œéµæ˜¯é‡‹æ”¾çš„å•é¡Œã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">from ctypes import *

py_lib = CDLL("../py_lib/target/debug/libpy_lib.dylib")

class Girl(Structure):

    _fields_ = [
        ("name", c_char_p),
        ("age", c_uint8),
    ]

# æ­¤æ™‚è¿”å›å€¼é¡å‹å°±è®Šæˆäº† c_void_p
# ç•¶è¿”å›æŒ‡é‡æ™‚ï¼Œå»ºè­°å°‡è¿”å›å€¼è¨­å®šç‚º c_void_p
py_lib.create_struct.restype = c_void_p
# æ‹¿åˆ°æŒ‡é‡ï¼ˆä¸€ä¸²æ•´æ•¸ï¼‰
ptr = py_lib.create_struct()
# å°‡æŒ‡é‡è½‰æˆæŒ‡å®šçš„é¡å‹ï¼Œè€Œé¡å‹é¡¯ç„¶æ˜¯ POINTER(Girl)
# å‘¼å« POINTER(T) çš„ contents æ–¹æ³•ï¼Œæ‹¿åˆ°ç›¸æ‡‰çš„çµæ§‹é«”å¯¦ä¾‹
girl = cast(ptr, POINTER(Girl)).contents
# è¨ªå•å…·é«”å…§å®¹
print(girl.name.decode("utf-8"))  # S è€å¸«
print(girl.age)  # 18

# é‡‹æ”¾å †è¨˜æ†¶é«”ï¼Œé€™è£¡çš„é‡‹æ”¾åˆ†ç‚ºå…©æ­¥ï¼Œä¸¦ä¸”é †åºä¸èƒ½éŒ¯
# å…ˆ free(girl)ï¼Œé‡‹æ”¾æ‰å…§éƒ¨æ¬„ä½ï¼ˆnameï¼‰ä½”ç”¨çš„å †è¨˜æ†¶é«”
# ç„¶å¾Œ free(c_void_p(ptr))ï¼Œé‡‹æ”¾æ‰çµæ§‹é«”å¯¦ä¾‹ girl ä½”ç”¨çš„å †è¨˜æ†¶é«”
py_lib.free(girl)
py_lib.free(c_void_p(ptr))1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.18.19.20.21.22.23.24.25.26.27.28.
</code></pre>
<p>ä¸é›£ç†è§£ï¼Œåªæ˜¯åœ¨é‡‹æ”¾çµæ§‹é«”å¯¦ä¾‹çš„æ™‚å€™éœ€è¦å¤šç•™æ„ï¼Œå¦‚æœå…§éƒ¨æœ‰æ¬„ä½ä½”ç”¨å †è¨˜æ†¶é«”ï¼Œé‚£éº¼éœ€è¦å…ˆå°‡é€™äº›æ¬„ä½é‡‹æ”¾æ‰ã€‚è€Œé‡‹æ”¾çš„æ–¹å¼æ˜¯å°‡çµæ§‹é«”å¯¦ä¾‹ä½œç‚ºåƒæ•¸å‚³çµ¦ free å‡½æ•¸ï¼Œç„¶å¾Œå†å‚³å…¥ c_void_p é‡‹æ”¾çµæ§‹é«”å¯¦ä¾‹ã€‚</p>
<h2 id="å›å‘¼å‡½æ•¸"><a class="header" href="#å›å‘¼å‡½æ•¸">å›å‘¼å‡½æ•¸</a></h2>
<p>æœ€å¾Œçœ‹ä¸€ä¸‹ Python å¦‚ä½•å‚³éå‡½æ•¸çµ¦ Rustï¼Œå› ç‚º Python å’Œ Rust ä¹‹é–“ä½¿ç”¨çš„æ˜¯ C ABIï¼Œæ‰€ä»¥å‡½æ•¸å¿…é ˆéµå¾ª C çš„æ¨™æº–ã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">// calc æ¥æ”¶ä¸‰å€‹åƒæ•¸ï¼Œå‰å…©å€‹åƒæ•¸æ˜¯ *const i32
// æœ€å¾Œä¸€å€‹åƒæ•¸æ˜¯å‡½æ•¸ï¼Œå®ƒæ¥æ”¶å…©å€‹ *const i32ï¼Œè¿”å›ä¸€å€‹ i32
#[no_mangle]
pub extern "C" fn calc(
    a: *const i32, b: *const i32,
    op: extern "C" fn(*const i32, *const i32) -&gt; i32
) -&gt; i32
{
    op(a, b)
}1.2.3.4.5.6.7.8.9.10.
</code></pre>
<p>ç„¶å¾Œçœ‹çœ‹ Python å¦‚ä½•å‚³éè¿´èª¿å‡½æ•¸ã€‚</p>
<p>è¤‡è£½</p>
<pre><code class="language-sql">from ctypes import *

py_lib = CDLL("../py_lib/target/debug/libpy_lib.dylib")

# åŸºæ–¼ Python å‡½æ•¸å»ºç«‹ C å‡½æ•¸ï¼Œé€šé @CFUNCTYPE() é€²è¡Œè£é£¾
# CFUNCTYPE ç¬¬ä¸€å€‹åƒæ•¸æ˜¯è¿”å›å€¼é¡å‹ï¼Œå‰©é¤˜çš„åƒæ•¸æ˜¯åƒæ•¸é¡å‹
@CFUNCTYPE(c_int, POINTER(c_int), POINTER(c_int))
def add(a, b):  # aã€b ç‚º int *ï¼Œé€šé .contents.value æ‹¿åˆ°å…·é«”çš„å€¼
    return a.contents.value + b.contents.value

@CFUNCTYPE(c_int, POINTER(c_int), POINTER(c_int))
def sub(a, b):
    return a.contents.value - b.contents.value

@CFUNCTYPE(c_int, POINTER(c_int), POINTER(c_int))
def mul(a, b):
    return a.contents.value * b.contents.value

@CFUNCTYPE(c_int, POINTER(c_int), POINTER(c_int))
def div(a, b):
    return a.contents.value // b.contents.value

a = pointer(c_int(10))
b = pointer(c_int(2))
print(py_lib.calc(a, b, add))  # 12
print(py_lib.calc(a, b, sub))  # 8
print(py_lib.calc(a, b, mul))  # 20
print(py_lib.calc(a, b, div))  # 51.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.18.19.20.21.22.23.24.25.26.27.28.
</code></pre>
<p>æˆåŠŸå¯¦ç¾äº†å‘ Rust å‚³éè¿´èª¿å‡½æ•¸ï¼Œç•¶ç„¶ä¾‹å­èˆ‰å¾—æœ‰é»åˆ»æ„äº†ï¼Œæ¯”å¦‚åƒæ•¸é¡å‹æŒ‡å®šç‚º i32 å³å¯ï¼Œæ²’æœ‰å¿…è¦ä½¿ç”¨æŒ‡é‡ã€‚</p>
<h2 id="å°çµ"><a class="header" href="#å°çµ">å°çµ</a></h2>
<p>ä»¥ä¸Šæˆ‘å€‘å°±ä»‹ç´¹äº† Python å¦‚ä½•å‘¼å« Rust ç·¨è­¯çš„å‹•æ…‹åº«ï¼Œå†æ¬¡å¼·èª¿ä¸€ä¸‹ï¼Œé€šé ctypes å‘¼å«å‹•æ…‹åº«æ˜¯æœ€æ–¹ä¾¿ã€æœ€ç°¡å–®çš„æ–¹å¼ã€‚å®ƒå’Œ Python çš„ç‰ˆæœ¬ç„¡é—œï¼Œä¹Ÿä¸æ¶‰åŠåº•å±¤çš„ C æ“´å±•ï¼Œå®ƒåªæ˜¯å°‡ Rust ç·¨è­¯æˆ C ABI ç›¸å®¹çš„å‹•æ…‹åº«ï¼Œç„¶å¾Œäº¤çµ¦ Python é€²è¡Œå‘¼å«ã€‚</p>
<p>å› æ­¤é€™ä¹Ÿå´é¢è¦æ±‚ï¼Œå‡½æ•¸çš„åƒæ•¸å’Œè¿”å›å€¼çš„é¡å‹æ‡‰è©²æ˜¯ C å¯ä»¥è¡¨ç¤ºçš„é¡å‹ï¼Œæ¯”å¦‚ Rust å‡½æ•¸ä¸èƒ½è¿”å›ä¸€å€‹ trait å°è±¡ã€‚ç¸½ä¹‹åœ¨å‘¼å«å‹•æ…‹åº«çš„æ™‚å€™ï¼Œåº«å‡½æ•¸å…§éƒ¨çš„é‚è¼¯å¯ä»¥å¾ˆè¤‡é›œï¼Œä½†æ˜¯åƒæ•¸å’Œè¿”å›å€¼æœ€å¥½è¦ç°¡å–®ã€‚</p>
<p>å¦‚æœä½ ç™¼ç¾ Python ç¨‹å¼ç¢¼å­˜åœ¨å¤§é‡çš„ CPU å¯†é›†å‹è¨ˆç®—ï¼Œä¸¦ä¸”ä¸æ€éº¼æ¶‰åŠè¤‡é›œçš„ Python è³‡æ–™çµæ§‹ï¼Œé‚£éº¼ä¸å¦¨å°‡é€™äº›è¨ˆç®—äº¤çµ¦ Rustã€‚</p>
<p>ä»¥ä¸Šå°±æ˜¯æœ¬æ–‡çš„å…§å®¹ï¼Œå¾ŒçºŒæœ‰ç©ºæˆ‘å€‘ä»‹ç´¹å¦‚ä½•ç”¨ Rust çš„ PyO3 ä¾†ç‚º Python ç·¨å¯«æ“´å±•ã€‚PyO3 çš„å®šä½é¡ä¼¼æ–¼ Cythonï¼Œç”¨å®ƒä¾†å¯«æ“´å±•éå¸¸çš„æ–¹ä¾¿ï¼Œå¾ŒçºŒæœ‰æ©Ÿæœƒæˆ‘å€‘è©³ç´°èŠä¸€èŠã€‚</p>
<hr />
<h1 id="pythonèˆ‡rustäº’å‹•"><a class="header" href="#pythonèˆ‡rustäº’å‹•">Pythonèˆ‡Rustäº’å‹•</a></h1>
<p><code>Rust</code> å¯ä»¥èˆ‡å¾ˆå¤šèªè¨€äº’å‹•ï¼Œå‰é¢æˆ‘å€‘å·²ç¶“ä»‹ç´¹éèˆ‡ <code>C#</code> ã€<code>JavaScript</code>ï¼Œæœ¬ç¯‡æ–‡ç« å°‡ä»‹ç´¹ä¸‹ <code>Rust</code> å¦‚ä½•èˆ‡ <code>Python</code> äº’å‹•ã€‚</p>
<h4 id="0x01-pyo3"><a class="header" href="#0x01-pyo3">0x01 PyO3</a></h4>
<p><code>PyO3</code> æ˜¯ä¸€å€‹ <code>Rust</code> çš„åº«ã€‚é€šéå®ƒï¼Œä½¿å¾—æˆ‘å€‘å¾ <code>Python</code> å‘¼å« <code>Rust</code> è®Šå¾—éå¸¸å®¹æ˜“ã€‚å®ƒå¯ä»¥ç”¨æ–¼å»ºç«‹æœ¬æ©Ÿ <code>Python</code> æ“´å±•æ¨¡çµ„çš„å·¥å…·ã€‚é‚„æ”¯æ´å¾ <code>Rust</code> äºŒé€²åˆ¶æª”æ¡ˆé‹è¡Œ <code>Python</code> ç¨‹å¼ç¢¼ä¸¦èˆ‡ä¹‹äº’å‹•ã€‚</p>
<p>å¦å¤–ï¼Œå¦‚æœè¦å°‡ <code>rust</code> ç·¨è­¯ç‚º <code>puthon</code> æ¨¡çµ„ï¼Œé‚„éœ€è¦å®‰è£ <code>maturin</code>ã€‚å®‰è£æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<pre><code>è¤‡è£½ç¨‹å¼ç¢¼pip install maturin   
</code></pre>
<p><code>PyO3</code> æ”¯æ´éœ€è¦ä»¥ä¸‹ç’°å¢ƒï¼š</p>
<p>è¨»ï¼šæœ¬æ–‡çš„æ‰€æœ‰æ“ä½œé»˜èªä½ å·²ç¶“å®‰è£ <code>Rust</code> å’Œ <code>Python</code> ç’°å¢ƒã€‚</p>
<ul>
<li>
<p>Python 3.7 åŠæ›´é«˜ç‰ˆæœ¬ï¼ˆCPython å’Œ PyPyï¼‰</p>
</li>
<li>
<p>Rust 1.48 åŠæ›´é«˜ç‰ˆæœ¬</p>
</li>
</ul>
<h4 id="0x02-python-å‘¼å«-rust-å‡½æ•¸"><a class="header" href="#0x02-python-å‘¼å«-rust-å‡½æ•¸">0x02 Python å‘¼å« Rust å‡½æ•¸</a></h4>
<h5 id="toml-çµ„æ…‹"><a class="header" href="#toml-çµ„æ…‹">toml çµ„æ…‹</a></h5>
<pre><code class="language-toml">[package]
name = "pyo3_polars_extension"
version = "0.1.0"
edition = "2021"

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[lib]
name = "python_rust"
crate-type = ["cdylib"]


[features]
extension-module = ["pyo3/extension-module"]
default = ["extension-module"]

[dependencies]
pyo3 = "0.18.3"
</code></pre>
<h5 id="ç·¨å¯«ç¨‹å¼ç¢¼"><a class="header" href="#ç·¨å¯«ç¨‹å¼ç¢¼">ç·¨å¯«ç¨‹å¼ç¢¼</a></h5>
<p>ç‚ºäº†ç°¡å–®æ¸¬è©¦ï¼Œæˆ‘å€‘ä½¿ç”¨ Rust å¯«ä¸€å€‹æ±‚å’Œçš„ç¨‹å¼ç¢¼ã€‚å¯«å‡½æ•¸æ™‚è·Ÿæˆ‘å€‘å¹³æ™‚å¯«æ²’å•¥å€åˆ¥ï¼Œä½†æ˜¯è¿”å›å€¼éœ€è¦è¿”å› <code>PyResult</code>ï¼Œä¸¦ä¸”é‚„éœ€è¦æ¨™è¨» <code>#[pyfunction]</code>ã€‚<code>#[pyfunction]</code> å±¬æ€§ç”¨æ–¼å¾ Rust å‡½æ•¸å®šç¾© Python å‡½æ•¸ã€‚å®šç¾©å¾Œï¼Œéœ€è¦ä½¿ç”¨ <code>wrap_pyfunction!</code> å®å°‡è©²å‡½æ•¸æ–°å¢åˆ°æ¨¡çµ„ä¸­ã€‚</p>
<p>æˆ‘å€‘é‚„éœ€è¦<strong>å»ºç«‹ä¸€å€‹èˆ‡ <code>toml</code> çµ„æ…‹æª”æ¡ˆä¸­ <code>lib.name</code> åŒåå‡½æ•¸</strong>ï¼ˆç•¶å‰ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>#[pyo3(name = "custom_name")]</code> è¦†è“‹æ¨¡çµ„åç¨±ï¼‰ï¼Œä¸¦æ¨™è¨»ç‚º <code>#[pymodule]</code>ã€‚<code>#[pymodule]</code> éç¨‹å®è² è²¬å°‡æ¨¡çµ„çš„åˆå§‹åŒ–å‡½æ•¸åŒ¯å‡ºåˆ° Pythonã€‚</p>
<p>å®Œæ•´çš„ç¤ºä¾‹ç¨‹å¼ç¢¼å¦‚ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>rustè¤‡è£½ç¨‹å¼ç¢¼use pyo3::prelude::*;

/// æ±‚å…©å€‹æ•¸çš„å’Œ
#[pyfunction]
fn sum(a: isize, b: isize) -&gt; PyResult&lt;isize&gt; {
    Ok(a + b)
}

/// ä¸€å€‹ç”¨Rustå¯¦ç¾çš„Pythonæ¨¡çµ„ã€‚
///
/// é€™å€‹å‡½æ•¸çš„åå­—å¿…é ˆèˆ‡`Cargo.toml`ä¸­çš„`lib.name`åŒ¹é…
#[pymodule]
fn python_rust(_py: Python, module: &amp;PyModule) -&gt; PyResult&lt;()&gt; {
    module.add_function(wrap_pyfunction!(sum, module)?)?;
    Ok(())
}
<span class="boring">}</span></code></pre></pre>
<h5 id="ç·¨è­¯ä¸¦å®‰è£"><a class="header" href="#ç·¨è­¯ä¸¦å®‰è£">ç·¨è­¯ä¸¦å®‰è£</a></h5>
<p>å®˜æ–¹æ¨è–¦ä½¿ç”¨è™›æ“¬ç’°å¢ƒå®‰è£æ¨¡çµ„ï¼Œé˜²æ­¢èˆ‡å…¶å®ƒæ¨¡çµ„è¡çªã€‚æˆ‘é€™è£¡é‚„æ˜¯å–œæ­¡ä½¿ç”¨ <code>maturin build</code> å…ˆç·¨è­¯ï¼Œç„¶å¾Œæ‰‹å‹•å®‰è£ã€‚</p>
<ul>
<li>é‹è¡Œ <code>maturin build</code> ç·¨è­¯</li>
<li>ä½¿ç”¨ <code>pip</code> å®‰è£ <code>target/wheels/æ¨¡çµ„åç¨±.whl</code></li>
</ul>
<h5 id="åœ¨-python-ä¸­ä½¿ç”¨å‡½æ•¸"><a class="header" href="#åœ¨-python-ä¸­ä½¿ç”¨å‡½æ•¸">åœ¨ python ä¸­ä½¿ç”¨å‡½æ•¸</a></h5>
<p>ç·¨å¯«æ¸¬è©¦ç¨‹å¼ç¢¼ï¼š</p>
<pre><code class="language-python">pythonè¤‡è£½ç¨‹å¼ç¢¼import python_rust

sum = python_rust.sum(5, 6)
print(sum)
</code></pre>
<p>æˆåŠŸè¼¸å‡ºçµæœ <code>11</code> ã€‚æœ‰æ²’æœ‰æ„Ÿè¦ºåˆ°å¾ˆç°¡å–®å‘¢ã€‚</p>
<h5 id="å®šç¾©å¤šå€‹å‡½æ•¸"><a class="header" href="#å®šç¾©å¤šå€‹å‡½æ•¸">å®šç¾©å¤šå€‹å‡½æ•¸</a></h5>
<p>ç•¶ç„¶äº†ï¼Œæˆ‘å€‘é‚„å¯ä»¥å®šç¾©å¤šå€‹å‡½æ•¸ï¼Œæˆ‘å€‘åªéœ€è¦åœ¨<code>æ¨¡çµ„</code>å‡½æ•¸ä¸­ <code>add_function</code> å°±å¯ä»¥äº†ã€‚ç¨‹å¼ç¢¼å¦‚ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>rustè¤‡è£½ç¨‹å¼ç¢¼use pyo3::prelude::*;

/// æ±‚å…©å€‹æ•¸çš„å’Œ
#[pyfunction]
fn sum(a: isize, b: isize) -&gt; PyResult&lt;isize&gt; {
    Ok(a + b)
}

#[pyfunction]
fn multiple(a: isize, b: isize) -&gt; PyResult&lt;isize&gt; {
    Ok(a * b)
}

/// ä¸€å€‹ç”¨Rustå¯¦ç¾çš„Pythonæ¨¡çµ„ã€‚
///
/// é€™å€‹å‡½æ•¸çš„åå­—å¿…é ˆèˆ‡`Cargo.toml`ä¸­çš„`lib.name`åŒ¹é…
#[pymodule]
fn python_rust(_py: Python, module: &amp;PyModule) -&gt; PyResult&lt;()&gt; {
    module.add_function(wrap_pyfunction!(sum, module)?)?;
    module.add_function(wrap_pyfunction!(multiple, module)?)?;
    Ok(())
}
<span class="boring">}</span></code></pre></pre>
<pre><code>.PHONY: build

build:
    maturin build --release
</code></pre>
<p>å®šç¾©æ–°å‡½æ•¸å¾Œï¼Œå†æ¬¡ä½¿ç”¨æ¨¡çµ„ï¼Œè¦è¨˜å¾—å…ˆè§£é™¤å®‰è£å†é‡æ–°å®‰è£ï¼</p>
<h4 id="0x03-å°çµ"><a class="header" href="#0x03-å°çµ">0x03 å°çµ</a></h4>
<p>æœ¬ç¯‡æ–‡ç« ç°¡å–®ä»‹ç´¹äº† Rust ä½¿ç”¨ <code>PyO3</code> ä¾†ç·¨å¯« <code>python</code> æ¨¡çµ„ï¼Œå…¶å¯¦ <code>PyO3</code> çš„åŠŸèƒ½é‚„æœ‰å¾ˆå¤šï¼Œæ¥ä¸‹ä¾†æˆ‘å€‘å°‡ç¹¼çºŒä»‹ç´¹å¦‚æœåœ¨Rustä¸­ä½¿ç”¨ä¸åŒçš„é¡å‹ã€‚</p>

                        <script src="https://utteranc.es/client.js"
                            repo="imxood/imxood.github.io"
                            issue-term="pathname"
                            theme="boxy-light"
                            crossorigin="anonymous"
                            async>
                        </script>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../rust/rust_call_c.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../rust/10-rust-an-introduction.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../rust/rust_call_c.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../rust/10-rust-an-introduction.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script type="text/javascript">
            window.playground_line_numbers = true;
        </script>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>

        <script src="../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../theme/custom/mermaid.min.js"></script>
        <script type="text/javascript" src="../theme/custom/mermaid-init.js"></script>


    </body>
</html>
